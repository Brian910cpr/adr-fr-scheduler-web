<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ADR-FR • Wallboard Calendar</title>
<style>
  :root{
    --bg:#0b0c10; --card:#121319; --muted:#8187a2; --text:#e9ecf1;
    --accent:#4da3ff; --accent2:#7bd389; --warn:#ffc857; --danger:#ff7070;
    --gap:8px; --pad:8px; --radius:10px; --shadow:0 1px 2px rgba(0,0,0,.35);
    --fs-xxs:11px; --fs-xs:12px; --fs-s:13px; --fs:14px; --fs-h:16px;
    --day-min:112px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f7fb; --card:#ffffff; --muted:#5e6c8f; --text:#1b2430;
      --accent:#2667ff; --accent2:#249b4a; --warn:#b38b00; --danger:#c04646;
      --shadow:0 1px 2px rgba(0,0,0,.1);
    }
  }
  body{margin:0;background:var(--bg);color:var(--text);font:400 var(--fs)/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:5;backdrop-filter:blur(6px);
    background:color-mix(in srgb,var(--bg) 82%,transparent);
    border-bottom:1px solid color-mix(in srgb,var(--muted) 22%,transparent)}
  .bar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .bar h1{font-size:18px;margin:0 6px 0 0}
  .sp{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--card);
    border:1px solid color-mix(in srgb,var(--muted) 25%,transparent);box-shadow:var(--shadow)}
  .pill input,.pill select{background:transparent;border:none;color:var(--text);font:inherit;outline:none}
  .btn{appearance:none;border:1px solid color-mix(in srgb,var(--muted)25%,transparent);background:var(--card);color:var(--text);
    padding:8px 10px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .legend{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:var(--fs-xxs)}
  .dot{width:20px;height:20px;border-radius:999px;border:1px solid color-mix(in srgb,var(--muted)25%,transparent);
    display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:10px;cursor:pointer;user-select:none}
  .dot.P{outline:2px solid var(--accent2)} .dot.A{outline:2px solid var(--danger)} .dot.D{outline:2px solid var(--warn)} .dot._{opacity:.55}

  main{max-width:1200px;margin:14px auto;padding:0 12px 28px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--gap)}
  .dow{font-weight:600;color:var(--muted);font-size:var(--fs-xxs);text-transform:uppercase;text-align:center;padding:6px 0}
  .day{min-height:var(--day-min);display:flex;flex-direction:column;gap:6px;background:var(--card);
    border:1px solid color-mix(in srgb,var(--muted)20%,transparent);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
  .day.other{opacity:.55}
  .date{display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:var(--fs-h)}
  .intentRow{display:flex;gap:6px}
  .allline{display:flex;gap:6px;align-items:center;font-size:var(--fs-xs)}
  .allline .tag{font-weight:700;color:var(--muted);font-size:var(--fs-xxs);padding:1px 6px;border-radius:999px;border:1px solid color-mix(in srgb,var(--muted)25%,transparent)}
  .mpill{display:inline-flex;align-items:center;gap:6px;padding:3px 6px;border-radius:8px;
    border:1px solid color-mix(in srgb,var(--muted)18%,transparent);font-size:var(--fs-xxs);background:color-mix(in srgb,var(--card) 80%,transparent)}
  .mpill.assigned{border-color:color-mix(in srgb,var(--accent2)45%,transparent)}
  .mpill .k{color:var(--muted)}
  .tr{border-radius:8px;border:1px dashed color-mix(in srgb,var(--muted)25%,transparent);padding:6px;display:flex;flex-direction:column;gap:4px}
  .tr .name{font-size:var(--fs-xxs);font-weight:700;color:var(--muted)}
  .shift{display:flex;justify-content:space-between;gap:8px;font-size:var(--fs-xxs);padding:3px 6px;border-radius:7px;
    border:1px solid color-mix(in srgb,var(--muted)15%,transparent)}
  .shift.assigned{border-color:color-mix(in srgb,var(--accent2)40%,transparent)}
  .who{font-weight:700}
  .note{margin-top:10px;color:var(--muted);font-size:var(--fs-xxs);text-align:center}

  /* density toggle */
  body.cozy{ --day-min:140px; --fs-xxs:12px; --fs-xs:13px; --fs:15px }

  /* tiny toast */
  #toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);border:1px solid color-mix(in srgb,var(--muted)30%,transparent);
    padding:8px 12px;border-radius:10px;box-shadow:var(--shadow);font-size:var(--fs-xxs);display:none;z-index:99}
  #toast.show{display:block}
</style>
</head>
<body class="dense">
<header>
  <div class="bar">
    <h1>ADR-FR Wallboard</h1>

    <div class="pill">
      <label for="monthSel" style="color:var(--muted);font-size:var(--fs-xxs);margin-right:6px">Month</label>
      <input id="monthSel" type="month">
    </div>

    <button id="prev" class="btn">◀ Prev</button>
    <button id="next" class="btn">Next ▶</button>
    <button id="density" class="btn" title="Toggle Compact / Cozy">Compact</button>

    <div class="pill">
      <span style="color:var(--muted);font-size:var(--fs-xxs)">I am</span>
      <select id="meSel"></select>
    </div>

    <div class="sp"></div>

    <div class="legend">
      <span>Intent</span>
      <span class="dot P">P</span><span>Prefer</span>
      <span class="dot A">A</span><span>Avoid</span>
      <span class="dot D">D</span><span>Decline</span>
      <span class="dot _">–</span><span>None</span>
    </div>
  </div>
</header>

<main>
  <div id="dow" class="calendar"></div>
  <div id="grid" class="calendar"></div>
  <div class="note">Click AM/PM dots to set your intent (cycles: – → P → A → D).</div>
</main>

<div id="toast"></div>

<script>
(function(){
  // ======== CONFIG: update if your API route differs =========
  const INTENT_ENDPOINT = '/api/intent'; // expects POST JSON: {member_id, date:'YYYY-MM-DD', shift:'AM'|'PM', intent:'-'|'P'|'A'|'D'}

  const qs = s => document.querySelector(s);
  const monthSel = qs('#monthSel'), grid = qs('#grid'), dow = qs('#dow'), densityBtn = qs('#density'), meSel = qs('#meSel');
  const toastEl = qs('#toast');

  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const CYCLE = ['-','P','A','D'];
  const STORAGE_ME = 'adrfr.me';

  function toast(msg, ms=1800){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

  function renderDOW(){
    dow.innerHTML = '';
    DOW.forEach(d => {
      const el = document.createElement('div');
      el.className = 'dow';
      el.textContent = d;
      dow.appendChild(el);
    });
  }
  renderDOW();

  function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function fmt(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function firstOfMonthFromStr(ym){ const [y,m] = ym.split('-').map(Number); return new Date(y, m-1, 1); }

  async function loadWallboard(ym){
    const res = await fetch(`/api/wallboard?month=${ym}`);
    if(!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
  }
  async function loadMembers(){
    const res = await fetch('/api/members');
    if(!res.ok) throw new Error(`members ${res.status}`);
    return res.json();
  }

  function buildCells(ym){
    const first = firstOfMonthFromStr(ym);
    const startDow = first.getDay();
    const start = new Date(first); start.setDate(first.getDate() - startDow);
    const days = [];
    for(let i=0;i<42;i++){ const d = new Date(start); d.setDate(start.getDate()+i); days.push(d); }
    return { month:first.getMonth(), days };
  }

  function dotClass(code){ return 'dot ' + (code==='-' ? '_' : code); }
  function nextIntent(current){
    const i = CYCLE.indexOf(current ?? '-');
    return CYCLE[(i+1) % CYCLE.length];
  }

  // Set or update an intent (UI optimistic), then POST to backend
  async function submitIntent(memberId, dateStr, shift, code, onRevert){
    try{
      const res = await fetch(INTENT_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ member_id: memberId, date: dateStr, shift, intent: code })
      });
      if(!res.ok){
        toast(`Save failed (${res.status})`);
        if(onRevert) onRevert();
        return;
      }
      const data = await res.json().catch(()=>({}));
      if(data && data.ok === false){
        toast(`Save failed: ${data.error || 'unknown'}`);
        if(onRevert) onRevert();
        return;
      }
      toast('Intent saved');
    }catch(e){
      toast('Network error saving intent');
      if(onRevert) onRevert();
    }
  }

  function render(ym, data, state){
    grid.innerHTML = '';
    const {trucks=[], truckShifts=[], ampmShifts=[], assignments={}, intents={}} = data;
    const shifts = truckShifts.length ? truckShifts : (ampmShifts.length ? ampmShifts : ['Day','Night']);

    const {month, days} = buildCells(ym);

    days.forEach(dt=>{
      const dayStr = fmt(dt);
      const other = dt.getMonth() !== month;

      const day = document.createElement('div');
      day.className = 'day' + (other ? ' other' : '');

      // Date row + intent dots (clickable)
      const top = document.createElement('div');
      top.className = 'date';
      const num = document.createElement('div'); num.textContent = dt.getDate();

      const intentsWrap = document.createElement('div'); intentsWrap.className = 'intentRow';
      if (ampmShifts && ampmShifts.length === 2){
        ['AM','PM'].forEach(which=>{
          const code = (intents?.[`${dayStr}|${which}`]) ?? '-';
          const span = document.createElement('span');
          span.className = dotClass(code);
          span.dataset.code = code;
          span.dataset.day = dayStr;
          span.dataset.shift = which;
          span.textContent = code==='-' ? '–' : code;
          span.title = `${which} intent: ${code}. Click to cycle`;

          span.addEventListener('click', ()=>{
            const me = state.me;
            if(!me){ toast('Select your name first'); return; }
            const prev = span.dataset.code;
            const next = nextIntent(prev);
            // optimistic UI
            span.dataset.code = next;
            span.className = dotClass(next);
            span.textContent = next==='-' ? '–' : next;

            // keep local in-memory intents in sync so re-render keeps it
            data.intents = data.intents || {};
            data.intents[`${dayStr}|${which}`] = next;

            submitIntent(me, dayStr, which, next, ()=>{
              // revert UI on failure
              span.dataset.code = prev;
              span.className = dotClass(prev);
              span.textContent = prev==='-' ? '–' : prev;
              data.intents[`${dayStr}|${which}`] = prev;
            });
          });

          intentsWrap.appendChild(span);
        });
      }
      top.appendChild(num); top.appendChild(intentsWrap);
      day.appendChild(top);

      // “ALL” strip (AM/PM assignments for the day)
      const allAM = assignments[`${dayStr}|ALL|AM`] || assignments[`${dayStr}|All|AM`] || assignments[`${dayStr}|all|AM`];
      const allPM = assignments[`${dayStr}|ALL|PM`] || assignments[`${dayStr}|All|PM`] || assignments[`${dayStr}|all|PM`];
      if (allAM || allPM){
        const line = document.createElement('div');
        line.className = 'allline';
        const tag = document.createElement('span'); tag.className = 'tag'; tag.textContent = 'ALL';
        line.appendChild(tag);

        const am = document.createElement('span');
        am.className = 'mpill' + ((allAM?.member_name)?' assigned':'');
        am.innerHTML = `<span class="k">AM</span> <span class="who">${allAM?.member_name ?? '—'}</span>`;
        line.appendChild(am);

        const pm = document.createElement('span');
        pm.className = 'mpill' + ((allPM?.member_name)?' assigned':'');
        pm.innerHTML = `<span class="k">PM</span> <span class="who">${allPM?.member_name ?? '—'}</span>`;
        line.appendChild(pm);

        day.appendChild(line);
      }

      // Up to 3 trucks
      trucks.slice(0,3).forEach(code=>{
        const t = document.createElement('div'); t.className = 'tr';
        const label = document.createElement('div'); label.className = 'name'; label.textContent = `Truck ${code}`; t.appendChild(label);

        shifts.slice(0,2).forEach(shift=>{
          const key = `${dayStr}|${code}|${shift}`;
          const assigned = assignments[key]?.member_name || null;
          const row = document.createElement('div'); row.className = 'shift' + (assigned ? ' assigned':'');
          row.innerHTML = `<span class="k">${shift}</span><span class="who">${assigned ?? '—'}</span>`;
          t.appendChild(row);
        });

        day.appendChild(t);
      });

      grid.appendChild(day);
    });
  }

  // controls
  function setMonthInput(d){ monthSel.value = monthKey(d); }
  function currentMonth(){ return monthSel.value || monthKey(new Date()); }
  async function redraw(state){
    const ym = currentMonth();
    const data = await loadWallboard(ym);
    render(ym, data, state);
  }

  // identity (“I am …”) handling
  async function populateMe(state){
    const payload = await loadMembers();
    const members = payload.members || payload || [];
    meSel.innerHTML = `<option value="">— select —</option>` + members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
    const saved = localStorage.getItem(STORAGE_ME);
    if(saved){ meSel.value = saved; state.me = Number(saved) || null; }
    meSel.addEventListener('change', ()=>{
      const v = meSel.value ? Number(meSel.value) : null;
      state.me = v;
      if(v){ localStorage.setItem(STORAGE_ME, String(v)); } else { localStorage.removeItem(STORAGE_ME); }
      toast(v ? 'Identity set' : 'Identity cleared');
    });
  }

  // init
  const state = { me: null };
  const init = (new URL(location.href)).searchParams.get('month') || monthKey(new Date());
  setMonthInput(firstOfMonthFromStr(init));

  Promise.resolve()
    .then(()=>populateMe(state))
    .then(()=>redraw(state))
    .catch(err => grid.innerHTML = `<div style="grid-column:1/-1;padding:12px;border:1px solid #555;border-radius:8px;background:#1f2230">Error loading: ${err.message}</div>`);

  qs('#prev').addEventListener('click', ()=>{ const d = firstOfMonthFromStr(currentMonth()); d.setMonth(d.getMonth()-1); setMonthInput(d); redraw(state).catch(console.error); });
  qs('#next').addEventListener('click', ()=>{ const d = firstOfMonthFromStr(currentMonth()); d.setMonth(d.getMonth()+1); setMonthInput(d); redraw(state).catch(console.error); });
  monthSel.addEventListener('change', ()=>redraw(state).catch(console.error));

  densityBtn.addEventListener('click', ()=>{
    const cozy = document.body.classList.toggle('cozy');
    densityBtn.textContent = cozy ? 'Cozy' : 'Compact';
  });
})();
</script>
</body>
</html>
