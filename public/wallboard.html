<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wallboard</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #0f172a;      /* slate-900-ish */
      --panel-bd: #1e293b;   /* slate-800 */
      --muted: #94a3b8;      /* slate-400 */
      --text: #e5e7eb;       /* gray-200 */
      --accent: #38bdf8;     /* sky-400 */
      --ok: #16a34a;
      --bad: #dc2626;
      --ring: #334155;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--accent); }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 8px 0; font-size: 28px; }
    .subhead { font-size: 13px; color: var(--muted); margin-bottom: 18px; }

    .card {
      background: var(--panel);
      border: 1px solid var(--panel-bd);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 18px;
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset;
    }

    /* Assignments table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th {
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      padding: 10px 8px;
      border-bottom: 1px solid var(--panel-bd);
    }
    tbody td {
      padding: 8px;
      border-bottom: 1px solid var(--panel-bd);
    }
    tbody tr:nth-child(2n) td { background: rgba(255,255,255,0.02); }
    .center { text-align: center; color: var(--muted); }

    /* Intent tiles */
    .section-title { font-weight: 600; margin-bottom: 8px; }
    .intent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .intent-tile {
      background: var(--panel);
      border: 1px solid var(--panel-bd);
      border-radius: 12px;
      padding: 10px;
      display: flex; flex-direction: column; gap: 8px;
      box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset;
    }
    .intent-date { font-size: 12px; color: var(--muted); }
    .intent-row { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    .intent-label { font-size: 12px; color: var(--muted); }
    .intent-btn {
      min-width: 34px; height: 26px;
      border-radius: 12px;
      border: 1px solid var(--ring);
      background: #0b1220;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, color .15s ease;
    }
    .intent-btn:hover { transform: translateY(-1px); }
    .intent-btn.isP { border-color: var(--ok); }
    .intent-btn.isA { border-color: var(--bad); }
    .intent-btn.isDash { border-color: var(--ring); }
    .intent-tile.disabled .intent-btn,
    .intent-btn[disabled] { opacity: .55; cursor: not-allowed; }
    .legend { font-size: 12px; color: var(--muted); margin-top: 8px; }

    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--panel-bd); border-radius: 999px; font-size: 12px; color: var(--muted); }
    .row { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .right { margin-left:auto; }
    .input { background:#0b1220; border:1px solid var(--ring); color:var(--text); border-radius:8px; padding:6px 8px; }
    .btn {
      border:1px solid var(--ring); background:#0b1220; color:var(--text);
      padding:6px 10px; border-radius:10px; cursor:pointer;
    }
    .btn:hover { transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wallboard</h1>
    <div id="meta" class="subhead">Loading…</div>

    <div class="card">
      <div class="row" style="margin-bottom:10px;">
        <div class="section-title">Truck Assignments (read-only before cutoff)</div>
        <div class="right">
          <label style="font-size:12px;color:var(--muted);">Month:</label>
          <input id="monthInput" class="input" type="month"/>
          <button id="reloadBtn" class="btn">Reload</button>
        </div>
      </div>
      <div style="overflow:auto;">
        <table id="assignTable" aria-label="Assignments">
          <thead id="assignHead"></thead>
          <tbody id="assignBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Intents (compact)</div>
      <div id="intentGrid" class="intent-grid" aria-live="polite"></div>
      <div class="legend">Click to cycle: <b>-</b> (none) → <b>P</b> (prefer) → <b>A</b> (avoid). Editable on/after cutoff.</div>
    </div>
  </div>

  <script>
    // ====== Adjust this if your API is on a different host/path =========
    const API_BASE = ''; // same origin. If needed: 'https://adr-fr-api.your-domain.workers.dev'
    // ====================================================================

    const monthParamFromUrl = new URLSearchParams(location.search).get('month');
    const todayISO = new Date().toISOString().slice(0,10);
    const defaultMonth = todayISO.slice(0,7); // YYYY-MM
    const monthState = { value: monthParamFromUrl || defaultMonth };

    // Cycle order
    const NEXT = { '-':'P', 'P':'A', 'A':'-' };

    function setBtnAppearance(btn, val) {
      btn.textContent = val;
      btn.classList.remove('isP','isA','isDash');
      btn.classList.add(val==='P' ? 'isP' : val==='A' ? 'isA' : 'isDash');
    }

    // Replace this with your real “write” call when ready.
    async function saveIntent(date, shift /* 'AM'|'PM' */, value /* '-', 'P', 'A' */) {
      // Example placeholder (no-op). Wire this to your Worker POST when available.
      // await fetch(`${API_BASE}/api/intent`, { method:'POST', headers:{'Content-Type':'application/json'},
      //   body: JSON.stringify({ date, shift, intent: value }) });
      console.log('[intent save]', { date, shift, value });
      return Promise.resolve();
    }

    async function fetchWallboard(month) {
      const res = await fetch(`${API_BASE}/api/wallboard?month=${encodeURIComponent(month)}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed wallboard fetch');
      return res.json();
    }

    function renderMeta(data) {
      const el = document.getElementById('meta');
      el.textContent = `Month ${data.month} — Today ${data.today} — Cutoff ${data.cutoff}`;
    }

    function renderAssignments(data) {
      const head = document.getElementById('assignHead');
      const body = document.getElementById('assignBody');
      head.innerHTML = ''; body.innerHTML = '';

      // Columns: Date + trucks*shifts (e.g., 120 Day, 120 Night, ...)
      const trucks = data.trucks || [];
      const tShifts = data.truckShifts || [];
      const dates = Array.from({length: data.days}, (_,i) =>
        `${data.month}-${String(i+1).padStart(2,'0')}`);

      // Build header row
      const trh = document.createElement('tr');
      const thDate = document.createElement('th'); thDate.textContent = 'Date'; trh.appendChild(thDate);
      for (const truck of trucks) {
        for (const s of tShifts) {
          const th = document.createElement('th');
          th.textContent = `${truck} ${s}`;
          trh.appendChild(th);
        }
      }
      head.appendChild(trh);

      // Rows
      for (const d of dates) {
        const tr = document.createElement('tr');
        const tdDate = document.createElement('td'); tdDate.textContent = d; tr.appendChild(tdDate);

        for (const truck of trucks) {
          for (const s of tShifts) {
            const key = `${d}|${truck}|${s}`;
            const name = data.assignments[key]?.member_name ?? '—';
            const td = document.createElement('td');
            td.className = 'center';
            td.textContent = name || '—';
            tr.appendChild(td);
          }
        }
        body.appendChild(tr);
      }
    }

    function buildIntentButton(val, disabled) {
      const b = document.createElement('button');
      b.className = 'intent-btn ' + (val==='P' ? 'isP' : val==='A' ? 'isA' : 'isDash');
      b.textContent = val;
      if (disabled) b.disabled = true;
      return b;
    }

    function renderIntents(data) {
      const grid = document.getElementById('intentGrid');
      grid.textContent = '';

      const daysInMonth = data.days;
      const yearMonth = data.month;  // 'YYYY-MM'
      const cutoff = data.cutoff;    // 'YYYY-MM-DD'
      const editable = (iso) => iso >= cutoff;    // adjust if your rule differs

      for (let i = 1; i <= daysInMonth; i++) {
        const day = String(i).padStart(2,'0');
        const iso = `${yearMonth}-${day}`;

        const amKey = `${iso}|AM`;
        const pmKey = `${iso}|PM`;

        const valAM = data.intents[amKey] ?? '-';
        const valPM = data.intents[pmKey] ?? '-';

        const tile = document.createElement('div');
        tile.className = 'intent-tile' + (editable(iso) ? '' : ' disabled');

        const hdr = document.createElement('div');
        hdr.className = 'intent-date';
        hdr.textContent = iso;

        const rowAM = document.createElement('div');
        rowAM.className = 'intent-row';
        const lblAM = document.createElement('div');
        lblAM.className = 'intent-label';
        lblAM.textContent = 'AM';
        const btnAM = buildIntentButton(valAM, !editable(iso));

        const rowPM = document.createElement('div');
        rowPM.className = 'intent-row';
        const lblPM = document.createElement('div');
        lblPM.className = 'intent-label';
        lblPM.textContent = 'PM';
        const btnPM = buildIntentButton(valPM, !editable(iso));

        if (editable(iso)) {
          btnAM.addEventListener('click', async () => {
            const next = NEXT[btnAM.textContent] || '-';
            setBtnAppearance(btnAM, next);
            try { await saveIntent(iso, 'AM', next); } catch(e){ console.error(e); }
          });
          btnPM.addEventListener('click', async () => {
            const next = NEXT[btnPM.textContent] || '-';
            setBtnAppearance(btnPM, next);
            try { await saveIntent(iso, 'PM', next); } catch(e){ console.error(e); }
          });
        }

        rowAM.append(lblAM, btnAM);
        rowPM.append(lblPM, btnPM);
        tile.append(hdr, rowAM, rowPM);
        grid.appendChild(tile);
      }
    }

    async function load(month) {
      // reflect into the month input and URL
      const monthInput = document.getElementById('monthInput');
      if (monthInput) monthInput.value = month;
      const url = new URL(location.href);
      url.searchParams.set('month', month);
      history.replaceState(null, '', url.toString());

      const data = await fetchWallboard(month);
      renderMeta(data);
      renderAssignments(data);
      renderIntents(data);
    }

    // Wire controls
    document.getElementById('reloadBtn').addEventListener('click', () => {
      const v = document.getElementById('monthInput').value || defaultMonth;
      monthState.value = v;
      load(v).catch(err => {
        console.error(err);
        alert('Failed to load wallboard data.');
      });
    });

    // Initial load
    (function init() {
      const m = monthState.value;
      const input = document.getElementById('monthInput');
      input.value = m;
      load(m).catch(err => {
        console.error(err);
        document.getElementById('meta').textContent = 'Failed to load.';
      });
    })();
  </script>
</body>
</html>
