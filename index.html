<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ADR-FR Scheduler</title>

  <!-- Existing site styles -->
  <link rel="stylesheet" href="/style.css">

  <style>
    body {
      background: linear-gradient(to bottom right, #0b1b2a, #102b45);
      color: #fff;
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
    }
    nav {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav img {
      height: 42px;
    }
    nav .links a {
      color: #fff;
      margin-left: 1.2rem;
      text-decoration: none;
      font-weight: 500;
    }
    nav .links a:hover {
      text-decoration: underline;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
    }

    .shift-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 0.8rem 1rem;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
      transition: 0.25s;
    }

    .shift-card.green { background: rgba(0, 255, 0, 0.18); }
    .shift-card.yellow { background: rgba(255, 255, 0, 0.18); }
    .shift-card.red { background: rgba(255, 0, 0, 0.18); }

    .shift-card h3 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.5px;
      color: #aad6ff;
    }

    .half-row {
      display: flex;
      justify-content: space-between;
      margin-top: 0.4rem;
    }

    .half-row button {
      flex: 1;
      margin: 0 0.2rem;
      padding: 0.4rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
    }

    .half-row button.green { background: #16a34a; }
    .half-row button.yellow { background: #eab308; }
    .half-row button.blank { background: #374151; }
    .half-row button.red { background: #dc2626; }

    .note-line {
      margin-top: 0.4rem;
      width: 100%;
    }
    .note-line input {
      width: 100%;
      border-radius: 5px;
      border: 1px solid #333;
      background: rgba(255,255,255,0.08);
      color: #fff;
      padding: 4px 6px;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      color: #aaa;
      padding: 1rem;
      font-size: 0.8rem;
    }

    .blurb {
      font-size: 0.85rem;
      color: #ccc;
      margin-top: 0.3rem;
    }

  </style>
</head>

<body>
  <nav>
    <img src="/images/adr-logo.png" alt="ADR-FR Logo">
    <div class="links">
      <a href="/">Home</a>
      <a href="/join">Join</a>
      <a href="/schedule">Schedule</a>
      <a href="/resources">Resources</a>
    </div>
  </nav>

  <main>
    <h2 style="text-align:center;margin-top:1rem;">Active Scheduling Window</h2>
    <div class="calendar" id="calendar"></div>
  </main>

  <footer>ADR-FR Scheduler â€¢ connected to Cloudflare Worker API</footer>

  <script>
    const API_BASE = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
    const USER_ID = "uq2w4or"; // for now (replace with authenticated user id)
    let lastUpdate = 0;
    let timer = null;

    async function loadWindow(start, end) {
      const res = await fetch(`${API_BASE}/api/state?start=${start}&end=${end}`);
      return res.json();
    }

    async function setAvailability(userId, date, half, nextState) {
      const body = JSON.stringify({ userId, date, half, state: nextState });
      await fetch(`${API_BASE}/api/availability`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body
      });
      // debounce refresh
      clearTimeout(timer);
      timer = setTimeout(renderCalendar, 3000);
    }

    async function setNote(userId, date, half, note) {
      const body = JSON.stringify({ userId, date, half, state: "available", note });
      await fetch(`${API_BASE}/api/availability`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body
      });
      clearTimeout(timer);
      timer = setTimeout(renderCalendar, 3000);
    }

    const STATES = ["prefer", "available", "unset", "no"];
    const COLORS = { prefer: "green", available: "yellow", unset: "blank", no: "red" };

    function nextState(current) {
      const i = STATES.indexOf(current);
      return STATES[(i + 1) % STATES.length];
    }

    async function renderCalendar() {
      const today = new Date();
      const start = today.toISOString().split("T")[0];
      const end = new Date(today.getTime() + 6 * 86400000).toISOString().split("T")[0];
      const data = await loadWindow(start, end);

      const cal = document.getElementById("calendar");
      cal.innerHTML = "";

      for (const [date, halves] of Object.entries(data.scores)) {
        const card = document.createElement("div");
        card.className = `shift-card ${halves.AM.color}`;
        const header = document.createElement("h3");
        header.textContent = date;
        card.appendChild(header);

        for (const half of ["AM", "PM"]) {
          const row = document.createElement("div");
          row.className = "half-row";

          const state = data.availability?.[USER_ID]?.[date]?.[half]?.state || "unset";
          const btn = document.createElement("button");
          btn.textContent = half;
          btn.className = COLORS[state];
          btn.addEventListener("click", () => {
            const ns = nextState(state);
            btn.className = COLORS[ns];
            setAvailability(USER_ID, date, half, ns);
          });

          row.appendChild(btn);
          card.appendChild(row);

          const blurb = document.createElement("div");
          blurb.className = "blurb";
          blurb.textContent = halves[half].blurb;
          card.appendChild(blurb);

          // note line
          const noteDiv = document.createElement("div");
          noteDiv.className = "note-line";
          const input = document.createElement("input");
          input.placeholder = "In at 10am";
          input.value = data.availability?.[USER_ID]?.[date]?.[half]?.note || "";
          input.addEventListener("blur", () => {
            if (input.value.trim() !== "") {
              setNote(USER_ID, date, half, input.value.trim());
            }
          });
          noteDiv.appendChild(input);
          card.appendChild(noteDiv);
        }

        cal.appendChild(card);
      }
    }

    renderCalendar();
  </script>
</body>
</html>
