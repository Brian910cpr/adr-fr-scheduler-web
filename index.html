<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ShiftCommander — Member</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Apple-ish, touch-friendly styling -->
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2b;
      --card:#0f1729;
      --text:#e6edf6;
      --muted:#9fb0c7;
      --line:#1f2a44;

      --green:#22c55e;
      --green-bg: rgba(34,197,94,.15);
      --yellow:#f59e0b;
      --yellow-bg: rgba(245,158,11,.15);
      --red:#ef4444;
      --red-bg: rgba(239,68,68,.15);

      --pill-bg: rgba(255,163,0,.12);
      --pill-stroke: rgba(255,163,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0a1020,#0c1528 40%,#0a1325);
      color:var(--text);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased; line-height:1.4;
    }
    header{
      position:sticky;top:0;z-index:5;
      backdrop-filter:saturate(180%) blur(10px);
      -webkit-backdrop-filter:saturate(180%) blur(10px);
      background:rgba(8,12,24,.6); border-bottom:1px solid var(--line);
    }
    .bar{
      max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted)}
    select,button,input[type="date"]{
      background:var(--card); color:var(--text); border:1px solid var(--line);
      border-radius:12px; padding:8px 10px; font-size:14px; outline:none;
    }
    button.nav{padding:8px 10px}
    .legend{display:flex;gap:14px;align-items:center;font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%;}
    .d-green{background:var(--green)}
    .d-yellow{background:var(--yellow)}
    .d-red{background:var(--red)}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
    .cal{
      display:grid;gap:10px;
      grid-template-columns:repeat(7,minmax(120px,1fr));
    }
    .weekday{color:var(--muted);text-align:center;font-size:12px}
    .monthHead{
      display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px 0;
    }
    .monthTitle{font-weight:700;font-size:18px}
    .day{
      background:var(--panel);border:1px solid var(--line);border-radius:16px;min-height:120px;padding:8px;position:relative;
      display:flex;flex-direction:column;gap:8px;
    }
    .dateNum{color:var(--muted);font-size:12px}
    .half{
      background:var(--card); border:1px solid var(--line); border-radius:12px; padding:6px 8px;
      display:flex;align-items:center;justify-content:space-between; gap:10px;
    }
    .toggle{
      display:inline-flex;gap:6px;
    }
    .chip{
      border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; user-select:none; cursor:pointer;
      transition:transform .05s ease;
    }
    .chip:active{transform:scale(.98)}
    .chip.prefer{background:var(--green-bg); border-color:rgba(34,197,94,.45); color:var(--green)}
    .chip.available{background:var(--yellow-bg); border-color:rgba(245,158,11,.45); color:var(--yellow)}
    .chip.unset{opacity:.7}
    .chip.no{background:var(--red-bg); border-color:rgba(239,68,68,.45); color:var(--red)}

    .tip-badge{
      display:inline-block; margin-top:6px; padding:2px 8px;
      border-radius:9999px; font-size:11px; line-height:18px;
      background:var(--pill-bg); color:#b26a00; border:1px solid var(--pill-stroke);
      backdrop-filter:saturate(180%) blur(6px); -webkit-backdrop-filter:saturate(180%) blur(6px);
      align-self:flex-start;
    }

    .note{
      width:100%; margin-top:4px; font-size:12px; color:var(--text);
      background:transparent; border:1px dashed var(--line); border-radius:10px; padding:6px 8px;
    }
    .note::placeholder{color:#7786a3}
    .status{margin-top:10px;color:var(--muted);font-size:12px}
    @media (max-width:980px){
      .cal{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand">ShiftCommander <span class="muted">Member</span></div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label class="muted" for="memberSel">Logged in as:</label>
      <select id="memberSel"></select>

      <button class="nav" id="prevBtn">◀ Prev</button>
      <label class="muted">Months</label>
      <select id="monthsSel">
        <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
      </select>
      <button class="nav" id="nextBtn">Next ▶</button>

      <div class="legend">
        <div class="dot d-green"></div><span class="muted">Prefer</span>
        <div class="dot d-yellow"></div><span class="muted">Available</span>
        <div class="dot d-red"></div><span class="muted">Do Not</span>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="months"></div>
  <div class="status" id="status">AM/PM toggles auto-commit after ~3s.</div>
</div>

<script>
  // ---------- Config ----------
  const API_BASE = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
  const today = new Date();
  let viewAnchor = new Date(today.getFullYear(), today.getMonth(), 1);
  let viewMonths = 2;
  let currentUserId = null;

  // pending changes (debounced flush)
  const pending = new Map(); // key `${date}_${half}` -> state
  let flushTimer = null;

  // ---------- Utilities ----------
  function fmtDate(d){ return d.toISOString().slice(0,10); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function addMonths(d, n){ const x = new Date(d); x.setMonth(x.getMonth()+n); return x; }
  function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); } // last day
  function yyyyMmDdRange(start, end){
    const out=[]; for(let dt=new Date(start); dt<=end; dt=addDays(dt,1)) out.push(fmtDate(dt)); return out;
  }
  function cycleState(cur){
    // Order: prefer -> available -> unset -> no -> prefer
    if (cur==="prefer") return "available";
    if (cur==="available") return "unset";
    if (cur==="no") return "prefer";
    return "no"; // unset -> no
  }

  // ---------- Data ----------
  async function fetchUsers(){
    const r = await fetch(`${API_BASE}/api/users`);
    return await r.json();
  }
  async function fetchState(startStr, endStr){
    const qs = new URLSearchParams({ start: startStr, end: endStr }).toString();
    const r = await fetch(`${API_BASE}/api/state?${qs}`);
    return await r.json();
  }
  async function postAvailability(userId, date, half, state){
    await fetch(`${API_BASE}/api/availability`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ userId, date, half, state })
    });
  }

  // ---------- Render ----------
  async function render(){
    const anchor = firstOfMonth(viewAnchor);
    const end = endOfMonth(addMonths(anchor, viewMonths-1));
    const startStr = fmtDate(anchor);
    const endStr = fmtDate(end);

    // data
    const state = await fetchState(startStr, endStr);

    // months container
    const monthsEl = document.getElementById('months');
    monthsEl.innerHTML = "";

    // build month(s)
    for(let m=0;m<viewMonths;m++){
      const base = firstOfMonth(addMonths(anchor, m));
      const monthEnd = endOfMonth(base);
      const days = yyyyMmDdRange(base, monthEnd);

      const monthWrap = document.createElement('section');
      monthWrap.className = "month";
      monthWrap.innerHTML = `
        <div class="monthHead">
          <div class="monthTitle">${base.toLocaleString(undefined,{month:"long", year:"numeric"})}</div>
        </div>
        <div class="cal">
          ${["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(d=>`<div class="weekday">${d}</div>`).join("")}
        </div>
      `;
      const grid = monthWrap.querySelector('.cal');

      // Pad to Monday-start grid
      const pad = (base.getDay()+6)%7; // Monday=0
      for(let i=0;i<pad;i++){
        const p = document.createElement('div'); p.className="weekday"; p.innerHTML=""; grid.appendChild(p);
      }

      days.forEach(date=>{
        const day = document.createElement('div');
        day.className = "day";
        const amState = state.availability?.[currentUserId]?.[date]?.AM ?? "unset";
        const pmState = state.availability?.[currentUserId]?.[date]?.PM ?? "unset";
        const tip = state.shifts?.[date]?.AM?.tip || state.shifts?.[date]?.PM?.tip || "";

        day.innerHTML = `
          <div class="dateNum">${new Date(date).getDate()}</div>
          <div class="half" data-date="${date}" data-half="AM">
            <div class="muted">AM</div>
            <div class="toggle">
              <span class="chip ${amState}" data-date="${date}" data-half="AM" data-state="${amState}">AM</span>
            </div>
          </div>
          <div class="half" data-date="${date}" data-half="PM">
            <div class="muted">PM</div>
            <div class="toggle">
              <span class="chip ${pmState}" data-date="${date}" data-half="PM" data-state="${pmState}">PM</span>
            </div>
          </div>
          ${tip ? `<span class="tip-badge">${tip}</span>` : ``}
          <input class="note" data-date="${date}" placeholder="In at 10am" />
        `;
        grid.appendChild(day);
      });

      monthsEl.appendChild(monthWrap);
    }

    // attach listeners for chips
    monthsEl.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        if(!currentUserId) return;
        const date = chip.getAttribute('data-date');
        const half = chip.getAttribute('data-half');
        const cur  = chip.getAttribute('data-state') || "unset";
        const next = cycleState(cur);

        chip.setAttribute('data-state', next);
        chip.classList.remove('prefer','available','unset','no'); chip.classList.add(next);

        // queue change
        pending.set(`${date}_${half}`, { date, half, state: next });
        scheduleFlush();
      });
    });

    // (Optional) notes capture to your own endpoint when you’re ready.
    document.querySelectorAll('.note').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        // TODO: POST /api/note { userId, date, text: inp.value }
        // For now we only keep it local
      });
    });
  }

  function scheduleFlush(){
    const status = document.getElementById('status');
    status.textContent = "Pending changes… saving shortly.";
    if (flushTimer) clearTimeout(flushTimer);
    flushTimer = setTimeout(async ()=>{
      if (!currentUserId || pending.size===0) { status.textContent = "All changes saved."; return; }
      const ops = Array.from(pending.values());
      pending.clear();
      // send sequentially (simple); replace with Promise.all if you want
      for (const op of ops) {
        await postAvailability(currentUserId, op.date, op.half, op.state);
      }
      status.textContent = "All changes saved.";
      // refresh tips (and any color that depends on server logic)
      render();
    }, 3000);
  }

  // ---------- Boot ----------
  (async function boot(){
    // populate member dropdown
    const users = await fetchUsers();
    const sel = document.getElementById('memberSel');
    sel.innerHTML = users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("");
    currentUserId = users[0]?.id || null;
    sel.value = currentUserId;
    sel.addEventListener('change', ()=>{ currentUserId = sel.value; render(); });

    // month controls
    document.getElementById('monthsSel').addEventListener('change', e=>{
      viewMonths = parseInt(e.target.value,10) || 2; render();
    });
    document.getElementById('prevBtn').addEventListener('click', ()=>{ viewAnchor = addMonths(viewAnchor, -1); render(); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ viewAnchor = addMonths(viewAnchor, +1); render(); });

    await render();
  })();
</script>

<!-- shared “tip” painter is inlined here so this file is self-contained -->
<script>
(function () {
  const TIP_CLASS = "tip-badge"; // class already styled above
  window.paintTips = function paintTips(state){
    if (!state || !state.shifts) return;
    document.querySelectorAll('[data-date][data-half]').forEach(node=>{
      const d = node.getAttribute('data-date');
      const h = node.getAttribute('data-half');
      const tip = state.shifts?.[d]?.[h]?.tip || "";
      node.parentElement.querySelectorAll('.'+TIP_CLASS).forEach(n=>n.remove());
      if (!tip) return;
      const pill = document.createElement('span'); pill.className = TIP_CLASS; pill.textContent = tip;
      node.parentElement.appendChild(pill);
    });
  };
})();
</script>

</body>
</html>
