<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiftCommander â€” Beta</title>

    <!-- Point the UI at your Cloudflare Worker API -->
    <script>
      window.__API_BASE__ = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';
    </script>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD + Babel so JSX works without a build step -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <!-- Our app code in JSX; Babel transpiles it in the browser -->
    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const API_BASE = (typeof window !== 'undefined' && window.__API_BASE__) || "";

      const todayISO = () => new Date().toISOString().slice(0,10);
      const addDays = (date, n) => { const d=new Date(date); d.setDate(d.getDate()+n); return d; };
      const toISODate = (d) => d.toISOString().slice(0,10);
      const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
      const rangeDays = (start, end) => { const out=[]; let d=new Date(start); while(d<=end){ out.push(new Date(d)); d.setDate(d.getDate()+1);} return out; };

      const AV = ["unset","prefer","available","no"];
      const AV_COL = { unset:"", prefer:"bg-green-200 ring-2 ring-green-500", available:"bg-yellow-200 ring-2 ring-yellow-500", no:"bg-red-200 ring-2 ring-red-500" };
      const cycle = (s)=> AV[(AV.indexOf(s??"unset")+1)%AV.length];

      // --- minimal member login (by member #) ---
      function useMember() {
        const [memberNo, setMemberNo] = useState(localStorage.getItem("__memberNo") || "");
        const [user, setUser] = useState(null);

        async function login(no) {
          try {
            const r = await fetch(API_BASE + "/api/login", {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ memberNo:no })
            });
            if (!r.ok) throw new Error("Invalid member #");
            const j = await r.json();
            localStorage.setItem("__memberNo", no);
            setMemberNo(no);
            setUser(j.user);
          } catch (e) {
            alert("Login failed. Make sure member_no exists in the users table.");
          }
        }
        function logout(){ localStorage.removeItem("__memberNo"); setMemberNo(""); setUser(null); }

        useEffect(()=>{ if(memberNo) login(memberNo).catch(()=> logout()); },[]);
        return { memberNo, user, login, logout };
      }

      // --- backend data store ---
      function useStore(memberNo){
        const [users, setUsers] = useState([]);
        const [availability, setAvailability] = useState({});
        const [prefs, setPrefs] = useState({});
        const [shifts, setShifts] = useState({});
        const [connected, setConnected] = useState(false);
        const wsRef = useRef(null);

        async function fetchUsers(){ const r = await fetch(API_BASE + "/api/users"); setUsers(await r.json()); }
        async function fetchWindow(start, end){
          const r = await fetch(API_BASE + "/api/state?start="+start+"&end="+end);
          const j = await r.json();
          setShifts(j.shifts||{}); setAvailability(j.availability||{}); setPrefs(j.prefs||{});
        }
        function openSocket(){
          try{
            const u = new URL(API_BASE);
            u.protocol = (u.protocol==="https:")?"wss:":"ws:"; u.pathname="/ws"; u.search=""; u.hash="";
            const ws = new WebSocket(u.toString()); wsRef.current = ws;
            ws.addEventListener("open", ()=> setConnected(true));
            ws.addEventListener("close", ()=> setConnected(false));
            ws.addEventListener("message", ()=>{
              const start = toISODate(new Date()); const end = toISODate(addDays(new Date(), 60));
              fetchWindow(start,end); fetchUsers();
            });
          }catch{}
        }

        // optimistic UI + 3s auto-commit
        const pending = useRef(new Map());
        async function setAvailabilityCell(userId, date, half, state){
          setAvailability(prev => {
            const p = { ...(prev[userId]||{}) };
            const v = { AM:"unset", PM:"unset", ...(p[date]||{}) }; v[half]=state; p[date]=v;
            return { ...prev, [userId]: p };
          });
          const key = userId+"|"+date+"|"+half;
          if (pending.current.get(key)) clearTimeout(pending.current.get(key));
          pending.current.set(key, setTimeout(async ()=>{
            await fetch(API_BASE + "/api/availability", {
              method:"POST",
              headers:{ "Content-Type":"application/json", "x-member": memberNo||"" },
              body: JSON.stringify({ userId, date, half, state })
            });
            pending.current.delete(key);
          }, 3000));
        }

        async function savePrefs(userId, patch){
          await fetch(API_BASE + "/api/prefs", {
            method:"POST", headers:{ "Content-Type":"application/json", "x-member": memberNo||"" },
            body: JSON.stringify({ userId, ...patch })
          });
        }

        useEffect(()=>{
          fetchUsers();
          const start = toISODate(new Date()); const end = toISODate(addDays(new Date(), 60));
          fetchWindow(start, end);
          openSocket();
          return ()=> wsRef.current?.close();
        },[]);

        return { users, availability, prefs, shifts, connected, actions:{ setAvailabilityCell, savePrefs, fetchUsers, fetchWindow } };
      }

      // --- UI components ---
      function Month({ year, month, renderCell, headerRight }){
        const first = new Date(year, month, 1);
        const last = endOfMonth(first);
        const days = rangeDays(first, last);
        const startPad = (first.getDay()+6)%7; // Monday first
        const total = Math.ceil((startPad + days.length)/7)*7;
        const cells = Array.from({length:total}, (_,i)=>{ const idx=i-startPad; return (idx>=0 && idx<days.length)? days[idx]: null; });

        return (
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-lg font-semibold">{first.toLocaleString(undefined,{month:"long",year:"numeric"})}</h3>
              {headerRight}
            </div>
            <div className="grid grid-cols-7 gap-2 text-xs font-semibold text-gray-500">
              {["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(d=> <div key={d} className="text-center">{d}</div>)}
            </div>
            <div className="grid grid-cols-7 gap-2 mt-2">
              {cells.map((d,i)=> (
                <div key={i} className={"min-h-[86px] border rounded-xl p-1 "+(d?"bg-gray-50":"bg-transparent border-none")}>
                  {d && (
                    <div className="flex flex-col gap-1 h-full">
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-medium">{d.getDate()}</span>
                        <span className={"w-2 h-2 rounded-full "+(toISODate(d)===todayISO()?"bg-blue-500":"bg-transparent")} />
                      </div>
                      <div className="flex-1">{renderCell(d)}</div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      }

      const AvBtn = ({ value, onChange, label }) => (
        <button className={"w-10 h-8 rounded text-xs font-medium border border-gray-300 "+(AV_COL[value||"unset"])}
                onClick={()=> onChange(cycle(value))}
                title={`${label}: ${value||"unset"}`}>
          {label}
        </button>
      );

function UserView({ store, member }){
  const { users, availability, prefs, actions } = store;
  const [monthsAhead, setMonthsAhead] = useState(2);
  const [offset, setOffset] = useState(0);

  const me = useMemo(()=>{
    if (!users.length) return null;
    if (!member.user) return users[0];
    return users.find(u=> u.id === member.user.id) || users[0];
  },[users, member.user]);

  const start = useMemo(()=> new Date(new Date().getFullYear(), new Date().getMonth()+offset, 1), [offset]);
  const months = useMemo(()=> Array.from({length: monthsAhead}, (_,i)=>{
    const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
    return { year:d.getFullYear(), month:d.getMonth() };
  }), [monthsAhead, start]);

  const av = me ? (availability[me.id] || {}) : {};
  const myPrefs = me ? (prefs[me.id] || { prefer24s:false, notes:"" }) : { prefer24s:false, notes:"" };
  const parsedNotes = (()=>{ try{ return JSON.parse(myPrefs.notes||"{}"); }catch{ return {}; }})();
  const avoid = new Set(parsedNotes.avoid || []);
  const typeIII = !!parsedNotes.typeIII;
  const inactive = !!parsedNotes.inactive;

  const preCommit = (d)=> ((d - new Date())/(1000*60*60*24)) > 28;

  // ---- optimistic prefs helpers ----
  function patchPrefsLocally(patch){
    // update local prefs so UI reflects immediately
    const nextPrefs = { ...myPrefs, ...patch };
    prefs[me.id] = nextPrefs; // mutate the cache we already read from
  }
  async function setPrefer24s(on){
    if (!me) return;
    patchPrefsLocally({ prefer24s: !!on });
    await actions.savePrefs(me.id, { prefer24s: !!on });
  }
  async function setTypeIII(on){
    if (!me) return;
    const notes = JSON.stringify({ ...parsedNotes, typeIII: !!on });
    patchPrefsLocally({ notes });
    await actions.savePrefs(me.id, { notes });
  }
  async function setAvoid(uid, on){
    if (!me) return;
    const arr = Array.from(avoid);
    const next = on ? Array.from(new Set(arr.concat(uid))) : arr.filter(x=> x!==uid);
    const notes = JSON.stringify({ ...parsedNotes, avoid: next });
    patchPrefsLocally({ notes });
    await actions.savePrefs(me.id, { notes });
  }
  async function setInactive(on){
    if (!me) return;
    const notes = JSON.stringify({ ...parsedNotes, inactive: !!on });
    patchPrefsLocally({ notes });
    await actions.savePrefs(me.id, { notes });
  }

  // ---- default future setter ----
  async function setDefaultFuture(state){
    if (!me) return;
    const confirmMsg = state==="no"
      ? "Set ALL future AM/PM to Do Not?"
      : "Set ALL future AM/PM to Available?";
    if (!confirm(confirmMsg)) return;

    const today = new Date();
    for (let i=0;i<180;i++){ // ~6 months
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
      const k = toISODate(d);
      await actions.setAvailabilityCell(me.id, k, "AM", state);
      await actions.setAvailabilityCell(me.id, k, "PM", state);
    }
    alert("Default applied to future days.");
  }

  if (!me) return <div className="text-sm text-gray-500">Loadingâ€¦</div>;

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-3">
        <div className="text-sm">Logged in as: <span className="font-semibold">{member.user?.name || me.name}</span></div>
        <div className="ml-auto flex items-center gap-2 text-xs">
          <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-green-300 rounded"></span>Prefer</span>
          <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-yellow-300 rounded"></span>Available</span>
          <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-red-300 rounded"></span>Do Not</span>
        </div>
      </div>

      <div className="flex items-center gap-2">
        <button className="px-3 py-1 rounded bg-white border" onClick={()=> setOffset(o=> o-1)}>â—€ Prev</button>
        <label className="text-sm">Months shown</label>
        <input type="number" min="1" max="6" className="w-16 border rounded px-2 py-1" value={monthsAhead} onChange={e=> setMonthsAhead(Number(e.target.value||1))} />
        <button className="px-3 py-1 rounded bg-white border" onClick={()=> setOffset(o=> o+1)}>Next â–¶</button>

        <div className="ml-auto flex items-center gap-2">
          <button className="px-3 py-1 rounded bg-red-100 border border-red-300 text-red-700" onClick={()=> setDefaultFuture("no")}>Default future: Do Not</button>
          <button className="px-3 py-1 rounded bg-yellow-100 border border-yellow-300 text-yellow-800" onClick={()=> setDefaultFuture("available")}>Default future: Available</button>
        </div>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
        {months.map(({year, month})=> (
          <Month key={year+'-'+month} year={year} month={month}
            renderCell={(d)=>{
              const k = toISODate(d);
              const v = av[k] || { AM:"unset", PM:"unset" };
              const pc = preCommit(d);

              // if inactive, hard-force Do Not look/behavior
              const disable = inactive;
              const showAM = disable ? "no" : v.AM;
              const showPM = disable ? "no" : v.PM;

              return (
                <div className="flex items-center justify-between gap-2 opacity-100">
                  <div className="flex items-center gap-2">
                    <AvBtn label="AM" value={showAM} onChange={(s)=> !disable && actions.setAvailabilityCell(me.id, k, "AM", s)} />
                    <AvBtn label="PM" value={showPM} onChange={(s)=> !disable && actions.setAvailabilityCell(me.id, k, "PM", s)} />
                  </div>
                  {pc && <span className="text-[10px] uppercase px-2 py-1 rounded-full bg-purple-100 border border-purple-300">Pre-commit</span>}
                </div>
              );
            }}
          />
        ))}
      </div>

      <details className="rounded-2xl bg-white p-4 shadow">
        <summary className="cursor-pointer font-semibold">Preferences</summary>
        <div className="mt-3 grid gap-3">
          <label className="inline-flex items-center gap-2">
            <input type="checkbox" checked={!!myPrefs.prefer24s} onChange={e=> setPrefer24s(e.target.checked)} />
            Prefer 24s
          </label>
          <label className="inline-flex items-center gap-2">
            <input type="checkbox" checked={typeIII} onChange={e=> setTypeIII(e.target.checked)} />
            Type III driver approved
          </label>
          <label className="inline-flex items-center gap-2">
            <input type="checkbox" checked={inactive} onChange={e=> setInactive(e.target.checked)} />
            Inactive (block new scheduling)
          </label>
          <div>
            <div className="text-sm font-medium mb-1">Avoid co-workers (backup list)</div>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
              {users.filter(u=> u.id!==me.id).map(u=> (
                <label key={u.id} className="inline-flex items-center gap-2 text-sm bg-gray-50 border rounded px-2 py-1">
                  <input type="checkbox" checked={avoid.has(u.id)} onChange={e=> setAvoid(u.id, e.target.checked)} />
                  {u.name}
                </label>
              ))}
            </div>
          </div>
        </div>
      </details>
    </div>
  );
}

        function setAvoid(uid, on){
          if (!me) return;
          const arr = Array.from(avoid);
          const next = on ? Array.from(new Set(arr.concat(uid))) : arr.filter(x=> x!==uid);
          const notes = JSON.stringify({ ...parsedNotes, avoid: next });
          actions.savePrefs(me.id, { notes });
        }
        function setTypeIII(on){
          if (!me) return;
          const notes = JSON.stringify({ ...parsedNotes, typeIII: !!on });
          actions.savePrefs(me.id, { notes });
        }

        if (!me) return <div className="text-sm text-gray-500">Loadingâ€¦</div>;

        return (
          <div className="space-y-4">
            <div className="flex flex-wrap items-center gap-3">
              <div className="text-sm">Logged in as: <span className="font-semibold">{member.user?.name || me.name}</span></div>
              <div className="ml-auto flex items-center gap-2 text-xs">
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-green-300 rounded"></span>Prefer</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-yellow-300 rounded"></span>Available</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 bg-red-300 rounded"></span>Do Not</span>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <button className="px-3 py-1 rounded bg-white border" onClick={()=> setOffset(o=> o-1)}>â—€ Prev</button>
              <label className="text-sm">Months shown</label>
              <input type="number" min="1" max="6" className="w-16 border rounded px-2 py-1" value={monthsAhead} onChange={e=> setMonthsAhead(Number(e.target.value||1))} />
              <button className="px-3 py-1 rounded bg-white border" onClick={()=> setOffset(o=> o+1)}>Next â–¶</button>
              <div className="ml-auto text-xs px-2 py-1 bg-amber-50 rounded border border-amber-200">
                Dates more than 4 weeks out are <b>Pre-commit</b> and may change until commit day.
              </div>
            </div>

            <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
              {months.map(({year, month})=> (
                <Month key={year+'-'+month} year={year} month={month}
                  renderCell={(d)=>{
                    const k = toISODate(d);
                    const v = av[k] || { AM:"unset", PM:"unset" };
                    const pc = preCommit(d);
                    return (
                      <div className="flex items-center justify-between gap-2">
                        <div className="flex items-center gap-2">
                          <AvBtn label="AM" value={v.AM} onChange={(s)=> actions.setAvailabilityCell(me.id, k, "AM", s)} />
                          <AvBtn label="PM" value={v.PM} onChange={(s)=> actions.setAvailabilityCell(me.id, k, "PM", s)} />
                        </div>
                        {pc && <span className="text-[10px] uppercase px-2 py-1 rounded-full bg-purple-100 border border-purple-300">Pre-commit</span>}
                      </div>
                    );
                  }}
                />
              ))}
            </div>

            <details className="rounded-2xl bg-white p-4 shadow">
              <summary className="cursor-pointer font-semibold">Preferences</summary>
              <div className="mt-3 grid gap-3">
                <label className="inline-flex items-center gap-2">
                  <input type="checkbox" checked={!!myPrefs.prefer24s} onChange={e=> actions.savePrefs(me.id, { prefer24s: e.target.checked })} />
                  Prefer 24s
                </label>
                <label className="inline-flex items-center gap-2">
                  <input type="checkbox" checked={typeIII} onChange={e=> setTypeIII(e.target.checked)} />
                  Type III driver approved
                </label>
                <div>
                  <div className="text-sm font-medium mb-1">Avoid co-workers (backup list)</div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    {users.filter(u=> u.id!==me.id).map(u=> (
                      <label key={u.id} className="inline-flex items-center gap-2 text-sm bg-gray-50 border rounded px-2 py-1">
                        <input type="checkbox" checked={avoid.has(u.id)} onChange={e=> setAvoid(u.id, e.target.checked)} />
                        {u.name}
                      </label>
                    ))}
                  </div>
                </div>
              </div>
            </details>
          </div>
        );
      }

      function SupervisorView(){
        return (
          <div className="bg-white rounded-2xl p-4 shadow text-sm text-gray-600">
            Supervisor controls will go here (add/deactivate members, defaults). Backend supports it; UI wiring is next step.
          </div>
        );
      }

      function App(){
        const member = useMember();
        const store = useStore(member.memberNo);
        const [tab, setTab] = useState("user");
        const [inputNo, setInputNo] = useState("");

        return (
          <div>
            <header className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
                <div className="font-bold text-lg tracking-tight">ShiftCommander</div>
                <div className="ml-2 text-xs px-2 py-1 rounded-full border">{store.connected?"Live":"Offline"}</div>
                <div className="ml-auto flex items-center gap-2">
                  {!member.user ? (
                    <>
                      <input className="border rounded px-2 py-1 text-sm" placeholder="Member #" value={inputNo} onChange={e=> setInputNo(e.target.value)} />
                      <button className="px-3 py-1 rounded bg-blue-600 text-white text-sm" onClick={()=> member.login(inputNo)}>Sign in</button>
                    </>
                  ) : (
                    <div className="flex items-center gap-3 text-sm">
                      <span className="px-2 py-1 bg-gray-100 rounded">{member.user.name} â€¢ {member.user.role} â€¢ #{member.user.member_no||"â€”"}</span>
                      <button className="px-2 py-1 rounded bg-gray-200" onClick={member.logout}>Sign out</button>
                    </div>
                  )}
                  <button className={"px-4 py-2 rounded-2xl text-sm font-medium border "+(tab==="user"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300")} onClick={()=> setTab("user")}>User View</button>
                  <button className={"px-4 py-2 rounded-2xl text-sm font-medium border "+(tab==="super"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300")} onClick={()=> setTab("super")}>Supervisor</button>
                </div>
              </div>
            </header>
            <main className="max-w-7xl mx-auto p-4">
              {tab==="user" ? <UserView store={store} member={member} /> : <SupervisorView />}
              <footer className="mt-10 text-xs text-gray-500">
                <div>AM/PM toggles auto-commit after 3s. Dates &gt;4 weeks show Pre-commit.</div>
              </footer>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
