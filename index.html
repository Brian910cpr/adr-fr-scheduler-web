<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShiftCommander â€” Beta</title>

    <!-- API base (Cloudflare Worker) -->
    <script>
      window.__API_BASE__ = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';
    </script>

    <!-- Tailwind + React + Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tiny favicon to avoid 404 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234f46e5'/%3E%3Ctext x='50' y='58' font-size='48' text-anchor='middle' fill='white'%3ESC%3C/text%3E%3C/svg%3E" />
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const API_BASE = window.__API_BASE__ || "";

      // ---------- utils ----------
      const todayISO = () => new Date().toISOString().slice(0,10);
      const addDays = (date, n) => { const d=new Date(date); d.setDate(d.getDate()+n); return d; };
      const toISODate = (d) => d.toISOString().slice(0,10);
      const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
      const rangeDays = (start, end) => { const out=[]; let d=new Date(start); while(d<=end){ out.push(new Date(d)); d.setDate(d.getDate()+1);} return out; };

      // ---------- availability UI ----------
      const AV = ["unset","prefer","available","no"];
      const AV_COL = { unset:"", prefer:"bg-green-200 ring-2 ring-green-500", available:"bg-yellow-200 ring-2 ring-yellow-500", no:"bg-red-200 ring-2 ring-red-500" };
      const cycle = (s)=> AV[(AV.indexOf(s??"unset")+1)%AV.length];

      // ---------- member (by number) ----------
      function useMember(){
        const [memberNo, setMemberNo] = useState(localStorage.getItem("__memberNo") || "");
        const [user, setUser] = useState(null);

        async function login(no){
          try{
            const r = await fetch(API_BASE + "/api/login", {
              method:"POST", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ memberNo:no })
            });
            if(!r.ok) throw new Error();
            const j = await r.json();
            localStorage.setItem("__memberNo", no);
            setMemberNo(no); setUser(j.user);
          }catch{
            alert("Login failed. Is that member # in the DB?");
          }
        }
        function logout(){ localStorage.removeItem("__memberNo"); setMemberNo(""); setUser(null); }

        useEffect(()=>{ if(memberNo) login(memberNo).catch(()=>logout()); }, []);
        return { memberNo, user, login, logout };
      }

      // ---------- data store ----------
      function useStore(memberNo){
