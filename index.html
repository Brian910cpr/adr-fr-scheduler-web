<!-- FILE: web/index.html  (single-page UI)
     Talks to: https://adr-fr-scheduler-api.brian-9ac.workers.dev
     Features:
      ‚Ä¢ 2-month calendar
      ‚Ä¢ AM/PM 4-way toggle (Prefer, Available, Unset, Do not)
      ‚Ä¢ Per-shift note (click the tiny üìù icon)
      ‚Ä¢ Supervisor mode: set Type III / Inactive, approve notes, and quick assign
      ‚Ä¢ Frictionless Swap: pick your assigned shift ‚Üí suggest or select replacement
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ShiftCommander</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0e1726; --panel:#121c2d; --ink:#e6eefc; --mut:#9db1d1; --green:#34d399; --yellow:#fbbf24; --red:#ef4444; --line:#1f2a40; --pill:#1a2438; --blue:#3b82f6; }
  * { box-sizing:border-box; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif }
  body { margin:0; background:linear-gradient(180deg,#0b1423,#0e1726); color:var(--ink); }
  header { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px 18px; background:#0a1320; position:sticky; top:0; z-index:2; border-bottom:1px solid #0f1a2a;}
  .brand { font-weight:700; letter-spacing:.2px; }
  .row { display:flex; gap:12px; align-items:center }
  select, input, button { background:var(--panel); color:var(--ink); border:1px solid var(--line); border-radius:8px; padding:8px 10px; }
  button { background:#1e293b; cursor:pointer }
  main { max-width:1100px; margin:18px auto; padding:0 12px; }
  .legend { display:flex; gap:14px; align-items:center; font-size:12px; color:var(--mut); margin:10px 0 18px }
  .legend i { display:inline-block; width:16px; height:16px; border-radius:6px; border:1px solid var(--line); margin-right:6px; vertical-align:-3px }
  .g { background:var(--green,.8) } .y{ background:var(--yellow)} .r{ background:var(--red)} .u{ background:var(--pill)}
  .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; }
  .month { margin-top:14px; }
  .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px; min-height:96px; position:relative }
  .dow { color:var(--mut); font-size:12px; margin:0 0 6px 2px }
  .date { position:absolute; top:8px; right:10px; color:var(--mut); font-size:12px }
  .pills { display:flex; gap:8px; margin-top:18px }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 9px; border:1px solid var(--line); border-radius:999px; background:var(--pill); font-size:12px; cursor:pointer; user-select:none }
  .pill.g { background:rgba(52,211,153,.18); border-color:rgba(52,211,153,.4) }
  .pill.y { background:rgba(251,191,36,.18); border-color:rgba(251,191,36,.4) }
  .pill.r { background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.4) }
  .pill small { color:var(--mut) }
  .note { position:absolute; bottom:8px; right:8px; color:var(--mut); font-size:12px; cursor:pointer }
  .warn { color:var(--yellow); font-size:12px; }
  .section { margin-top:22px; border-top:1px dashed #20304a; padding-top:16px }
  .stack { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .tag { padding:4px 8px; border-radius:999px; background:#17243a; border:1px solid var(--line); font-size:12px }
  details { border:1px solid var(--line); background:#101a2b; border-radius:12px; padding:10px 12px }
  details summary { cursor:pointer; color:var(--ink) }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  td, th { border-bottom:1px solid var(--line); padding:8px 6px; text-align:left }
  .btn { background:var(--blue); border-color:transparent }
  .mut { color:var(--mut) }
</style>
</head>
<body>

<header>
  <div class="brand">ShiftCommander</div>
  <div class="row">
    <label class="mut">Member&nbsp;#</label><input id="memberNo" style="width:90px" placeholder="1001" />
    <button id="signIn" class="btn">Sign in</button>
    <button id="userView">User View</button>
    <button id="superView">Supervisor</button>
  </div>
</header>

<main>
  <div class="legend">
    <span><i class="g"></i>Prefer</span>
    <span><i class="y"></i>Available</span>
    <span><i class="u"></i>Unset</span>
    <span><i class="r"></i>Do not</span>
  </div>

  <div id="months"></div>

  <div class="section">
    <details>
      <summary>Frictionless Shift Swap</summary>
      <div class="stack" style="margin-top:10px">
        <input id="swapDate" type="date">
        <select id="swapHalf">
          <option>AM</option><option>PM</option>
        </select>
        <button id="swapSuggest">Suggest replacement(s)</button>
      </div>
      <div id="swapOut" class="section"></div>
    </details>
  </div>

  <div class="section" id="superPanel" style="display:none">
    <h3>Supervisor tools</h3>
    <table>
      <thead><tr><th>Name</th><th>Role</th><th>Type III</th><th>Inactive</th><th>Save</th></tr></thead>
      <tbody id="superRows"></tbody>
    </table>
    <p class="mut">Per-shift notes appear on cards; approve them in place using the üìù dialog.</p>
  </div>
</main>

<script>
const API = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
let me = null;           // current user row
let users = {};          // id -> {name,role,type3_driver,inactive}
let stateCache = null;   // /api/state payload
let debounceTimers = new Map(); // key "uid|date|half" => timer

document.getElementById("signIn").onclick = async () => {
  const no = (document.getElementById("memberNo").value || "").trim();
  if (!no) return alert("Enter your member number");
  const list = await fetch(API+"/api/users").then(r=>r.json());
  me = list.find(u => u.member_no === no);
  if (!me) return alert("No user with that member #");
  await reload();
};

document.getElementById("userView").onclick = () => {
  document.getElementById("superPanel").style.display = "none";
};
document.getElementById("superView").onclick = () => {
  document.getElementById("superPanel").style.display = "";
  buildSupervisor();
};

async function reload() {
  const now = new Date();
  const m1 = new Date(now.getFullYear(), now.getMonth(), 1);
  const m2 = new Date(now.getFullYear(), now.getMonth()+1, 0);
  const start = toKey(m1); const end = toKey(m2);
  stateCache = await fetch(`${API}/api/state?start=${start}&end=${end}`).then(r=>r.json());
  users = stateCache.users || {};
  renderMonths(m1, m2);
  buildSupervisor();
}

function renderMonths(m1, m2) {
  const root = document.getElementById("months");
  root.innerHTML = "";
  root.appendChild(monthBlock(m1));
  const m2Start = new Date(m1.getFullYear(), m1.getMonth()+1, 1);
  root.appendChild(monthBlock(m2Start));
}
function monthBlock(d0) {
  const wrap = document.createElement("div"); wrap.className = "month";
  const title = document.createElement("h3");
  title.textContent = d0.toLocaleString(undefined,{month:"long", year:"numeric"});
  wrap.appendChild(title);
  const grid = document.createElement("div"); grid.className = "grid";
  // headers
  ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(h=>{
    const s = document.createElement("div"); s.className="mut"; s.textContent=h; grid.appendChild(s);
  });

  // compute first Monday grid
  const first = new Date(d0.getFullYear(), d0.getMonth(), 1);
  const startOffset = (first.getDay() + 6) % 7; // Mon=0
  let day = new Date(first); day.setDate(first.getDate() - startOffset);
  for (let i=0;i<42;i++) {
    grid.appendChild(dayCard(new Date(day)));
    day.setDate(day.getDate()+1);
  }

  wrap.appendChild(grid);
  return wrap;
}

function dayCard(d) {
  const k = toKey(d);
  const inMonth = (d.getMonth() === (new Date(stateCache ? Object.keys(stateCache.shifts||{})[0]||k : k)).getMonth());
  const card = document.createElement("div"); card.className="card";
  const date = document.createElement("div"); date.className="date"; date.textContent=d.getDate(); card.appendChild(date);
  const p = document.createElement("div"); p.className="pills";

  ["AM","PM"].forEach(half=>{
    const pill = document.createElement("div"); pill.className="pill"; pill.innerHTML = `<strong>${half}</strong>`;
    setPillColor(pill, getMyState(k, half));
    pill.onclick = () => cycleState(k, half, pill);
    p.appendChild(pill);

    const n = getMyNote(k, half);
    const noteBtn = document.createElement("div");
    noteBtn.className = "note";
    noteBtn.textContent = "üìù";
    noteBtn.title = n?.note ? (n.note + (n.note_approved ? "" : " (pending)")) : "Add note";
    noteBtn.onclick = () => editNote(k, half);
    const shell = document.createElement("div");
    shell.style.position="relative"; shell.appendChild(pill); shell.appendChild(noteBtn);
    p.appendChild(shell);
  });

  // warning text if shift is yellow/red (very light heuristic demo)
  const sh = (stateCache.shifts||{})[k];
  if (sh && (sh.AM || sh.PM)) {
    ["AM","PM"].forEach(half=>{
      const box = document.createElement("div"); box.style.marginTop="6px"; box.style.fontSize="12px";
      const s = sh[half];
      if (!s) return;
      const tip = briefTip(k, half, s.assignees || []);
      if (tip) { box.className="warn"; box.textContent = half+": "+tip; card.appendChild(box); }
    })
  }

  card.appendChild(p);
  return card;
}

// brief suggestion to clear condition (server-side scoring would be richer)
function briefTip(date, half, assignees) {
  // collect roles of current assignees
  const roles = assignees.map(id => (users[id]?.role || "").toUpperCase());
  if (roles.length === 0) return "Needs crew";
  if (!roles.includes("ALS")) return "Needs ALS";
  if (!roles.includes("EMT")) return "Needs EMT";
  return "";
}

function setPillColor(el, st) {
  el.classList.remove("g","y","r");
  if (st === "prefer") el.classList.add("g");
  else if (st === "available") el.classList.add("y");
  else if (st === "no") el.classList.add("r");
}

function getMyState(date, half) {
  if (!me || !stateCache) return "unset";
  const a = (stateCache.availability||{})[me.id];
  const rec = a ? a[date] : null;
  const v = rec ? rec[half] : null;
  return v ? (v.state || "unset") : "unset";
}
function getMyNote(date, half) {
  if (!me || !stateCache) return null;
  const a = (stateCache.availability||{})[me.id];
  const rec = a ? a[date] : null;
  return rec ? rec[half] : null;
}

function cycleState(date, half, pillEl) {
  if (!me) { alert("Sign in first."); return; }
  const cur = getMyState(date, half);
  const next = cur === "prefer" ? "available" : cur === "available" ? "unset" : cur === "unset" ? "no" : "prefer";
  setPillColor(pillEl, next);
  // debounce auto-commit
  const key = me.id+"|"+date+"|"+half;
  clearTimeout(debounceTimers.get(key));
  debounceTimers.set(key, setTimeout(async ()=>{
    await fetch(API+"/api/availability", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ userId: me.id, date, half, state: next })
    });
    // lazy refresh for subsequent cards
    stateCache.availability ||= {};
    (stateCache.availability[me.id] ||= {});
    (stateCache.availability[me.id][date] ||= { AM:null, PM:null })[half] = { state: next, note:"", note_approved:true };
  }, 3000));
}

async function editNote(date, half) {
  if (!me) { alert("Sign in first."); return; }
  const cur = getMyNote(date, half);
  const val = prompt("Enter a super brief note (e.g. 'In at 10am'):", cur?.note || "");
  if (val === null) return;
  await fetch(API+"/api/availability", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ userId: me.id, date, half, state: getMyState(date,half), note: val })
  });
  await reload();
}

// ---------- Supervisor ----------
function buildSupervisor() {
  const tbody = document.getElementById("superRows");
  if (!tbody) return;
  tbody.innerHTML = "";
  const list = Object.entries(users).map(([id,u])=>({ id, ...u }))
    .sort((a,b)=>a.name.localeCompare(b.name));
  for (const u of list) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.name}</td>
      <td>${u.role}</td>
      <td><input type="checkbox" ${u.type3_driver?"checked":""} data-k="t3"></td>
      <td><input type="checkbox" ${u.inactive?"checked":""} data-k="in"></td>
      <td><button class="btn">Save</button></td>
    `;
    tr.querySelector("button").onclick = async ()=>{
      const t3 = tr.querySelector('input[data-k="t3"]').checked;
      const ina = tr.querySelector('input[data-k="in"]').checked;
      await fetch(API+"/api/user/flags", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userId: u.id, type3_driver: t3, inactive: ina })
      });
      await reload();
    };
    tbody.appendChild(tr);
  }
}

// ---------- Swap ----------
document.getElementById("swapSuggest").onclick = async ()=>{
  if (!me) return alert("Sign in first.");
  const date = document.getElementById("swapDate").value;
  const half = document.getElementById("swapHalf").value;
  if (!date) return alert("Choose a date");
  const out = document.getElementById("swapOut"); out.innerHTML = "‚Ä¶";
  const res = await fetch(API+"/api/shift/swap", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ userId: me.id, date, half })
  }).then(r=>r.json());
  if (res.error) { out.textContent = res.error; return; }
  const frag = document.createElement("div");
  frag.className="stack";
  (res.suggestions||[]).forEach(s=>{
    const b = document.createElement("button");
    b.textContent = `${s.name} (${s.role})`;
    b.onclick = async ()=>{
      const ok = confirm(`Swap yourself with ${s.name} on ${date} ${half}?`);
      if (!ok) return;
      const done = await fetch(API+"/api/shift/swap", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userId: me.id, date, half, replacementId: s.id })
      }).then(r=>r.json());
      if (done.error) alert(done.error); else { alert("Swap approved."); await reload(); }
    };
    frag.appendChild(b);
  });
  out.innerHTML = "";
  out.appendChild(frag);
};

function toKey(d) { const dt = new Date(d); return dt.toISOString().slice(0,10); }
</script>
</body>
</html>
