<script>
// --- REPLACE THESE TWO FUNCTIONS ONLY ---

// 1) Only the shown month; no spillover days.
//    The 1st of the month will be positioned to its weekday column.
function monthSpan(d){
  const first = new Date(d); first.setDate(1);
  const last  = new Date(first); last.setMonth(last.getMonth()+1); last.setDate(0);
  // We DO NOT expand to the previous Sunday / next Saturday anymore.
  // Rows will break naturally because we force gridColumnStart on day 1.
  return { first, last };
}

// 2) Painter that forces a row break at each month start.
//    AM above PM; notes under their half; toggles unchanged.
function paint(){
  const { first, last } = monthSpan(currentMonth);
  monthTitle.textContent = first.toLocaleString(undefined,{month:'long',year:'numeric'});
  cal.innerHTML = '';

  const uid = selMember.value;

  // Ensure the grid always has 7 columns (Sun..Sat); rows auto-grow.
  cal.style.display = 'grid';
  cal.style.gridTemplateColumns = 'repeat(7, 1fr)';
  cal.style.gap = getComputedStyle(cal).gap || '10px';

  // Add DOW header (remove any existing one in the DOM if you had it elsewhere)
  // (Optional – if you already render DOW separately, comment this out)
  // const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  // dow.forEach(lbl => {
  //   const h = document.createElement('div');
  //   h.textContent = lbl;
  //   h.style.textAlign = 'center';
  //   h.style.color = 'var(--muted)';
  //   h.style.fontSize = '12px';
  //   h.style.fontWeight = '600';
  //   cal.appendChild(h);
  // });

  // Draw every day of THIS month only
  for (let d = new Date(first); d <= last; d.setDate(d.getDate()+1)) {
    const idate = d.toISOString().slice(0,10);

    const day = document.createElement('div');
    day.className = 'day';

    // Force new row at the 1st of the month:
    if (d.getDate() === 1) {
      // grid columns are 1..7; Sunday=0 → 1, Monday=1 → 2, etc.
      day.style.gridColumnStart = (d.getDay() + 1).toString();
    }

    // header
    const head = document.createElement('div');
    head.className = 'dhead';
    head.innerHTML = `<div>${d.toLocaleString(undefined,{weekday:'short'})}</div>
                      <div class="small">${d.toLocaleString(undefined,{month:'short',day:'numeric'})}</div>`;
    day.appendChild(head);

    // AM (toggle + note)
    const rowAM = document.createElement('div');
    rowAM.appendChild(buildChip(uid, idate, 'AM'));
    rowAM.appendChild(buildNote(uid, idate, 'AM'));
    day.appendChild(rowAM);

    // PM (toggle + note)
    const rowPM = document.createElement('div');
    rowPM.appendChild(buildChip(uid, idate, 'PM'));
    rowPM.appendChild(buildNote(uid, idate, 'PM'));
    day.appendChild(rowPM);

    cal.appendChild(day);
  }
}
</script>
