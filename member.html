<script>
(function(){
  // ====== CONFIG ======
  const API = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';

  // ====== UTIL ======
  const dbg = (...a)=>{ const el=document.getElementById('debug'); if(el) el.textContent += a.join(' ')+'\n'; };
  const iso = d => d.toISOString().slice(0,10);
  async function getJSON(url){
    const r = await fetch(url, {credentials:'omit'});
    if(!r.ok) { const e = new Error('HTTP '+r.status); e.status=r.status; throw e; }
    return r.json();
  }
  async function postJSON(url, body){
    const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok){ const e=new Error('POST '+url+' -> '+r.status); e.status=r.status; throw e; }
    return r.json().catch(()=>({ok:true}));
  }
  function stateClass(s){ return 'pill state-'+(s||'unset'); }
  const stateLabel = {prefer:'Prefer', available:'Available', unset:'Unset', no:'Do Not'};
  const nextStateOrder = ['prefer','available','unset','no'];

  // ====== DOM refs ======
  const memberSel = document.getElementById('memberSel');
  const grid = document.getElementById('grid');
  const monthLabel = document.getElementById('monthLabel');

  // ====== MONTH WINDOW ======
  let anchor = new Date(); anchor.setDate(1);
  function monthWindow(d){
    const first = new Date(d); first.setDate(1);
    const last  = new Date(d.getFullYear(), d.getMonth()+1, 0);
    const start = new Date(first); const sOff=(first.getDay()+6)%7; start.setDate(first.getDate()-sOff);
    const end   = new Date(last);  const eOff=(end.getDay()+6)%7;   end.setDate(end.getDate()+(6-eOff));
    return {start,end,first,last};
  }
  function setMonthLabel(d){
    monthLabel.textContent = d.toLocaleDateString(undefined,{month:'long',year:'numeric'});
  }

  // ====== STATE ======
  let currentUser = null;
  let windowStart, windowEnd;
  let usersById = {}; // id -> {id,callsign,name}

  // ====== USERS LOADING with FALLBACK ======
  async function loadUsersWithFallback(){
    // 1) Try /api/users
    try{
      const list = await getJSON(API+'/api/users');
      usersById = {};
      memberSel.innerHTML='';
      list.forEach(u=>{
        usersById[u.id]=u;
        const opt=document.createElement('option');
        opt.value=u.id;
        opt.textContent = `${u.callsign||u.name||u.id} (${u.id})`;
        memberSel.appendChild(opt);
      });
      currentUser = list.find(u=>u.id==='uq2w4or')?.id || list[0]?.id || 'uq2w4or';
      memberSel.value=currentUser;
      return;
    }catch(e){
      if(e.status!==404) throw e; // real failure, not “missing route”
      dbg('users 404 -> deriving from /api/state');
    }
    // 2) Derive from /api/state
    const {start,end} = monthWindow(anchor);
    const st = await getJSON(`${API}/api/state?start=${iso(start)}&end=${iso(end)}`);
    const ids = Object.keys(st.availability||{});
    if(ids.length===0){
      // 3) last resort: single user
      usersById = {'uq2w4or':{id:'uq2w4or',callsign:'1003 AJ'}};
      memberSel.innerHTML = '<option value="uq2w4or">1003 AJ (uq2w4or)</option>';
      currentUser = 'uq2w4or';
      return;
    }
    usersById={};
    memberSel.innerHTML='';
    ids.forEach(id=>{
      usersById[id]={id, callsign:id};
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=id; memberSel.appendChild(opt);
    });
    currentUser = ids.includes('uq2w4or') ? 'uq2w4or' : ids[0];
    memberSel.value=currentUser;
  }

  // ====== PAINT ======
  function makeRow(label, dateISO, half, current){
    const row = document.createElement('div'); row.className='row';
    const l = document.createElement('div'); l.className='lbl'; l.textContent=label;
    const right = document.createElement('div');

    const btn = document.createElement('span');
    btn.className = stateClass(current);
    btn.textContent = stateLabel[current||'unset'];
    btn.style.minWidth='100px';
    btn.style.display='inline-block';
    btn.style.cursor='pointer';
    btn.addEventListener('click', async ()=>{
      const next = nextStateOrder[(nextStateOrder.indexOf(current||'unset')+1)%nextStateOrder.length];
      try{
        await postJSON(API+'/api/availability',{userId:currentUser,date:dateISO,half,state:next});
        current = next;
        btn.className = stateClass(current);
        btn.textContent = stateLabel[current];
      }catch(e){ dbg('ERR save state', e.message||e); }
    });

    const note = document.createElement('input');
    note.className='note'; note.placeholder='Optional note to supervisor.'; note.value='';
    let t=null;
    const commit=()=>postJSON(API+'/api/notes',{userId:currentUser,date:dateISO,half,note:note.value||''}).catch(e=>dbg('ERR save note',e.message||e));
    note.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(commit,450); });
    note.addEventListener('blur',commit);

    right.appendChild(btn);
    right.appendChild(note);
    row.appendChild(l); row.appendChild(right);
    return row;
  }

  function paintCalendar(start,end,availForUser){
    grid.innerHTML='';
    const dow = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    dow.forEach(d=>{ const h=document.createElement('div'); h.className='dow'; h.textContent=d; grid.appendChild(h); });
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const k=iso(d); const a=(availForUser[k]&&availForUser[k]['AM'])||'unset'; const p=(availForUser[k]&&availForUser[k]['PM'])||'unset';
      const card=document.createElement('div'); card.className='card'; card.dataset.date=k;
      const h3=document.createElement('h3'); h3.textContent=d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); card.appendChild(h3);
      card.appendChild(makeRow('AM',k,'AM',a));
      card.appendChild(makeRow('PM',k,'PM',p));
      grid.appendChild(card);
    }
  }

  async function loadStateAndPaint(){
    const health = await getJSON(API+'/api/health').catch(()=>({ok:false}));
    dbg('health', JSON.stringify(health));
    const {start,end} = monthWindow(anchor);
    windowStart=iso(start); windowEnd=iso(end);
    setMonthLabel(anchor);
    const data = await getJSON(`${API}/api/state?start=${windowStart}&end=${windowEnd}`);
    const availUser = (data.availability && data.availability[currentUser]) || {};
    paintCalendar(start,end,availUser);
  }

  // ====== BULK TOOLS ======
  function applyQuickFill(targetState){
    grid.querySelectorAll('.card').forEach(card=>{
      const d=card.dataset.date;
      ['AM','PM'].forEach(half=>{
        postJSON(API+'/api/availability',{userId:currentUser,date:d,half,state:targetState}).catch(()=>{});
      });
      // reflect instantly
      const am = card.querySelector('.row:nth-of-type(2) .pill'); am.className=stateClass(targetState); am.textContent=stateLabel[targetState];
      const pm = card.querySelector('.row:nth-of-type(3) .pill'); pm.className=stateClass(targetState); pm.textContent=stateLabel[targetState];
    });
  }
  function applyWeekdayMask(){
    const daysTxt = (document.getElementById('weekdayMask').value||'').trim();
    const days = new Set(daysTxt ? daysTxt.split(/[,\s]+/).map(n=>parseInt(n,10)).filter(x=>x>=1&&x<=7) : [1,2,3,4,5,6,7]);
    const amState = document.getElementById('amMask').value;
    const pmState = document.getElementById('pmMask').value;
    grid.querySelectorAll('.card').forEach(card=>{
      const d=new Date(card.dataset.date+'T00:00:00'); const wd=((d.getDay()+6)%7)+1; if(!days.has(wd)) return;
      if(amState){ postJSON(API+'/api/availability',{userId:currentUser,date:card.dataset.date,half:'AM',state:amState}).catch(()=>{}); const am=card.querySelector('.row:nth-of-type(2) .pill'); am.className=stateClass(amState); am.textContent=stateLabel[amState]; }
      if(pmState){ postJSON(API+'/api/availability',{userId:currentUser,date:card.dataset.date,half:'PM',state:pmState}).catch(()=>{}); const pm=card.querySelector('.row:nth-of-type(3) .pill'); pm.className=stateClass(pmState); pm.textContent=stateLabel[pmState]; }
    });
  }
  function clearAllNotes(){
    grid.querySelectorAll('.card').forEach(card=>{
      ['AM','PM'].forEach(half=>{
        postJSON(API+'/api/notes',{userId:currentUser,date:card.dataset.date,half,note:''}).catch(()=>{});
        const input = card.querySelector(half==='AM'?'.row:nth-of-type(2) .note':'.row:nth-of-type(3) .note');
        input.value='';
      });
    });
  }
  document.getElementById('bulkTools').addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const q = chip.dataset.q; if(q) applyQuickFill(q);
  });
  document.getElementById('applyMask').addEventListener('click', applyWeekdayMask);
  document.getElementById('clearNotes').addEventListener('click', clearAllNotes);

  // ====== NAV + MEMBER ======
  document.getElementById('prevBtn').addEventListener('click', ()=>{ anchor.setMonth(anchor.getMonth()-1); loadStateAndPaint().catch(e=>dbg('ERR',e.message)); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ anchor.setMonth(anchor.getMonth()+1); loadStateAndPaint().catch(e=>dbg('ERR',e.message)); });
  memberSel.addEventListener('change', ()=>{ currentUser = memberSel.value; loadStateAndPaint().catch(e=>dbg('ERR',e.message)); });

  // ====== BOOT ======
  (async function boot(){
    try{
      dbg('booting…');
      await loadUsersWithFallback();
      await loadStateAndPaint();
      dbg('ready.');
    }catch(e){
      dbg('ERR boot', e.message||e);
    }
  })();
})();
</script>
