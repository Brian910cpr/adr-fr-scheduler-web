<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander · Member (Safe Render)</title>
<style>
  :root{--bg:#0f141b;--panel:#121a23;--bd:#233142;--text:#e7edf5;--muted:#8ea1b8;--pill:#1b2431;--prefer:#1e8fff;--avail:#36b24d;--no:#dd4b39;--unset:#2b3647;--note:#fff;--noteText:#0c1320}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .tabs a{color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:14px;border:1px solid var(--bd);background:var(--panel)}
  .tabs a.active{color:var(--text);border-color:#2b3a51}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .select{background:var(--panel);border:1px solid var(--bd);color:var(--text);padding:6px 10px;border-radius:8px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:12px}
  .day{background:var(--panel);border:1px dashed var(--bd);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:110px}
  .dow{font-size:12px;color:var(--muted)} .date{font-weight:700}
  .pills{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;justify-content:center;height:34px;min-width:56px;padding:0 14px;border-radius:999px;border:1px solid var(--bd);background:var(--pill);cursor:pointer}
  .pill[data-state="prefer"]{background:var(--prefer);color:#fff;font-weight:700;border-color:transparent}
  .pill[data-state="available"]{background:var(--avail);color:#fff;font-weight:700;border-color:transparent}
  .pill[data-state="no"]{background:var(--no);color:#fff;font-weight:700;border-color:transparent}
  .pill[data-state="unset"]{background:var(--unset);color:#c7d0dc}
  .noteBtn{margin-top:4px;display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--pill);color:var(--text);cursor:pointer}
  .noteBtn.hasNote{background:var(--note);color:var(--noteText);font-weight:600}
  .panel{background:#0b121a;border:1px solid var(--bd);border-radius:12px;padding:10px;margin-top:16px}
  .debug{font:12px/1.4 ui-monospace,Consolas,monospace;color:#cfe3ff;max-height:220px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ShiftCommander <span style="color:#8ea1b8">Member</span></h1>
    <nav class="tabs">
      <a class="active" href="./member.html">Member</a>
      <a href="./supervisor.html">Supervisor</a>
      <a href="./wallboard.html">Wallboard</a>
    </nav>
  </header>

  <div class="row">
    <label>Member&nbsp;
      <select id="memberSelect" class="select">
        <option value="uq2w4or">1003 AJ (uq2w4or)</option>
        <option value="u1">u1</option>
        <option value="u76uhkd">u76uhkd</option>
      </select>
    </label>
    <div style="flex:1"></div>
    <button id="prevBtn" class="select">◀</button>
    <div id="monthTitle" style="min-width:160px;text-align:center;font-weight:700"></div>
    <button id="nextBtn" class="select">▶</button>
  </div>

  <div id="calendar" class="calendar" aria-live="polite">
    <!-- skeleton so page never looks empty -->
    <div class="day"><div class="dow">Mon</div><div class="date">—</div><div class="pills"><div class="pill" data-state="unset"><small>AM</small></div><div class="pill" data-state="unset"><small>PM</small></div></div></div>
  </div>

  <div class="panel">
    <strong>Debug Console</strong>
    <div id="debug" class="debug">Booting…</div>
  </div>
</div>

<script>
(function(){
  const API = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const debug = (m)=>{ const el=document.getElementById('debug'); el.textContent += '\\n' + m }
  window.onerror = (msg,src,line,col,err)=>{ debug('JS ERROR: '+msg+' @'+(src||'inline')+':'+line+':'+col+'\\n'+(err&&err.stack?err.stack:'')) }

  // Always paint something first
  document.getElementById('monthTitle').textContent = new Date().toLocaleDateString(undefined,{month:'long',year:'numeric'});
  debug('UI skeleton painted.');

  // Health check
  fetch(API+'/api/health').then(r=>{
    debug('GET /api/health → '+r.status); return r.json()
  }).then(j=>{
    debug('health payload: '+JSON.stringify(j));
    loadMonth();
  }).catch(e=>{
    debug('health failed: '+e);
  });

  // Minimal loader with try/catch so rendering never breaks
  async function loadMonth(){
    try{
      const today = new Date(); today.setHours(0,0,0,0);
      const start = iso(addDays(firstOfMonth(today),-((firstOfMonth(today).getDay()+6)%7)));
      const end   = iso(addDays(lastOfMonth(today), 6-((lastOfMonth(today).getDay()+6)%7)));
      debug(`fetching state window ${start} → ${end}`);

      const r = await fetch(`${API}/api/state?start=${start}&end=${end}`);
      debug('GET /api/state → '+r.status);
      const data = await r.json();
      debug('state keys: '+Object.keys(data||{}).join(', '));

      paintCalendar(data);
    }catch(e){
      debug('loadMonth failed: '+e.message);
    }
  }

  function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1) }
  function lastOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0) }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x }
  function iso(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10) }

  function stateOf(av,user,date,half){
    return av?.[user]?.[date]?.[half] || 'unset';
  }

  function paintCalendar(data){
    const av = data.availability||{};
    const user = document.getElementById('memberSelect').value;
    const grid = document.getElementById('calendar'); grid.innerHTML='';
    const base = firstOfMonth(new Date());
    const start = addDays(base,-((base.getDay()+6)%7));
    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const dt = iso(d);
      const el = document.createElement('div'); el.className='day';
      el.innerHTML = `
        <div class="dow">${d.toLocaleDateString(undefined,{weekday:'short'})}</div>
        <div class="date">${d.getDate()}</div>
        <div class="pills">
          <div class="pill" data-state="${stateOf(av,user,dt,'AM')}"><small>AM</small></div>
          <div class="pill" data-state="${stateOf(av,user,dt,'PM')}"><small>PM</small></div>
        </div>`;
      grid.appendChild(el);
    }
    debug('calendar painted OK.');
  }
})();
</script>
</body>
</html>
