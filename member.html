<!-- member.html â€” paste this just before </body> -->
<script>
/**
 * Shared API client
 */
window.SCHED = (function(){
  const API = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
  const CURRENT_USER_ID = window.CURRENT_USER_ID || "uq2w4or"; // replace with real auth

  async function _post(url, body, tries=3){
    try{
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){
      if(tries>1) return _post(url, body, tries-1);
      throw e;
    }
  }

  async function health(){
    const r = await fetch(`${API}/api/health`);
    return r.json();
  }
  async function writeAvailability({userId=CURRENT_USER_ID, date, half, state, note}){
    const payload = { userId, date, half, state };
    if(typeof note==="string") payload.note = note; // optional
    return _post(`${API}/api/availability`, payload);
  }
  async function fetchState({start, end}){
    const r = await fetch(`${API}/api/state?start=${start}&end=${end}`);
    if(!r.ok) throw new Error("state fetch failed");
    return r.json();
  }

  return { API, CURRENT_USER_ID, health, writeAvailability, fetchState };
})();
</script>
<script>
// ================= MEMBER PAGE WIRING (no visual changes) =================
//
// Expected DOM per day:
// <div class="day" data-date="YYYY-MM-DD">
//   <div class="am">
//     <button class="intent" data-state="prefer">Prefer</button>
//     <button class="intent" data-state="available">Available</button>
//     <button class="intent" data-state="no">No</button>
//     <button class="note-toggle">Note</button>
//     <textarea class="note-input" placeholder="ie: 'In at 10am'"></textarea>
//   </div>
//   <div class="pm"> ...same structure... </div>
// </div>

(function(){
  const style = document.createElement("style");
  style.textContent = `
    .note-toggle.has-note { background:#fff !important; color:#000 !important; }
    .note-input { display:none; width:100%; min-height:48px; margin-top:6px; }
    .note-input.open { display:block; }
    .intent.active { outline:2px solid currentColor; }
  `;
  document.head.appendChild(style);

  const Q = {
    day:        ".day[data-date]",
    amBox:      ".am",
    pmBox:      ".pm",
    intentBtns: ".intent",
    noteBtn:    ".note-toggle",
    noteInput:  ".note-input",
  };

  function getHalfBox(dayEl, half){ return dayEl.querySelector(half==="AM" ? Q.amBox : Q.pmBox); }

  function paintIntent(halfBox, state){
    halfBox.querySelectorAll(Q.intentBtns).forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.state === state);
    });
  }

  function invertNoteButton(noteBtn, hasNote){
    if(!noteBtn) return;
    noteBtn.classList.toggle("has-note", !!hasNote);
  }

  async function onIntentClick(e){
    const btn = e.target.closest(Q.intentBtns);
    if(!btn) return;
    const halfBox = e.currentTarget;
    const dayEl = halfBox.closest(Q.day);
    const date = dayEl?.dataset.date;
    const half = halfBox.classList.contains("am") ? "AM" : "PM";
    const state = btn.dataset.state; // prefer | available | no

    try{
      await SCHED.writeAvailability({ date, half, state });
      paintIntent(halfBox, state);
    }catch(err){
      console.error("writeAvailability failed", err);
      alert("Could not save. Please try again.");
    }
  }

  function onNoteToggle(e){
    const noteBtn = e.target.closest(Q.noteBtn);
    if(!noteBtn) return;
    const halfBox = noteBtn.closest(".am, .pm");
    const input = halfBox.querySelector(Q.noteInput);
    if(!input) return;
    input.classList.toggle("open");
    if(input.classList.contains("open")) input.focus();
  }

  async function onNoteCommit(e){
    const input = e.target.closest(Q.noteInput);
    if(!input) return;
    const isBlur = e.type==="blur";
    const isSubmit = (e.type==="keydown" && (e.ctrlKey||e.metaKey) && e.key==="Enter");
    if(!isBlur && !isSubmit) return;

    const halfBox = input.closest(".am, .pm");
    const dayEl = input.closest(Q.day);
    const date = dayEl?.dataset.date;
    const half = halfBox.classList.contains("am") ? "AM" : "PM";
    const text = (input.value||"").trim();

    try{
      // state:'unset' so we don't change user's current intent colors accidentally
      await SCHED.writeAvailability({ date, half, state:"unset", note:text });
      invertNoteButton(halfBox.querySelector(Q.noteBtn), text.length>0);
      input.classList.remove("open");
    }catch(err){
      console.error("note save failed", err);
      alert("Could not save note. Please try again.");
    }
  }

  async function initialPaint(){
    const dates = Array.from(document.querySelectorAll(Q.day)).map(d=>d.dataset.date).sort();
    if(!dates.length) return;
    const start = dates[0], end = dates[dates.length-1];

    let data;
    try{ data = await SCHED.fetchState({ start, end }); }
    catch(e){ console.warn("state fetch failed", e); return; }

    const my = (data.availability && data.availability[SCHED.CURRENT_USER_ID]) || {};

    document.querySelectorAll(Q.day).forEach(dayEl=>{
      const d = dayEl.dataset.date;
      const rec = my[d] || {};
      const amBox = getHalfBox(dayEl, "AM");
      const pmBox = getHalfBox(dayEl, "PM");

      if(amBox && rec.AM) paintIntent(amBox, rec.AM);
      if(pmBox && rec.PM) paintIntent(pmBox, rec.PM);

      // When API exposes notes per half, invert note buttons here accordingly.
      // Example:
      // if(amBox && typeof rec.AM_note==="string") invertNoteButton(amBox.querySelector(Q.noteBtn), rec.AM_note.length>0);
      // if(pmBox && typeof rec.PM_note==="string") invertNoteButton(pmBox.querySelector(Q.noteBtn), rec.PM_note.length>0);
    });
  }

  function bind(){
    document.querySelectorAll(`${Q.day} ${Q.amBox}, ${Q.day} ${Q.pmBox}`).forEach(halfBox=>{
      halfBox.addEventListener("click", onIntentClick);
      halfBox.addEventListener("click", onNoteToggle);
      const input = halfBox.querySelector(Q.noteInput);
      if(input){
        input.addEventListener("blur", onNoteCommit);
        input.addEventListener("keydown", onNoteCommit);
      }
    });
  }

  (async function(){
    try{ await SCHED.health(); }catch(e){}
    bind();
    initialPaint();
  })();
})();
</script>
