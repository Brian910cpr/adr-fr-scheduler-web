<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander · Member</title>
<style>
  :root{
    --bg:#0e1318; --ink:#e4ecf5; --muted:#93a2b3;
    --frame:#161f28; --ring:#253344; --panel:#0a1116;
    --chip:#1f2c3b; --chip-b:#2a394c;
    --ok:#0f5f2d; --ok-b:#146f36; --ok-t:#e8f7ef;
    --mid:#2e5430; --mid-b:#37683a;
    --unset:#2a3241; --unset-b:#354055; --unset-t:#cbd5e1;
    --no:#7a1b1b; --no-b:#902424;
    --btn:#14202b; --btn-b:#223142;
  }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:18px auto;padding:0 10px}
  /* header */
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  h1{font-size:18px;margin:0 10px 0 0}
  .tabs a{display:inline-block;padding:6px 10px;border-radius:8px;background:var(--btn);border:1px solid var(--btn-b);color:var(--ink);text-decoration:none;margin-right:6px}
  .spacer{flex:1}
  .navbtn{width:30px;height:30px;border-radius:8px;border:1px solid var(--btn-b);background:var(--btn);color:var(--ink);cursor:pointer}
  .month{min-width:160px;text-align:center;font-weight:700}
  .sel,.btn{height:30px;border-radius:8px;border:1px solid var(--btn-b);background:#0b1218;color:var(--ink);padding:0 10px}
  .btn{background:var(--btn);cursor:pointer}
  .btn.warn{background:#351a1a;border-color:#4a2525}
  /* calendar grid */
  .dow{display:grid;grid-template-columns:repeat(7,minmax(110px,1fr));gap:6px;margin:10px 0 4px}
  .dow div{font-size:12px;color:var(--muted);text-align:center}
  .grid{display:grid;grid-template-columns:repeat(7,minmax(110px,1fr));gap:6px}
  .card{background:var(--frame);border:1px solid var(--ring);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px;min-height:90px}
  .date{font-size:12px;color:var(--muted);font-weight:700}
  .half{display:grid;grid-template-columns:auto minmax(86px,auto) 1fr;gap:6px;align-items:center}
  .label{font-size:11px;color:var(--muted);width:26px}
  .toggle{justify-self:start;min-width:86px;height:26px;display:inline-flex;align-items:center;justify-content:center;border-radius:16px;border:1px solid var(--chip-b);background:var(--chip);color:var(--ink);font-weight:700;font-size:12px;cursor:pointer;user-select:none;padding:0 10px}
  .state-prefer{background:var(--ok);border-color:var(--ok-b);color:var(--ok-t)}
  .state-available{background:var(--mid);border-color:var(--mid-b)}
  .state-unset{background:var(--unset);border-color:var(--unset-b);color:var(--unset-t)}
  .state-no{background:var(--no);border-color:var(--no-b)}
  /* short notes (about ~55% of a narrow card) */
  .note{height:26px;border-radius:8px;border:1px solid var(--ring);background:#0b1216;color:var(--ink);padding:0 8px;font-size:12px;max-width:160px}
  /* footer options */
  .panel{margin-top:10px;padding:8px;background:var(--panel);border:1px dashed var(--ring);border-radius:10px}
  .muted{color:var(--muted)}
  .console{margin-top:10px;background:#091017;border:1px dashed var(--ring);border-radius:10px;font:12px ui-monospace,Consolas,Menlo,monospace;color:#a9b8c7;padding:8px;white-space:pre-wrap}
  @media (max-width:920px){
    .grid,.dow{grid-template-columns:repeat(4,minmax(110px,1fr))}
  }
  @media (max-width:640px){
    .grid,.dow{grid-template-columns:repeat(2,minmax(110px,1fr))}
    .half{grid-template-columns:min-content 1fr;grid-auto-rows:26px}
    .note{grid-column:1 / span 2}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1>ShiftCommander <span class="muted">Member</span></h1>
    <div class="tabs">
      <a href="/member.html">Member</a>
      <a href="/supervisor.html">Supervisor</a>
      <a href="/wallboard.html">Wallboard</a>
    </div>
    <div class="spacer"></div>
    <select id="memberSelect" class="sel" title="Member"></select>
    <button id="prev" class="navbtn" aria-label="Previous month">◀</button>
    <div id="monthLabel" class="month">…</div>
    <button id="next" class="navbtn" aria-label="Next month">▶</button>
  </div>

  <div class="dow">
    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
  </div>
  <div id="grid" class="grid"></div>

  <div class="panel">
    <div class="row" style="gap:6px;margin-bottom:4px">
      <span class="muted">Options:</span>
      <button class="btn" data-bulk="prefer">All → Prefer</button>
      <button class="btn" data-bulk="available">All → Available</button>
      <button class="btn" data-bulk="unset">All → Unset</button>
      <button class="btn" data-bulk="no">All → Do Not</button>
      <button class="btn warn" id="clearNotes">Clear all notes</button>
      <span class="muted" style="margin-left:auto">Cycle: Prefer → Available → Unset → Do Not → …</span>
    </div>
  </div>

  <div id="console" class="console">booting…</div>
</div>

<script>
(function(){
  // ---------- CONFIG ----------
  const API_BASE = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev'; // change if needed
  const DEFAULT_USER = 'uq2w4or';
  const stateOrder = ['prefer','available','unset','no'];

  // ---------- STATE ----------
  let userId = DEFAULT_USER;
  let anchor = new Date(); anchor.setDate(1);
  let availability = {}; // availability[userId][date] = { AM:'x', PM:'y', AM_note, PM_note }

  // ---------- UTIL ----------
  const pad = n => (n<10?'0':'')+n;
  const fmt = d => d.toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const monthLabel = d => d.toLocaleString(undefined,{month:'long',year:'numeric'});
  function startOfCalendar(d){ const x=new Date(d); x.setDate(1); const w=(x.getDay()+6)%7; return addDays(x,-w); }
  function endOfCalendar(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); const w=(x.getDay()+6)%7; return addDays(x,6-w); }
  function log(s){ const c=document.getElementById('console'); c.textContent+=(c.textContent?'\n':'')+s; c.scrollTop=c.scrollHeight; }
  function labelFor(s){ return s==='prefer'?'Prefer':s==='available'?'Available':s==='no'?'Do Not':'Unset'; }

  // ---------- API ----------
  async function api(path, opts={}){
    const res = await fetch(API_BASE+path, {headers:{'Content-Type':'application/json'}, ...opts});
    if(!res.ok) throw new Error('HTTP '+res.status+' '+path);
    if(res.status===204) return null;
    return res.json();
  }
  async function getUsers(){
    try{
      const j = await api('/api/users'); // expects [{id,name},...] or {users:[...]}
      return Array.isArray(j)? j : (j.users||[]);
    }catch(_){ return []; }
  }
  async function loadWindow(){
    const start = startOfCalendar(anchor), end = endOfCalendar(anchor);
    const j = await api(`/api/state?start=${fmt(start)}&end=${fmt(end)}`);
    availability = j.availability || {};
  }
  async function saveHalf(dateStr, half, newState, note){
    const body = { userId, date:dateStr, half, state:newState };
    if(typeof note === 'string') body.note = note;
    await api('/api/availability',{ method:'POST', body: JSON.stringify(body) });
  }

  // ---------- RENDER ----------
  function paint(){
    document.getElementById('monthLabel').textContent = monthLabel(anchor);
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    const start = startOfCalendar(anchor), end = endOfCalendar(anchor);

    for(let d=new Date(start); d<=end; d=addDays(d,1)){
      const dateStr = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const card = document.createElement('div'); card.className='card';

      const head = document.createElement('div'); head.className='date';
      head.textContent = d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
      card.appendChild(head);

      // AM first, then PM
      card.appendChild(halfRow(dateStr,'AM'));
      card.appendChild(halfRow(dateStr,'PM'));

      grid.appendChild(card);
    }
  }

  function halfRow(dateStr, half){
    const row = document.createElement('div'); row.className='half';

    const label = document.createElement('div'); label.className='label'; label.textContent = half;
    const btn   = document.createElement('div'); btn.className='toggle'; btn.setAttribute('role','button');
    btn.dataset.date = dateStr; btn.dataset.half = half;

    const note  = document.createElement('input'); note.className='note'; note.placeholder='Note';

    const curState = () => (availability?.[userId]?.[dateStr]?.[half] || 'unset');
    const curNote  = () => (availability?.[userId]?.[dateStr]?.[half+'_note'] || '');

    function applyLook(s){
      btn.classList.remove('state-prefer','state-available','state-unset','state-no');
      btn.classList.add('state-'+s); btn.textContent = labelFor(s);
    }
    applyLook(curState()); note.value = curNote();

    btn.addEventListener('click', async ()=>{
      const s = curState();
      const next = stateOrder[(stateOrder.indexOf(s)+1)%stateOrder.length];
      applyLook(next);
      try{
        await saveHalf(dateStr, half, next, note.value.trim());
        availability[userId] ||= {}; availability[userId][dateStr] ||= {};
        availability[userId][dateStr][half] = next;
        log(`saved ${dateStr} ${half} = ${next}`);
      }catch(e){ log('ERR save state '+e.message); applyLook(s); }
    });

    note.addEventListener('keydown', ev=>{ if(ev.key==='Enter') note.blur(); });
    note.addEventListener('blur', async ()=>{
      try{
        await saveHalf(dateStr, half, curState(), note.value.trim());
        availability[userId] ||= {}; availability[userId][dateStr] ||= {};
        availability[userId][dateStr][half+'_note'] = note.value.trim();
        log(`note saved ${dateStr} ${half}`);
      }catch(e){ log('ERR save note '+e.message); }
    });

    row.appendChild(label);
    row.appendChild(btn);
    row.appendChild(note);
    return row;
  }

  // ---------- SIMPLE BULK ----------
  async function bulk(state){
    const toggles = document.querySelectorAll('.toggle');
    for(const el of toggles){
      const date = el.dataset.date, half = el.dataset.half;
      try{
        await saveHalf(date, half, state);
        availability[userId] ||= {}; availability[userId][date] ||= {};
        availability[userId][date][half] = state;
        el.className = 'toggle state-'+state; el.textContent = labelFor(state);
      }catch(e){ log('ERR bulk '+e.message); }
    }
  }
  async function clearAllNotes(){
    const inputs = document.querySelectorAll('.note');
    for(const i of inputs){
      const btn = i.previousSibling;
      const date = btn.dataset.date, half = btn.dataset.half;
      const s = availability?.[userId]?.[date]?.[half] || 'unset';
      i.value='';
      try{
        await saveHalf(date, half, s, '');
        availability[userId][date][half+'_note']='';
      }catch(e){ log('ERR clear notes '+e.message); }
    }
  }

  // ---------- BOOT ----------
  async function boot(){
    log('booting…');
    try{
      const h = await api('/api/health'); log('health '+JSON.stringify(h));
    }catch(e){ log('ERR health '+e.message); }

    const sel = document.getElementById('memberSelect'); sel.innerHTML='';
    const members = await getUsers();
    if(members.length){
      for(const m of members){
        const opt=document.createElement('option');
        opt.value=m.id||m.user_id||DEFAULT_USER; opt.textContent=m.name||m.display||opt.value;
        sel.appendChild(opt);
      }
      userId = sel.value;
    }else{
      const opt=document.createElement('option');
      opt.value=DEFAULT_USER; opt.textContent='1003 AJ (fallback)';
      sel.appendChild(opt); userId=DEFAULT_USER;
    }
    sel.onchange = async ()=>{ userId = sel.value; await reload(); };

    await reload();
  }

  async function reload(){
    try{
      await loadWindow();
      paint();
      log('ready '+userId+' '+monthLabel(anchor));
    }catch(e){ log('ERR load '+e.message); paint(); }
  }

  // nav & bulk wiring
  document.getElementById('prev').onclick = ()=>{ anchor.setMonth(anchor.getMonth()-1); reload(); };
  document.getElementById('next').onclick = ()=>{ anchor.setMonth(anchor.getMonth()+1); reload(); };
  document.querySelectorAll('[data-bulk]').forEach(b=> b.onclick = ()=> bulk(b.dataset.bulk));
  document.getElementById('clearNotes').onclick = clearAllNotes;

  boot();
})();
</script>
</body>
</html>
