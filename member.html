<!-- member.html (4-state cycling: prefer → available → unset → no) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ShiftCommander · Member</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.tailwindcss.com" rel="stylesheet">
  <style>
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;font-size:.8rem;margin-right:.5rem}
    .chip.green{background:#e8f7ef;color:#0f5132;border:1px solid #badbcc}
    .chip.yellow{background:#fff3cd;color:#664d03;border:1px solid #ffecb5}
    .chip.gray{background:#eef2f7;color:#374151;border:1px solid #cfd8e3}
    .chip.red{background:#f8d7da;color:#842029;border:1px solid #f5c2c7}

    .pill{border:1px solid #d1d5db;border-radius:.5rem;padding:.25rem .6rem;margin:.125rem;cursor:pointer;user-select:none}
    .pill.prefer{background:#e8f7ef;border-color:#0f5132;color:#0f5132}
    .pill.available{background:#fff3cd;border-color:#664d03;color:#664d03}
    .pill.unset{background:#eef2f7;border-color:#cfd8e3;color:#374151}
    .pill.no{background:#f8d7da;border-color:#842029;color:#842029}

    .daycard{border:1px solid #e5e7eb;border-radius:.75rem;padding:.5rem;margin:.25rem;min-width:9rem;background:#fff}
    .halfrow{display:flex;gap:.5rem;align-items:center;margin-top:.25rem}
    .halfrow .label{width:2.25rem;opacity:.75}
    .grid-days{display:grid;grid-template-columns:repeat(auto-fill,minmax(10.5rem,1fr));gap:.5rem}
    .badge{padding:.15rem .4rem;border-radius:.5rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:.75rem}
    #apiError{display:none}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="text-xl font-semibold">ShiftCommander <span class="badge">Member</span></div>
    <nav class="space-x-2">
      <a class="pill unset" href="/supervisor.html">Supervisor</a>
      <a class="pill unset" href="/wallboard.html">Wallboard</a>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-20">
    <div id="apiError" class="mb-3 p-3 rounded-md border border-red-300 bg-red-50 text-red-800 text-sm"></div>

    <section class="mb-4 flex items-center gap-3">
      <div>Member #</div>
      <select id="memberSelect" class="border rounded px-2 py-1"></select>
      <div id="apiStatus" class="chip gray">Connecting…</div>
    </section>

    <section class="mb-4 flex items-center gap-2">
      <button id="prevBtn" class="pill unset">Prev</button>
      <label>Months</label>
      <select id="monthsSel" class="border rounded px-2 py-1">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
      </select>
      <button id="nextBtn" class="pill unset">Next</button>
      <div class="ml-auto text-sm">
        <span class="chip green">Prefer</span>
        <span class="chip yellow">Available</span>
        <span class="chip gray">If needed</span>
        <span class="chip red">Do Not</span>
      </div>
    </section>

    <section class="mb-6">
      <details class="bg-white rounded-lg border p-3">
        <summary class="cursor-pointer font-medium">Preferences & bulk tools</summary>
        <div class="mt-3 grid md:grid-cols-2 gap-3">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="reserveChk"> Reserve mode (never auto-assign me)</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="inactiveChk"> Inactive</label>

          <div class="flex items-center gap-3 md:col-span-2 flex-wrap">
            <span>Bulk from</span><input id="bulkFrom" type="date" class="border rounded px-2 py-1">
            <span>to</span><input id="bulkTo" type="date" class="border rounded px-2 py-1">
            <span class="ml-2">Set to:</span>
            <label class="inline-flex items-center gap-1"><input type="radio" name="bulkState" value="prefer"> Prefer</label>
            <label class="inline-flex items-center gap-1"><input type="radio" name="bulkState" value="available" checked> Available</label>
            <label class="inline-flex items-center gap-1"><input type="radio" name="bulkState" value="unset"> If needed</label>
            <label class="inline-flex items-center gap-1"><input type="radio" name="bulkState" value="no"> Do Not</label>
            <label class="inline-flex items-center gap-1 ml-2"><input type="checkbox" id="bulkAM" checked> AM</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" id="bulkPM" checked> PM</label>
            <button id="bulkApply" class="pill available">Apply</button>
          </div>
        </div>
      </details>
      <p class="text-xs text-gray-500 mt-1">AM/PM toggles auto-commit after ~3 seconds. Dates &gt; 4 weeks show “Pre-commit”.</p>
    </section>

    <section id="calendar"></section>
  </main>

  <script>
    const API_BASE = new URLSearchParams(location.search).get('api') || "https://adr-fr-scheduler-api.brian-9ac.workers.dev";

    async function api(path, opts={}) {
      const res = await fetch(API_BASE + path, { headers:{ "Content-Type":"application/json" }, ...opts });
      if (!res.ok) { const t = await res.text().catch(()=>res.statusText); throw new Error(`HTTP ${res.status} ${path}: ${t}`); }
      return res.json();
    }
    function showApiError(msg){
      const el = document.getElementById('apiError');
      el.textContent = "API error: " + msg;
      el.style.display = 'block';
      const st = document.getElementById('apiStatus');
      st.className = 'chip red'; st.textContent = 'API error';
    }

    // Utilities
    function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
    function fmtISO(d){ return d.toISOString().slice(0,10); }
    function rangeFor(start, months){ const end = addDays(addMonths(start, months), -1); return {startISO:fmtISO(start), endISO:fmtISO(end)}; }

    // 4-state cycle
    const STATES = ["prefer","available","unset","no"];
    function nextState(s){ const i = STATES.indexOf(s); return STATES[(i+1) % STATES.length]; }
    function stateLabel(s){
      return s==="prefer"?"Prefer":s==="available"?"Available":s==="no"?"Do Not":"If needed";
    }

    let users = [];
    let currentUser = null;
    let startDate = firstOfMonth(new Date());
    let monthsSpan = 2;
    let autoCommitTimer = null;

    async function loadUsers(){
      const list = await api("/api/users");
      users = list;
      const sel = document.getElementById('memberSelect');
      sel.innerHTML = "";
      for(const u of users){
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = `${u.member_no ? u.member_no+" · " : ""}${u.name}`;
        sel.appendChild(o);
      }
      if(users.length){ currentUser = users[0].id; sel.value = currentUser; }
      const st = document.getElementById('apiStatus');
      st.className = 'chip green'; st.textContent = 'Connected to Worker API';
    }

    function buildCalendar(){
      const host = document.getElementById('calendar');
      host.innerHTML = "";
      const {startISO, endISO} = rangeFor(startDate, monthsSpan);
      const title = document.createElement('div');
      title.className = "mb-2 text-sm text-gray-600";
      title.textContent = `${startISO} — ${endISO}`;
      host.appendChild(title);

      const grid = document.createElement('div'); grid.className = "grid-days"; host.appendChild(grid);
      for(let d=new Date(startDate); d<=addDays(addMonths(startDate, monthsSpan), -1); d=addDays(d,1)){
        const iso = fmtISO(d);

        const card = document.createElement('div'); card.className="daycard"; card.dataset.date=iso;

        const head = document.createElement('div'); head.className="text-sm font-medium";
        head.textContent = d.toDateString().slice(0,10) + "  " + iso;
        card.appendChild(head);

        // AM
        card.appendChild(buildHalfRow("AM", iso));

        // PM
        card.appendChild(buildHalfRow("PM", iso));

        const note = document.createElement('input');
        note.type = "text"; note.placeholder = "In at 10am";
        note.className = "mt-2 w-full border rounded px-2 py-1 text-sm";
        note.dataset.date = iso;
        note.addEventListener('change', () => commitNote(iso, note.value));
        card.appendChild(note);

        grid.appendChild(card);
      }
    }

    function buildHalfRow(half, iso){
      const row = document.createElement('div'); row.className="halfrow";
      const lbl = document.createElement('div'); lbl.className="label"; lbl.textContent=half; row.appendChild(lbl);

      const btn = document.createElement('button');
      btn.className = "pill unset";
      btn.dataset.half = half;
      btn.dataset.state = "unset";
      btn.textContent = stateLabel("unset");
      btn.addEventListener('click', () => {
        clearTimeout(autoCommitTimer);
        const next = nextState(btn.dataset.state);
        btn.dataset.state = next;
        btn.className = `pill ${next}`;
        btn.textContent = stateLabel(next);
        const date = btn.closest('.daycard').dataset.date;
        autoCommitTimer = setTimeout(() => commitAvailability(date, half, next).catch(err=>showApiError(err.message)), 800);
      });
      row.appendChild(btn);
      return row;
    }

    async function hydrateAvailability(){
      if(!currentUser) return;
      const {startISO, endISO} = rangeFor(startDate, monthsSpan);
      const state = await api(`/api/state?start=${startISO}&end=${endISO}`);
      const mine = state.availability[currentUser] || {};

      for(const [date, halves] of Object.entries(mine)){
        const card = document.querySelector(`.daycard[data-date="${date}"]`);
        if(!card) continue;
        for(const [half, val] of Object.entries(halves)){
          const btn = card.querySelector(`button.pill[data-half="${half}"]`);
          if(btn){
            const v = val || "unset";
            btn.dataset.state = v;
            btn.className = `pill ${v}`;
            btn.textContent = stateLabel(v);
          }
        }
      }
    }

    async function commitAvailability(date, half, state){
      if(!currentUser) return;
      await api("/api/availability", {
        method:"POST",
        body: JSON.stringify({ userId: currentUser, date, half, state })
      });
    }
    async function commitNote(date, text){ console.log("note change", {date,text}); }

    async function doBulkApply(){
      if(!currentUser) return;
      const from = document.getElementById('bulkFrom').value;
      const to   = document.getElementById('bulkTo').value;
      const st   = document.querySelector('input[name="bulkState"]:checked')?.value || "available";
      const am   = document.getElementById('bulkAM').checked;
      const pm   = document.getElementById('bulkPM').checked;
      if(!from || !to || (!am && !pm)) return;

      for(let d=new Date(from); d<=new Date(to); d=addDays(d,1)){
        const iso = fmtISO(d);
        if(am) await commitAvailability(iso,"AM",st);
        if(pm) await commitAvailability(iso,"PM",st);
      }
      await hydrateAvailability();
    }

    // Wire up
    document.getElementById('prevBtn').addEventListener('click', async ()=>{ startDate = addMonths(startDate, -monthsSpan); buildCalendar(); try{ await hydrateAvailability(); }catch(e){ showApiError(e.message); } });
    document.getElementById('nextBtn').addEventListener('click', async ()=>{ startDate = addMonths(startDate,  monthsSpan); buildCalendar(); try{ await hydrateAvailability(); }catch(e){ showApiError(e.message); } });
    document.getElementById('monthsSel').addEventListener('change', async (e)=>{ monthsSpan = parseInt(e.target.value,10)||2; buildCalendar(); try{ await hydrateAvailability(); }catch(e){ showApiError(e.message); } });
    document.getElementById('memberSelect').addEventListener('change', async (e)=>{ currentUser = e.target.value; try{ await hydrateAvailability(); }catch(e){ showApiError(e.message); } });
    document.getElementById('bulkApply').addEventListener('click', ()=>{ doBulkApply().catch(e=>showApiError(e.message)); });

    (async function init(){
      try{
        await loadUsers();
        buildCalendar();
        await hydrateAvailability();
      }catch(e){ showApiError(e.message); }
    })();
  </script>
</body>
</html>
