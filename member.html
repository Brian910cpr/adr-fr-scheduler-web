<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander · Member</title>
<style>
  :root{
    --bg:#0f141a; --panel:#171e26; --muted:#222b36; --ring:#273245;
    --text:#e6eef7; --sub:#9fb3c8; --ok:#14b86a; --warn:#ffcc00; --bad:#e24a4a;
    --prefer:#1d7a3d; --avail:#0e5faf; --unset:#3a4758; --no:#7a1d1d;
    --chip:#223041; --chip-border:#2e3d53;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text)}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .toprow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .tabs a{display:inline-block;padding:6px 10px;border-radius:10px;background:var(--panel);opacity:.9}
  .tabs a.active{outline:1px solid var(--ring)}
  .spacer{flex:1}
  .sel,select,button{background:var(--panel);color:var(--text);border:1px solid var(--ring);border-radius:10px;padding:6px 10px}
  .navbtn{width:28px;height:28px;display:inline-grid;place-items:center;border-radius:8px}
  .title{font-weight:600;margin:0 6px}
  .sub{color:var(--sub);font-size:.85rem}
  .grid{margin-top:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{padding:4px 0;color:var(--sub);text-align:center;font-size:.9rem}
  .card{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;min-height:92px}
  .date{font-weight:600;color:var(--sub);font-size:.9rem}
  .row{display:grid;grid-template-columns:1fr;gap:6px}
  .label{font-size:.8rem;color:var(--sub)}
  .toggle{width:100%;border-radius:999px;border:1px solid var(--chip-border);background:var(--chip);padding:7px 10px;text-align:center;cursor:pointer;user-select:none}
  .s-prefer{background:var(--prefer)}
  .s-available{background:var(--avail)}
  .s-unset{background:var(--unset)}
  .s-no{background:var(--no)}
  .note{width:100%;border-radius:9px;border:1px solid var(--ring);background:var(--muted);padding:6px 8px;color:var(--text)}
  .foot{margin-top:14px;background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipbtn{background:var(--chip);border:1px solid var(--chip-border);border-radius:999px;padding:6px 10px;cursor:pointer}
  .muted{color:var(--sub)}
  .debug{margin-top:10px;background:#0d1116;border:1px dashed #2a3444;border-radius:10px;padding:8px;color:#8aa1ba;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:.85rem;white-space:pre-wrap}
  @media (max-width:820px){.wrap{padding:10px}.grid{gap:8px}}
  @media (max-width:680px){
    .grid{grid-template-columns:repeat(7,1fr);gap:6px}
    .card{padding:6px;min-height:84px}
    .note{font-size:.85rem;padding:5px 6px}
  }
  @media (max-width:560px){
    .grid{grid-template-columns:repeat(7,1fr)}
    .date{font-size:.8rem}
    .toggle{padding:6px 8px;font-size:.9rem}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toprow">
    <div class="tabs">
      <a class="active" href="member.html">Member</a>
      <a href="supervisor.html">Supervisor</a>
      <a href="wallboard.html">Wallboard</a>
    </div>
    <div class="spacer"></div>

    <label class="sub" for="memberSel">Member</label>
    <select id="memberSel" class="sel"></select>

    <button id="prev" class="navbtn" title="Previous month">◀</button>
    <div id="monthTitle" class="title">Month YYYY</div>
    <button id="next" class="navbtn" title="Next month">▶</button>
  </div>

  <div id="dowrow" class="grid" style="margin-top:6px">
    <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div>
    <div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
  </div>

  <div id="cal" class="grid"></div>

  <div class="foot">
    <div class="sub" style="margin-bottom:6px">Options · Quick Fill, Weekday mask, Clear tools</div>
    <div class="chips" id="bulkRow">
      <button class="chipbtn" data-fill="prefer">All → Prefer</button>
      <button class="chipbtn" data-fill="available">All → Available</button>
      <button class="chipbtn" data-fill="unset">All → Unset</button>
      <button class="chipbtn" data-fill="no">All → Do Not</button>
      <button class="chipbtn" id="clearNotes">Clear all notes</button>
      <span class="muted" style="margin-left:8px">Weekday mask (Mon=1..Sun=7):</span>
      <input id="maskInput" class="note" style="width:140px" placeholder="e.g. 1,2,3,4,5" />
      <span class="muted">AM:</span>
      <select id="maskAM" class="sel">
        <option value="leave">(leave)</option>
        <option value="prefer">Prefer</option>
        <option value="available">Available</option>
        <option value="unset">Unset</option>
        <option value="no">Do Not</option>
      </select>
      <span class="muted">PM:</span>
      <select id="maskPM" class="sel">
        <option value="leave">(leave)</option>
        <option value="prefer">Prefer</option>
        <option value="available">Available</option>
        <option value="unset">Unset</option>
        <option value="no">Do Not</option>
      </select>
      <button class="chipbtn" id="applyMask">Apply weekday mask</button>
    </div>
  </div>

  <div id="debug" class="debug">booting…</div>
</div>

<script>
(() => {
  const API = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
  // Inlined members so we don't hit /data/*.  Add/adjust as needed.
  const MEMBERS = [
    { id:"uq2w4or", code:"1003", name:"AJ" },
    { id:"u_demo1",  code:"1201", name:"Lynn" },
    { id:"u_demo2",  code:"1210", name:"Alex" }
  ];

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const dbg = (m) => { const d=$("#debug"); d.textContent += "\\n" + m; d.scrollTop=d.scrollHeight; console.log(m); };

  const memberSel = $("#memberSel");
  const monthTitle = $("#monthTitle");
  const cal = $("#cal");

  // Populate member selector
  for (const m of MEMBERS) {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.code} ${m.name}`;
    memberSel.appendChild(opt);
  }
  // default to first
  let currentUserId = localStorage.getItem("sc_user_id") || MEMBERS[0].id;
  if (!MEMBERS.some(m => m.id===currentUserId)) currentUserId = MEMBERS[0].id;
  memberSel.value = currentUserId;
  memberSel.addEventListener("change", () => {
    currentUserId = memberSel.value;
    localStorage.setItem("sc_user_id", currentUserId);
    paint();
  });

  // Month cursor
  let cursor = new Date();
  cursor.setDate(1);

  $("#prev").onclick = () => { cursor.setMonth(cursor.getMonth()-1); paint(); };
  $("#next").onclick = () => { cursor.setMonth(cursor.getMonth()+1); paint(); };

  const fmt = (d) => d.toISOString().slice(0,10);
  const ymd = (y,m,day) => new Date(Date.UTC(y,m,day));

  const order = ["prefer","available","unset","no"];
  const labels = {prefer:"Prefer", available:"Available", unset:"Unset", no:"Do Not"};

  function stateClass(s) {
    return "toggle s-" + (s || "unset");
  }

  async function api(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error("HTTP "+r.status);
    return r.json();
  }
  async function postJSON(url, obj) {
    const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(obj)});
    if (!r.ok) throw new Error("HTTP "+r.status);
    return r.json();
  }

  async function getWindow(firstDay) {
    // 6 weeks view to cover full calendar rows
    const start = new Date(firstDay);
    const end = new Date(firstDay); end.setMonth(end.getMonth()+1); end.setDate(7); // a week bleed
    const qs = `?start=${fmt(start)}&end=${fmt(end)}`;
    const data = await api(`${API}/api/state${qs}`);
    return data;
  }

  function cycle(s) {
    const i = order.indexOf(s || "unset");
    return order[(i+1) % order.length];
  }

  async function saveHalf(userId, dateStr, half, state, note) {
    const payload = { userId, date:dateStr, half, state };
    if (typeof note === "string") payload.note = note;
    const res = await postJSON(`${API}/api/availability`, payload);
    return res && res.ok;
  }

  async function paint() {
    const y = cursor.getUTCFullYear();
    const m = cursor.getUTCMonth();
    const monthName = cursor.toLocaleDateString(undefined, {month:"long", timeZone:"UTC"});
    monthTitle.textContent = `${monthName} ${y}`;

    // compute first visible (the Sunday before the 1st)
    const firstMonthDay = ymd(y,m,1);
    const offset = (firstMonthDay.getUTCDay()+7)%7; // 0=Sun
    const firstVisible = ymd(y,m,1 - offset);

    // header row already drawn; draw days
    cal.innerHTML = "";
    const data = await getWindow(firstVisible);
    dbg(`health ok: ${JSON.stringify({ok:true,version:data?.version,db:data?.db})}`);
    const avail = data?.availability || {};
    const userMap = avail[currentUserId] || {};

    for (let i=0;i<42;i++){
      const d = ymd(firstVisible.getUTCFullYear(), firstVisible.getUTCMonth(), firstVisible.getUTCDate()+i);
      const dateStr = fmt(d);
      const day = d.getUTCDate();
      const inMonth = d.getUTCMonth()===m;

      const cell = document.createElement("div");
      cell.className = "card";
      if (!inMonth) cell.style.opacity = .35;

      const head = document.createElement("div");
      head.className = "date";
      head.textContent = day;
      cell.appendChild(head);

      // AM block
      const amWrap = document.createElement("div");
      amWrap.className = "row";
      const amLabel = document.createElement("div");
      amLabel.className = "label"; amLabel.textContent = "AM";
      const amBtn = document.createElement("div");
      const amState = (userMap[dateStr]?.AM) || "unset";
      amBtn.className = stateClass(amState);
      amBtn.textContent = labels[amState];
      const amNote = document.createElement("input");
      amNote.className = "note";
      amNote.placeholder = "Optional note to supervisor.";
      amNote.value = userMap[dateStr]?.AM_note || "";
      amWrap.appendChild(amLabel); amWrap.appendChild(amBtn); amWrap.appendChild(amNote);
      cell.appendChild(amWrap);

      // PM block
      const pmWrap = document.createElement("div");
      pmWrap.className = "row";
      const pmLabel = document.createElement("div");
      pmLabel.className = "label"; pmLabel.textContent = "PM";
      const pmBtn = document.createElement("div");
      const pmState = (userMap[dateStr]?.PM) || "unset";
      pmBtn.className = stateClass(pmState);
      pmBtn.textContent = labels[pmState];
      const pmNote = document.createElement("input");
      pmNote.className = "note";
      pmNote.placeholder = "Optional note to supervisor.";
      pmNote.value = userMap[dateStr]?.PM_note || "";
      pmWrap.appendChild(pmLabel); pmWrap.appendChild(pmBtn); pmWrap.appendChild(pmNote);
      cell.appendChild(pmWrap);

      // interactions
      amBtn.onclick = async () => {
        try{
          const next = cycle(amBtn.className.split("s-")[1]);
          await saveHalf(currentUserId, dateStr, "AM", next, amNote.value.trim());
          amBtn.className = stateClass(next);
          amBtn.textContent = labels[next];
        }catch(e){ dbg("ERR save AM: "+e.message); }
      };
      pmBtn.onclick = async () => {
        try{
          const next = cycle(pmBtn.className.split("s-")[1]);
          await saveHalf(currentUserId, dateStr, "PM", next, pmNote.value.trim());
          pmBtn.className = stateClass(next);
          pmBtn.textContent = labels[next];
        }catch(e){ dbg("ERR save PM: "+e.message); }
      };
      amNote.addEventListener("change", async ()=>{
        try{ await saveHalf(currentUserId, dateStr, "AM", amBtn.className.split("s-")[1], amNote.value.trim()); }
        catch(e){ dbg("ERR note AM: "+e.message); }
      });
      pmNote.addEventListener("change", async ()=>{
        try{ await saveHalf(currentUserId, dateStr, "PM", pmBtn.className.split("s-")[1], pmNote.value.trim()); }
        catch(e){ dbg("ERR note PM: "+e.message); }
      });

      cal.appendChild(cell);
    }

    // Bulk tools
    $("#clearNotes").onclick = async () => {
      const inputs = $$(".note", cal);
      for (const n of inputs) n.value="";
      // persist clears for visible window
      const cards = $$(".card", cal);
      for (const c of cards){
        const day = c.querySelector(".date").textContent.trim();
      }
      // simple persist loop
      const cells = $$(".card", cal);
      for (let i=0;i<cells.length;i++){
        const c = cells[i];
        const idx = i; // 0..41
        const d = new Date(ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1));
        const firstMonthDay = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1);
        const offset = (firstMonthDay.getUTCDay()+7)%7;
        const firstVisible = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1-offset);
        const dateStr = fmt(ymd(firstVisible.getUTCFullYear(), firstVisible.getUTCMonth(), firstVisible.getUTCDate()+idx));
        const amBtn = c.querySelectorAll(".toggle")[0];
        const pmBtn = c.querySelectorAll(".toggle")[1];
        try{
          await saveHalf(currentUserId, dateStr, "AM", amBtn.className.split("s-")[1], "");
          await saveHalf(currentUserId, dateStr, "PM", pmBtn.className.split("s-")[1], "");
        }catch(e){ dbg("ERR clear notes: "+e.message); }
      }
    };

    $("#bulkRow").querySelectorAll("[data-fill]").forEach(btn=>{
      btn.onclick = async ()=>{
        const target = btn.getAttribute("data-fill");
        const cells = $$(".card", cal);
        for (let i=0;i<cells.length;i++){
          const c=cells[i];
          const firstMonthDay = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1);
          const offset = (firstMonthDay.getUTCDay()+7)%7;
          const firstVisible = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1-offset);
          const dateStr = fmt(ymd(firstVisible.getUTCFullYear(), firstVisible.getUTCMonth(), firstVisible.getUTCDate()+i));
          const amBtn = c.querySelectorAll(".toggle")[0];
          const pmBtn = c.querySelectorAll(".toggle")[1];
          amBtn.className = stateClass(target); amBtn.textContent = labels[target];
          pmBtn.className = stateClass(target); pmBtn.textContent = labels[target];
          try{
            await saveHalf(currentUserId, dateStr, "AM", target, c.querySelectorAll(".note")[0].value.trim());
            await saveHalf(currentUserId, dateStr, "PM", target, c.querySelectorAll(".note")[1].value.trim());
          }catch(e){ dbg("ERR bulk: "+e.message); }
        }
      };
    });

    $("#applyMask").onclick = async ()=>{
      const mask = $("#maskInput").value.split(",").map(s=>parseInt(s.trim(),10)).filter(n=>n>=1&&n<=7);
      if (!mask.length){ dbg("mask: none"); return; }
      const amPick = $("#maskAM").value;
      const pmPick = $("#maskPM").value;
      const cells = $$(".card", cal);
      for (let i=0;i<cells.length;i++){
        const cell = cells[i];
        const firstMonthDay = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1);
        const offset = (firstMonthDay.getUTCDay()+7)%7;
        const firstVisible = ymd(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1-offset);
        const d = ymd(firstVisible.getUTCFullYear(), firstVisible.getUTCMonth(), firstVisible.getUTCDate()+i);
        const weekday = ((d.getUTCDay()+6)%7)+1; // Mon=1..Sun=7
        const dateStr = fmt(d);
        const [amBtn, pmBtn] = cell.querySelectorAll(".toggle");
        const [amNote, pmNote] = cell.querySelectorAll(".note");
        if (mask.includes(weekday)){
          if (amPick!=="leave") { amBtn.className = stateClass(amPick); amBtn.textContent = labels[amPick];
            try{ await saveHalf(currentUserId, dateStr, "AM", amPick, amNote.value.trim()); }catch(e){ dbg("ERR mask AM: "+e.message); }
          }
          if (pmPick!=="leave") { pmBtn.className = stateClass(pmPick); pmBtn.textContent = labels[pmPick];
            try{ await saveHalf(currentUserId, dateStr, "PM", pmPick, pmNote.value.trim()); }catch(e){ dbg("ERR mask PM: "+e.message); }
          }
        }
      }
    };
  }

  // Initial boot / health
  (async () => {
    try{
      const h = await api(`${API}/api/health`);
      dbg(`health ${JSON.stringify(h)}`);
    }catch(e){
      dbg(`ERR health ${e.message}`);
    }
    paint();
  })();

})();
</script>
</body>
</html>
