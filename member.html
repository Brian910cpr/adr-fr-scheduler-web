<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ShiftCommander • Member</title>
<style>
  :root{
    --bg:#0c0f14; --panel:#141a22; --muted:#7e8ca0; --ink:#e8eef7; --ink-soft:#c5cfdb;
    --ring:#314056; --card:#10161d; --card2:#0f141b; --ok:#18a957; --avail:#2e86ff;
    --warn:#d9a400; --no:#d34b4b; --note:#9aa6b2;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--ring);background:linear-gradient(180deg,var(--panel),var(--card))}
  h1{margin:0;font-size:18px;font-weight:700}
  .tabs{margin-left:auto;display:flex;gap:6px}
  .tab{padding:6px 10px;border:1px solid var(--ring);border-radius:999px;background:transparent;color:var(--ink-soft);text-decoration:none}
  .tab.active{background:var(--ring);color:var(--ink)}
  .controls{display:flex;gap:10px;align-items:center;padding:10px 16px}
  select, button{background:var(--card2);color:var(--ink);border:1px solid var(--ring);border-radius:8px;padding:6px 10px}
  button.icon{padding:6px 8px}
  .cal-wrap{padding:8px 16px}
  .cal{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:10px}
  .cal-head{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 10px 4px}
  .month-title{font-weight:700}
  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:0 4px 8px 4px;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .day{position:relative;background:var(--card);border:1px dashed #2b394b;border-radius:12px;min-height:98px;padding:8px;overflow:hidden}
  .day.dim{opacity:0.35}
  .dnum{position:absolute;top:6px;right:8px;font-size:12px;color:var(--muted)}
  .shifts{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:18px}
  .pill{display:flex;align-items:center;justify-content:center;height:28px;border-radius:999px;border:1px solid var(--ring);color:var(--ink-soft);cursor:pointer;user-select:none;transition:transform .05s}
  .pill:active{transform:scale(.98)}
  .AM::before,.PM::before{content:attr(data-label);font-weight:700;margin-right:6px;color:var(--ink)}
  .AM[data-label="AM"]::before{}
  .PM[data-label="PM"]::before{}
  .state-prefer{background:color-mix(in srgb, var(--ok) 18%, transparent);border-color:color-mix(in srgb, var(--ok) 55%, var(--ring));color:var(--ink)}
  .state-available{background:color-mix(in srgb, var(--avail) 16%, transparent);border-color:color-mix(in srgb, var(--avail) 55%, var(--ring));color:var(--ink)}
  .state-unset{background:transparent}
  .state-no{background:color-mix(in srgb, var(--no) 16%, transparent);border-color:color-mix(in srgb, var(--no) 55%, var(--ring));color:var(--ink)}
  .note-btn{position:absolute;left:8px;top:6px;font-size:12px;color:var(--note);background:transparent;border:0;cursor:pointer}
  .note-pop{position:absolute;inset:0;background:rgba(7,10,14,.97);border:1px solid var(--ring);border-radius:12px;padding:10px;display:none}
  .note-pop.show{display:block}
  .note-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .note-head label{display:flex;gap:6px;align-items:center;color:var(--ink-soft);font-size:12px}
  textarea{width:100%;height:56px;background:var(--card2);color:var(--ink);border:1px solid var(--ring);border-radius:8px;padding:8px;resize:vertical;min-height:56px}
  .note-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .legend{display:flex;gap:14px;align-items:center;color:var(--ink-soft);font-size:12px;padding:10px 2px}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
  .dot.prefer{background:var(--ok)}
  .dot.avail{background:var(--avail)}
  .dot.none{background:#2b394b}
  .dot.no{background:var(--no)}
  .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  .msg{color:var(--no);padding:0 16px}
</style>
</head>
<body>
  <header>
    <h1>ShiftCommander <span style="color:var(--muted);font-weight:600;margin-left:6px;">Member</span></h1>
    <nav class="tabs">
      <a class="tab active" href="member.html">Member</a>
      <a class="tab" href="supervisor.html">Supervisor</a>
      <a class="tab" href="wallboard.html">Wallboard</a>
    </nav>
  </header>

  <div class="controls">
    <label>
      Member #
      <select id="memberSelect"></select>
    </label>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="icon" id="prevBtn" aria-label="Previous month">◀</button>
      <button class="icon" id="nextBtn" aria-label="Next month">▶</button>
    </div>
  </div>

  <div class="cal-wrap">
    <div class="cal">
      <div class="cal-head">
        <div class="month-title" id="monthTitle">Month YYYY</div>
      </div>
      <div class="dow">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="legend">
        <span><span class="dot prefer"></span>Prefer</span>
        <span><span class="dot avail"></span>Available</span>
        <span><span class="dot none"></span>Unset</span>
        <span><span class="dot no"></span>Do Not</span>
      </div>
    </div>
  </div>

  <div class="msg" id="msg"></div>

<script>
(() => {
  const API = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const memberSel = document.getElementById('memberSelect');
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');
  const msg = document.getElementById('msg');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  let users = [];
  let currentUser = null;
  let anchor = new Date(); // first day shown belongs to this month
  anchor.setDate(1);

  // --- utilities
  const iso = d => d.toISOString().slice(0,10);
  const addDays = (d,n) => { const c=new Date(d); c.setDate(c.getDate()+n); return c; };
  const startOfCalendar = (d) => {
    // Monday-based start
    const day = (d.getDay()+6)%7; // 0..6 with Mon=0
    const first = new Date(d);
    first.setDate(1);
    const shift = (day === 0) ? 0 : day;
    const calStart = new Date(first);
    calStart.setDate(first.getDate() - shift);
    return calStart;
  };

  const STATES = ['unset','prefer','available','no'];
  const nextState = (s) => {
    const i = STATES.indexOf(s);
    return STATES[(i+1)%STATES.length];
  };

  const pillClassFor = (s) => {
    switch(s){
      case 'prefer': return 'pill state-prefer';
      case 'available': return 'pill state-available';
      case 'no': return 'pill state-no';
      default: return 'pill state-unset';
    }
  };

  // --- data cache for visible window
  let windowData = { availability:{}, prefs:{} };

  async function loadUsers() {
    const r = await fetch(API + '/api/users');
    if(!r.ok) throw new Error('users fetch failed');
    users = await r.json();
    memberSel.innerHTML = users.map(u => `<option value="${u.id}">${u.member_no || ''} ${u.name}</option>`).join('');
    currentUser = users[0]?.id || null;
    if(currentUser) memberSel.value = currentUser;
  }

  async function loadWindow() {
    // 6 weeks view
    const start = startOfCalendar(anchor);
    const end = addDays(start, 6*7-1);
    const qs = `?start=${iso(start)}&end=${iso(end)}`;
    const r = await fetch(API + '/api/state' + qs);
    if(!r.ok) throw new Error('state fetch failed');
    windowData = await r.json();
    render();
  }

  function render() {
    monthTitle.textContent = anchor.toLocaleString(undefined, { month:'long', year:'numeric' });

    const start = startOfCalendar(anchor);
    grid.innerHTML = '';
    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const dateISO = iso(d);
      const inMonth = d.getMonth() === anchor.getMonth();

      const dayDiv = document.createElement('div');
      dayDiv.className = 'day' + (inMonth?'':' dim');

      const dnum = document.createElement('div');
      dnum.className = 'dnum';
      dnum.textContent = d.getDate();
      dayDiv.appendChild(dnum);

      // note button (opt-in popover)
      const nb = document.createElement('button');
      nb.className = 'note-btn';
      nb.textContent = '📝';
      nb.title = 'Add a note to this date';
      dayDiv.appendChild(nb);

      // shifts
      const shifts = document.createElement('div');
      shifts.className = 'shifts';
      const sAM = makePill('AM', dateISO, 'AM');
      const sPM = makePill('PM', dateISO, 'PM');
      shifts.append(sAM, sPM);
      dayDiv.appendChild(shifts);

      // popover (stays overlay, cell size constant)
      const pop = document.createElement('div');
      pop.className = 'note-pop';
      pop.innerHTML = `
        <div class="note-head">
          <strong>Notes – ${dateISO}</strong>
          <label><input type="checkbox" id="enable-${dateISO}"> activate notes</label>
        </div>
        <textarea id="ta-${dateISO}" placeholder="Optional note for this date (kept small to avoid clutter)"></textarea>
        <div class="note-actions">
          <button data-act="close">Close</button>
          <button data-act="save">Save</button>
        </div>
      `;
      pop.addEventListener('click', async (e) => {
        const act = e.target?.dataset?.act;
        if(act === 'close'){ pop.classList.remove('show'); return; }
        if(act === 'save'){
          const enabled = pop.querySelector(`#enable-${dateISO}`).checked;
          const txt = pop.querySelector(`#ta-${dateISO}`).value.trim();
          if(!enabled){ pop.classList.remove('show'); return; }
          if(!currentUser) return;
          try{
            await fetch(API + '/api/note', {
              method:'POST',
              headers:{'content-type':'application/json'},
              body: JSON.stringify({ user_id: currentUser, date: dateISO, note: txt })
            });
            flash('Note saved.');
            pop.classList.remove('show');
          }catch{ flash('Note save failed.'); }
        }
      });
      dayDiv.appendChild(pop);

      nb.addEventListener('click', () => pop.classList.add('show'));

      grid.appendChild(dayDiv);
    }
  }

  function makePill(label, dateISO, half) {
    // current user’s state for this date/half
    const userMap = windowData.availability[currentUser] || {};
    const dayMap = userMap[dateISO] || {};
    const state = dayMap[half] || 'unset';

    const el = document.createElement('div');
    el.className = pillClassFor(state);
    el.dataset.state = state;
    el.dataset.label = label;
    el.classList.add(label); // AM/PM class
    el.setAttribute('data-label', label);
    el.textContent = ''; // label rendered via ::before

    el.addEventListener('click', async () => {
      const next = nextState(el.dataset.state);
      el.className = pillClassFor(next) + ' ' + label;
      el.dataset.state = next;
      // optimistic save
      try{
        await fetch(API + '/api/availability', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ user_id: currentUser, date: dateISO, half, state: next })
        });
      }catch{
        flash('Save failed'); // leave optimistic UI
      }
    });
    return el;
  }

  function flash(text){
    msg.textContent = text;
    clearTimeout(flash._t);
    flash._t = setTimeout(()=> msg.textContent='', 1600);
  }

  // --- events
  memberSel.addEventListener('change', async () => {
    currentUser = memberSel.value;
    await loadWindow();
  });
  prevBtn.addEventListener('click', async () => {
    anchor.setMonth(anchor.getMonth()-1);
    await loadWindow();
  });
  nextBtn.addEventListener('click', async () => {
    anchor.setMonth(anchor.getMonth()+1);
    await loadWindow();
  });

  // init
  (async () => {
    try{
      await loadUsers();
      await loadWindow();
    }catch(e){
      msg.textContent = 'API error: ' + (e?.message || e);
    }
  })();
})();
</script>
</body>
</html>
