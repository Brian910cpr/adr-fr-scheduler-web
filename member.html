<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ShiftCommander · Member</title>
<style>
  :root{
    --bg:#0c1116; --ink:#e8eef6; --muted:#99a7b5;
    --frame:#141c24; --ring:#253243; --panel:#0a1218;
    --btn:#162230; --btn-b:#223246;
    --prefer:#0f5f2d; --prefer-b:#137738; --prefer-t:#e8f7ef;
    --avail:#2f5a32; --avail-b:#3a6f3d;
    --unset:#283244; --unset-b:#39455b; --unset-t:#cbd5e1;
    --no:#782020;   --no-b:#8f2929;
  }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:16px auto;padding:0 10px}
  h1{margin:0 8px 0 0;font-size:18px}
  .tabs a{display:inline-block;margin-right:6px;padding:6px 10px;border-radius:8px;background:var(--btn);border:1px solid var(--btn-b);color:var(--ink);text-decoration:none}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .spacer{flex:1}
  .month{min-width:160px;text-align:center;font-weight:700}
  .sel,.btn,.nav{height:30px;border-radius:8px;border:1px solid var(--btn-b);background:var(--btn);color:var(--ink);padding:0 10px}
  .nav{width:30px;padding:0}
  /* calendar shell keeps 7 columns; on phones it scrolls horizontally (keeps calendar feel) */
  .cal-shell{margin-top:10px;border:1px solid var(--ring);border-radius:12px;background:var(--panel);padding:8px;overflow-x:auto}
  .dow,.grid{display:grid;grid-template-columns:repeat(7, max-content);column-gap:6px}
  .dow{margin:0 0 6px 0}
  .dow div{width:126px;text-align:center;color:var(--muted);font-size:12px}
  /* ultra compact day card: 126px wide, two rows (AM, PM) with button + note each */
  .card{width:126px;background:var(--frame);border:1px solid var(--ring);border-radius:10px;padding:6px;display:grid;grid-template-rows:auto auto auto;row-gap:6px}
  .date{font-size:12px;color:var(--muted);font-weight:700;text-align:center}
  .half{display:grid;grid-template-columns:1fr;row-gap:4px}
  .toggle{height:28px;border-radius:16px;display:flex;align-items:center;justify-content:center;
          background:#1c2633;border:1px solid #273448;font-size:12px;font-weight:700;cursor:pointer;user-select:none}
  .state-prefer{background:var(--prefer);border-color:var(--prefer-b);color:var(--prefer-t)}
  .state-available{background:var(--avail);border-color:var(--avail-b)}
  .state-unset{background:var(--unset);border-color:var(--unset-b);color:var(--unset-t)}
  .state-no{background:var(--no);border-color:var(--no-b)}
  .note{height:26px;border-radius:8px;border:1px solid var(--ring);background:#0b141a;color:var(--ink);
        padding:0 8px;font-size:12px;width:100%}
  .panel{margin-top:10px;padding:8px;background:var(--panel);border:1px dashed var(--ring);border-radius:10px}
  .btn.small{height:26px;padding:0 8px}
  .muted{color:var(--muted)}
  .console{margin-top:10px;background:#091018;border:1px dashed var(--ring);border-radius:10px;font:12px ui-monospace,Consolas,Menlo,monospace;color:#a9b8c7;padding:8px;white-space:pre-wrap}
  /* “today” hint */
  .today{box-shadow:0 0 0 2px #3a7bd933 inset}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1>ShiftCommander <span class="muted">Member</span></h1>
    <div class="tabs">
      <a href="/member.html">Member</a>
      <a href="/supervisor.html">Supervisor</a>
      <a href="/wallboard.html">Wallboard</a>
    </div>
    <div class="spacer"></div>
    <select id="memberSelect" class="sel" title="Member"></select>
    <button id="prev" class="nav" aria-label="Prev">◀</button>
    <div id="monthLabel" class="month">…</div>
    <button id="next" class="nav" aria-label="Next">▶</button>
  </div>

  <div class="cal-shell">
    <div class="dow">
      <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="panel">
    <div class="row" style="gap:6px;flex-wrap:wrap">
      <span class="muted">Quick fill:</span>
      <button class="btn small" data-bulk="prefer">All → Prefer</button>
      <button class="btn small" data-bulk="available">All → Available</button>
      <button class="btn small" data-bulk="unset">All → Unset</button>
      <button class="btn small" data-bulk="no">All → Do Not</button>
      <button class="btn small" id="clearNotes">Clear all notes</button>
      <span class="muted" style="margin-left:auto">Cycle: Prefer → Available → Unset → Do Not → …</span>
    </div>
  </div>

  <div id="console" class="console">booting…</div>
</div>

<script>
(function(){
  // ===== CONFIG =====
  const API_BASE = 'https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const CSV_FALLBACK_PATH = '/members_fixed.csv'; // id,name
  const DEFAULT_USER = 'uq2w4or';
  const stateCycle = ['prefer','available','unset','no'];

  // ===== STATE =====
  let userId = DEFAULT_USER;
  let anchor = new Date(); anchor.setDate(1); // current month
  let availability = {};
  const todayStr = new Date().toISOString().slice(0,10);

  // ===== UTIL =====
  const pad = n => (n<10?'0':'')+n;
  const fmt = d => d.toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const startOfCal = d => { const x=new Date(d); x.setDate(1); const w=(x.getDay()+6)%7; return addDays(x,-w); };
  const endOfCal   = d => { const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); const w=(x.getDay()+6)%7; return addDays(x,6-w); };
  function log(s){ const c=document.getElementById('console'); c.textContent+=(c.textContent?'\n':'')+s; c.scrollTop=c.scrollHeight; }
  const label = s => s==='prefer'?'Prefer':s==='available'?'Available':s==='no'?'Do Not':'Unset';

  // ===== API =====
  async function api(path,opts={}) {
    const res = await fetch(API_BASE+path, {headers:{'Content-Type':'application/json'}, ...opts});
    if(!res.ok) throw new Error('HTTP '+res.status+' '+path);
    return res.status===204? null : res.json();
  }
  async function getUsers() {
    // try JSON API
    try {
      const j = await api('/api/users');
      const arr = Array.isArray(j)? j : (j.users||[]);
      if (arr.length) return arr.map(u => ({id:u.id||u.user_id||u.uid, name:u.name||u.display||u.full_name||String(u.id)})).filter(x=>x.id);
    } catch(_) {}
    // try CSV fallback
    try {
      const r = await fetch(CSV_FALLBACK_PATH, {cache:'no-cache'});
      if(!r.ok) throw 0;
      const text = await r.text();
      const out = [];
      for (const line of text.split(/\r?\n/)) {
        const t = line.trim(); if(!t || t.startsWith('#') || t.toLowerCase().startsWith('id,')) continue;
        const [id,name] = t.split(','); if(id) out.push({id:id.trim(), name:(name||id).trim()});
      }
      if(out.length) return out;
    } catch(_) {}
    return [{id:DEFAULT_USER, name:'1003 AJ (fallback)'}];
  }
  async function loadWindow() {
    const start = startOfCal(anchor), end = endOfCal(anchor);
    const j = await api(`/api/state?start=${fmt(start)}&end=${fmt(end)}`);
    availability = j.availability || {};
  }
  async function saveHalf(dateStr, half, newState, note){
    const body = { userId, date:dateStr, half, state:newState };
    if (typeof note === 'string') body.note = note;
    await api('/api/availability',{ method:'POST', body: JSON.stringify(body) });
  }

  // ===== RENDER =====
  function paint(){
    document.getElementById('monthLabel').textContent =
      anchor.toLocaleString(undefined,{month:'long',year:'numeric'});
    const grid = document.getElementById('grid'); grid.innerHTML='';

    const start = startOfCal(anchor), end = endOfCal(anchor);
    for (let d=new Date(start); d<=end; d=addDays(d,1)) {
      const dateStr = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

      const card = document.createElement('div'); card.className='card';
      if (dateStr===todayStr) card.classList.add('today');

      const head = document.createElement('div'); head.className='date';
      head.textContent = d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
      card.appendChild(head);

      card.appendChild(halfBlock(dateStr,'AM'));
      card.appendChild(halfBlock(dateStr,'PM'));

      grid.appendChild(card);
    }
  }

  function halfBlock(dateStr, half){
    const wrap = document.createElement('div'); wrap.className='half';
    const tgl = document.createElement('div'); tgl.className='toggle'; tgl.dataset.date=dateStr; tgl.dataset.half=half;
    const note = document.createElement('input'); note.className='note'; note.placeholder='Optional note';

    const curState = () => (availability?.[userId]?.[dateStr]?.[half] || 'unset');
    const curNote  = () => (availability?.[userId]?.[dateStr]?.[half+'_note'] || '');

    function setLook(s){
      tgl.classList.remove('state-prefer','state-available','state-unset','state-no');
      tgl.classList.add('state-'+s); tgl.textContent = label(s);
    }
    setLook(curState()); note.value = curNote();

    tgl.addEventListener('click', async ()=>{
      const prev = curState();
      const next = stateCycle[(stateCycle.indexOf(prev)+1)%stateCycle.length];
      setLook(next);
      try{
        await saveHalf(dateStr,half,next,note.value.trim());
        availability[userId] ||= {}; availability[userId][dateStr] ||= {};
        availability[userId][dateStr][half] = next;
        log(`saved ${dateStr} ${half} = ${next}`);
      }catch(e){ setLook(prev); log('ERR save state '+e.message); }
    });

    note.addEventListener('keydown', e=>{ if(e.key==='Enter') note.blur(); });
    note.addEventListener('blur', async ()=>{
      try{
        await saveHalf(dateStr,half,curState(),note.value.trim());
        availability[userId] ||= {}; availability[userId][dateStr] ||= {};
        availability[userId][dateStr][half+'_note'] = note.value.trim();
        log(`note saved ${dateStr} ${half}`);
      }catch(e){ log('ERR save note '+e.message); }
    });

    wrap.appendChild(tgl);
    wrap.appendChild(note);
    return wrap;
  }

  // ===== BULK =====
  async function bulk(state){
    const els = document.querySelectorAll('.toggle');
    for(const el of els){
      const date = el.dataset.date, half = el.dataset.half;
      try{
        await saveHalf(date,half,state);
        availability[userId] ||= {}; availability[userId][date] ||= {};
        availability[userId][date][half] = state;
        el.className='toggle state-'+state; el.textContent=label(state);
      }catch(e){ log('ERR bulk '+e.message); }
    }
  }
  async function clearAllNotes(){
    const inputs = document.querySelectorAll('.note');
    for(const i of inputs){
      const btn = i.previousSibling;
      const date = btn.dataset.date, half = btn.dataset.half;
      const s = availability?.[userId]?.[date]?.[half] || 'unset';
      i.value='';
      try{
        await saveHalf(date,half,s,'');
        availability[userId][date][half+'_note']='';
      }catch(e){ log('ERR clear notes '+e.message); }
    }
  }

  // ===== BOOT =====
  async function boot(){
    log('booting…');
    try{ const h = await api('/api/health'); log('health '+JSON.stringify(h)); }catch(e){ log('ERR health '+e.message); }

    // members combo (API → CSV → fallback)
    const sel = document.getElementById('memberSelect'); sel.innerHTML='';
    const members = await getUsers();
    for(const m of members){
      const o=document.createElement('option'); o.value=m.id; o.textContent=m.name||m.id; sel.appendChild(o);
    }
    userId = sel.value || DEFAULT_USER;
    sel.onchange = async ()=>{ userId = sel.value; await reload(); };

    await reload();
  }
  async function reload(){
    try{ await loadWindow(); paint(); log('ready '+userId); }
    catch(e){ paint(); log('ERR load '+e.message); }
  }

  // wire controls
  document.querySelectorAll('[data-bulk]').forEach(b=> b.onclick=()=>bulk(b.dataset.bulk));
  document.getElementById('clearNotes').onclick = clearAllNotes;
  document.getElementById('prev').onclick = ()=>{ anchor.setMonth(anchor.getMonth()-1); reload(); };
  document.getElementById('next').onclick = ()=>{ anchor.setMonth(anchor.getMonth()+1); reload(); };

  boot();
})();
</script>
</body>
</html>
