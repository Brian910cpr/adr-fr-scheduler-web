<!-- member.html — REVERT: single toggle pills (AM/PM), compact, note button under shifts, Options restored -->
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShiftCommander · Member</title>
<style>
:root{
  --bg:#0d1117;--panel:#161b22;--ink:#e6edf3;--muted:#8b949e;--line:#2a2f37;
  --pill:#232933;--prefer:#0b5;--avail:#0a66ff;--no:#b33;--unset:#3a3f46;
  --accent:#1f6feb;
}
html,body{background:var(--bg);color:var(--ink);margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:20px auto;padding:0 12px}
header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
select,button,input{background:var(--panel);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px}
.cal{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.dow{color:var(--muted);font-size:12px}
.day{border:1px dashed #2b313a;border-radius:12px;padding:10px;min-height:110px;display:flex;flex-direction:column;gap:8px}
.dateNum{font-weight:800;font-size:18px}
.slotRow{display:flex;gap:8px}
.pill{min-width:56px;text-align:center;border-radius:999px;padding:10px 12px;font-weight:800;border:1px solid #2c333d;background:var(--pill);color:#cfd6df;cursor:pointer}
.pill.prefer{background:var(--prefer);color:#041a0e}
.pill.available{background:var(--avail);color:#fff}
.pill.no{background:var(--no);color:#fff}
.pill.unset{background:var(--unset);color:#c9d1d9}
.noteBtn{align-self:flex-start;border-radius:8px;padding:6px 8px;font-size:12px;color:#111;background:#fff;border-color:#ddd}
.noteBtn.empty{background:#2b313a;color:#cfd6df;border-color:#3a404a}
.legend{margin-top:10px;display:flex;gap:14px;color:var(--muted);font-size:12px}
.legend span{display:inline-flex;align-items:center;gap:6px}
.chip{width:12px;height:12px;border-radius:999px;display:inline-block}
.chip.prefer{background:var(--prefer)} .chip.available{background:var(--avail)}
.chip.unset{background:var(--unset)} .chip.no{background:var(--no)}
.optCard{margin-top:14px;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
.optRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
input[type="date"]{padding:6px 8px}
@media(max-width:820px){.day{min-height:100px}.pill{min-width:50px}.dateNum{font-size:16px}}
</style>
</head><body><div class="wrap">
  <header>
    <h2 style="margin:0">ShiftCommander <span style="color:var(--muted)">Member</span></h2>
    <label>Member # <select id="memberSel"></select></label>
    <button id="prevMonth">◀</button><div id="monthLabel" style="min-width:150px;text-align:center"></div><button id="nextMonth">▶</button>
  </header>

  <section class="cal">
    <div class="grid" id="dow"></div>
    <div class="grid" id="days"></div>
    <div class="legend">
      <span><i class="chip prefer"></i> Prefer</span>
      <span><i class="chip available"></i> Available</span>
      <span><i class="chip unset"></i> Unset</span>
      <span><i class="chip no"></i> Do Not</span>
      <span><i class="chip" style="background:#fff;border:1px solid #ddd"></i> Note present</span>
    </div>
  </section>

  <section class="optCard">
    <h3 style="margin:0 0 6px 0">Options</h3>

    <div class="optRow">
      <label><input type="checkbox" id="prefer24s"> Prefer 24s</label>
      <label><input type="checkbox" id="type3"> Type III driver approved</label>
      <label><input type="checkbox" id="inactive"> Inactive (block new scheduling)</label>
      <button id="saveFlags">Save flags</button>
    </div>

    <div class="optRow" style="border-top:1px solid var(--line);padding-top:8px">
      <b>Bulk set (date range):</b>
      <label>From <input type="date" id="bulkFrom"></label>
      <label>Until <input type="date" id="bulkUntil"></label>
      <label>Set to
        <select id="bulkState">
          <option value="available">Available</option>
          <option value="prefer">Prefer</option>
          <option value="no">Do Not</option>
          <option value="unset">Unset</option>
        </select>
      </label>
      <label>Half-days:
        <label><input type="checkbox" id="bulkAM" checked> AM</label>
        <label><input type="checkbox" id="bulkPM" checked> PM</label>
      </label>
      <button id="applyBulk">Apply</button>
    </div>

    <div class="optRow" style="border-top:1px solid var(--line);padding-top:8px">
      <b>Weekly pattern:</b>
      <label><input type="checkbox" class="wp" value="1"> Mon</label>
      <label><input type="checkbox" class="wp" value="2"> Tue</label>
      <label><input type="checkbox" class="wp" value="3"> Wed</label>
      <label><input type="checkbox" class="wp" value="4"> Thu</label>
      <label><input type="checkbox" class="wp" value="5"> Fri</label>
      <label><input type="checkbox" class="wp" value="6"> Sat</label>
      <label><input type="checkbox" class="wp" value="0"> Sun</label>
      <label style="margin-left:10px">Start <input type="date" id="wpStart"></label>
      <label>Repeat until <input type="date" id="wpEnd"></label>
      <label><input type="checkbox" id="wpAM" checked> AM</label>
      <label><input type="checkbox" id="wpPM" checked> PM</label>
      <label>Set to
        <select id="wpState">
          <option value="available">Available</option>
          <option value="prefer">Prefer</option>
          <option value="no">Do Not</option>
          <option value="unset">Unset</option>
        </select>
      </label>
      <button id="applyPattern">Apply pattern</button>
    </div>
  </section>
</div>

<script>
const API = p => `https://adr-fr-scheduler-api.brian-9ac.workers.dev${p}`;
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const S = {
  users:[], who:null,
  month:new Date(),
  cache:{}, notes:{}, // notes keyed by user:date:half
};
const fmt = d => d.toISOString().slice(0,10);
const monFirst = d => (d.getDay()+6)%7;

function monthBounds(dt){
  const first = new Date(dt.getFullYear(), dt.getMonth(), 1);
  const start = new Date(first); start.setDate(first.getDate() - monFirst(first));
  const end = new Date(start); end.setDate(start.getDate()+41);
  return {start,end};
}

function setMonthLabel(){
  $("#monthLabel").textContent = S.month.toLocaleString(undefined,{month:'long',year:'numeric'});
}

async function loadUsers(){
  S.users = await (await fetch(API('/api/users'))).json();
  const sel = $("#memberSel");
  sel.innerHTML = S.users.map(u=>`<option value="${u.id}">${u.member_no} ${u.name}</option>`).join('');
  S.who = S.users[0]?.id;
}

async function loadWindow(){
  const {start,end} = monthBounds(S.month);
  const state = await (await fetch(API(`/api/state?start=${fmt(start)}&end=${fmt(end)}`))).json();
  S.cache = state;
  await hydrateNotes();
}

async function hydrateNotes(){
  const {start,end} = monthBounds(S.month);
  const data = await (await fetch(API(`/api/notes?start=${fmt(start)}&end=${fmt(end)}`))).json().catch(()=>({notes:[]}));
  S.notes = {};
  for(const n of (data.notes||[])){
    S.notes[`${n.user_id}:${n.date}:${n.half}`] = n.note;
  }
}

function getIntent(uid, ymd, half){
  return S.cache.availability?.[uid]?.[ymd]?.[half] ?? 'unset';
}
function hasNote(uid, ymd, half){
  return !!S.notes[`${uid}:${ymd}:${half}`];
}
function nextState(cur){
  const order=['unset','available','prefer','no'];
  return order[(order.indexOf(cur)+1)%order.length];
}

async function saveIntent(uid, ymd, half, state, note=null){
  const body = { userId:uid, date:ymd, half, state };
  if (note !== null) body.note = note;
  await fetch(API('/api/availability'), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
}

function renderDow(){
  const dow = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  $("#dow").innerHTML = dow.map(s=>`<div class="dow">${s}</div>`).join('');
}

function pillClass(val){ return `pill ${val}`; }

function renderDays(){
  const {start} = monthBounds(S.month);
  const days = [];
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const ymd = fmt(d);
    const inMonth = d.getMonth() === S.month.getMonth();
    const am = getIntent(S.who, ymd, 'AM');
    const pm = getIntent(S.who, ymd, 'PM');
    const amNote = hasNote(S.who, ymd, 'AM');
    const pmNote = hasNote(S.who, ymd, 'PM');
    days.push(`
      <div class="day" data-ymd="${ymd}" style="${inMonth?'':'opacity:.4'}">
        <div class="dateNum">${d.getDate()}</div>
        <div class="slotRow">
          <button class="${pillClass(am)}" data-half="AM">AM</button>
          <button class="${pillClass(pm)}" data-half="PM">PM</button>
        </div>
        <button class="noteBtn ${ (amNote||pmNote)?'':'empty' }" data-note="1">Note to supervisor</button>
      </div>
    `);
  }
  $("#days").innerHTML = days.join('');

  // handlers
  $$("#days .pill").forEach(b=>{
    b.addEventListener('click', async (e)=>{
      const card = e.target.closest('.day'); const ymd = card.dataset.ymd; const half = e.target.dataset.half;
      const cur = getIntent(S.who, ymd, half);
      const nx = nextState(cur);
      await saveIntent(S.who, ymd, half, nx);
      // update cache quickly
      (S.cache.availability ??= {})[S.who] ??= {};
      (S.cache.availability[S.who][ymd] ??= {})[half] = nx;
      renderDays();
    });
  });

  $$("#days .noteBtn").forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const card = e.target.closest('.day'); const ymd = card.dataset.ymd;
      const curAM = S.notes[`${S.who}:${ymd}:AM`] || "";
      const curPM = S.notes[`${S.who}:${ymd}:PM`] || curAM || "";
      const text = prompt(`Note to supervisor for ${ymd}\n(ie: 'In at 10am')`, curAM || curPM);
      if (text===null) return;
      await saveIntent(S.who, ymd, 'AM', getIntent(S.who, ymd, 'AM'), text.trim());
      S.notes[`${S.who}:${ymd}:AM`] = text.trim();
      renderDays();
    });
  });
}

async function applyBulkRange(){
  const from = $("#bulkFrom").value, to = $("#bulkUntil").value;
  if (!from || !to) return alert("Pick From/Until");
  const state = $("#bulkState").value; const AM = $("#bulkAM").checked; const PM = $("#bulkPM").checked;
  let cur = new Date(from); const end = new Date(to);
  while(cur<=end){
    const ymd = fmt(cur);
    if (AM) await saveIntent(S.who, ymd, 'AM', state);
    if (PM) await saveIntent(S.who, ymd, 'PM', state);
    cur.setDate(cur.getDate()+1);
  }
  await loadWindow(); renderDays();
}

async function applyWeeklyPattern(){
  const start = $("#wpStart").value, until = $("#wpEnd").value;
  if(!start || !until) return alert("Pick start and repeat-until");
  const days = $$(".wp:checked").map(x=>Number(x.value));
  if(!days.length) return alert("Pick weekdays");
  const state = $("#wpState").value; const AM=$("#wpAM").checked; const PM=$("#wpPM").checked;
  let d = new Date(start), end = new Date(until);
  while(d<=end){
    if (days.includes(d.getDay())){
      const ymd = fmt(d);
      if (AM) await saveIntent(S.who, ymd, 'AM', state);
      if (PM) await saveIntent(S.who, ymd, 'PM', state);
    }
    d.setDate(d.getDate()+1);
  }
  await loadWindow(); renderDays();
}

async function saveFlags(){
  await fetch(API('/api/user-flags'), {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({
      userId:S.who,
      inactive: $("#inactive").checked,
      type3_driver: $("#type3").checked
    })
  });
  await fetch(API('/api/prefs'), {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ userId:S.who, prefer24s: $("#prefer24s").checked, notes:"" })
  });
  alert("Saved.");
}

async function run(){
  await loadUsers();
  setMonthLabel(); renderDow();
  await loadWindow(); renderDays();

  $("#memberSel").addEventListener('change', async e=>{
    S.who = e.target.value; await loadWindow(); renderDays();
  });
  $("#prevMonth").onclick = async()=>{ S.month.setMonth(S.month.getMonth()-1); setMonthLabel(); await loadWindow(); renderDays(); };
  $("#nextMonth").onclick = async()=>{ S.month.setMonth(S.month.getMonth()+1); setMonthLabel(); await loadWindow(); renderDays(); };

  $("#applyBulk").onclick = applyBulkRange;
  $("#applyPattern").onclick = applyWeeklyPattern;
  $("#saveFlags").onclick = saveFlags;
}
run();
</script>
</body></html>
