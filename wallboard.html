<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ShiftCommander · Wallboard</title>
  <style>
    :root{--bg:#0b0c0f;--panel:#0f1117;--ink:#e8e8ea;--muted:#a4a7ae;--line:#2a2e37;--card:#151824;--ok:#30d158;--warn:#ffd60a;--bad:#ff453a}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .head{display:flex;justify-content:space-between;align-items:center}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(7,1fr);margin-top:12px}
    .cell{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px}
    .sub{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .ok{background:var(--ok)}.warn{background:var(--warn)}.bad{background:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 style="margin:0;font-weight:800">ShiftCommander · Wallboard</h1>
      <div class="sub" id="when"></div>
    </div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>
  <script>
    const API="https://adr-fr-scheduler-api.brian-9ac.workers.dev";
    const fmt= d=>d.toISOString().slice(0,10);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x}
    const startOfMonth=d=>new Date(d.getFullYear(),d.getMonth(),1);
    const endOfMonth=d=>new Date(d.getFullYear(),d.getMonth()+1,0);
    let base=new Date();

    function names(ids, users){ return ids.map(id=>users.find(u=>u.id===id)?.name||id).join(", ") || "—" }

    async function render(){
      const start=startOfMonth(base), end=endOfMonth(base);
      document.getElementById('when').textContent = start.toLocaleString([], {month:"long", year:"numeric"});
      const [state, users] = await Promise.all([
        fetch(`${API}/api/state?start=${fmt(start)}&end=${fmt(end)}`).then(r=>r.json()),
        fetch(`${API}/api/users`).then(r=>r.json())
      ]);
      const days=[]; let c=new Date(start); c.setDate(1-c.getDay());
      const last=new Date(end); last.setDate(last.getDate()+(6-last.getDay()));
      while(c<=last){ days.push(new Date(c)); c=addDays(c,1) }

      const g=document.getElementById('grid'); g.innerHTML="";
      for(const d of days){
        const ds=fmt(d);
        const am=state.shifts?.[ds]?.AM||{assignees:[]};
        const pm=state.shifts?.[ds]?.PM||{assignees:[]};
        g.insertAdjacentHTML("beforeend",`
          <div class="cell">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>${d.toLocaleString([], {month:"short",day:"numeric"})}</div>
              <div class="sub">Nudge: Needs EMT</div>
            </div>
            <div class="row sub" style="margin-top:6px"><div class="dot ok"></div><div>AM</div><div>${names(am.assignees,users)}</div></div>
            <div class="row sub" style="margin-top:6px"><div class="dot warn"></div><div>PM</div><div>${names(pm.assignees,users)}</div></div>
          </div>
        `);
      }

      // Auto-return to current month after 20s if someone scrolled away
      setTimeout(()=>{ base=new Date(); render() }, 20000);
    }
    render();
  </script>
</body>
</html>
