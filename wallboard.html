<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander · Wallboard (Safe Render)</title>
<style>
  :root{--bg:#0b1117;--panel:#121a23;--bd:#233142;--text:#e7edf5;--muted:#8ea1b8;--slot:#172233;--nudge:#ffbe3d;--pill:#1b2431}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .btn{background:#2c394f;border:1px solid var(--bd);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .title{min-width:220px;text-align:center;font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
  .col{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:12px;min-height:220px}
  .dow{color:var(--muted)} .date{font-size:20px;font-weight:800;margin:4px 0 8px}
  .slot{background:var(--slot);border:1px dashed var(--bd);border-radius:10px;padding:10px;margin-top:10px}
  .names{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
  .name{background:var(--pill);border:1px solid var(--bd);border-radius:999px;padding:6px 10px;text-align:center}
  .nudge{margin-top:8px;background:var(--nudge);color:#000;display:inline-block;padding:4px 8px;border-radius:6px;font-weight:700}
  .panel{background:#0b121a;border:1px solid var(--bd);border-radius:12px;padding:10px;margin-top:16px}
  .debug{font:12px/1.4 ui-monospace,Consolas,monospace;color:#cfe3ff;max-height:220px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="prev" class="btn">◀</button>
    <div id="title" class="title"></div>
    <button id="next" class="btn">▶</button>
  </div>
  <div id="grid" class="grid"></div>
  <div class="panel"><strong>Debug Console</strong><div id="debug" class="debug">Booting…</div></div>
</div>

<script>
(function(){
  const API='https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const dbg=(m)=>{document.getElementById('debug').textContent+='\\n'+m}
  window.onerror=(m,s,l,c,e)=>{dbg('JS ERROR: '+m+' @'+(s||'inline')+':'+l+':'+c+'\\n'+(e&&e.stack?e.stack:''))}
  const title=document.getElementById('title'), grid=document.getElementById('grid');
  let anchor=new Date(); anchor.setHours(0,0,0,0);
  document.getElementById('prev').onclick=()=>{anchor=setDays(anchor,-7);load()}
  document.getElementById('next').onclick=()=>{anchor=setDays(anchor, 7);load()}
  function setDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
  function iso(d){const x=new Date(d);x.setHours(0,0,0,0);return x.toISOString().slice(0,10)}
  function fmt(d){return d.toLocaleDateString(undefined,{weekday:'short'})}
  function loadTitle(mon){title.textContent=`${mon.toLocaleDateString(undefined,{month:'long',day:'numeric'})} – ${setDays(mon,6).toLocaleDateString(undefined,{month:'long',day:'numeric'})}`}
  async function load(){
    try{
      const dow=(anchor.getDay()+6)%7, mon=setDays(anchor,-dow), start=iso(mon), end=iso(setDays(mon,6)); loadTitle(mon);
      dbg(`fetch ${start} → ${end}`);
      const r=await fetch(`${API}/api/state?start=${start}&end=${end}`); dbg('GET /api/state → '+r.status);
      const data=await r.json(); dbg('keys: '+Object.keys(data||{}).join(', '));
      grid.innerHTML=''; let d=new Date(mon);
      for(let i=0;i<7;i++){
        const id=iso(d), col=document.createElement('div'); col.className='col';
        col.innerHTML=`<div class="dow">${fmt(d)}</div><div class="date">${d.getDate()}</div>
          <div class="slot"><h4>AM</h4><div class="names" id="am-${id}"></div></div>
          <div class="slot"><h4>PM</h4><div class="names" id="pm-${id}"></div></div>`;
        grid.appendChild(col);
        const AM=data.shifts?.[id]?.AM||{assignees:[]}, PM=data.shifts?.[id]?.PM||{assignees:[]};
        const am=document.getElementById(`am-${id}`), pm=document.getElementById(`pm-${id}`);
        (AM.assignees||[]).slice(0,2).forEach(n=>am.appendChild(chip(n)));
        (PM.assignees||[]).slice(0,2).forEach(n=>pm.appendChild(chip(n)));
        if((AM.assignees||[]).length===0){const n=document.createElement('div');n.className='nudge';n.textContent='Needs ALS & EMT';am.parentElement.appendChild(n)}
        if((PM.assignees||[]).length===0){const n=document.createElement('div');n.className='nudge';n.textContent='Needs ALS & EMT';pm.parentElement.appendChild(n)}
        d=setDays(d,1);
      }
      dbg('paint OK.');
    }catch(e){dbg('load failed: '+e.message)}
  }
  function chip(t){const s=document.createElement('div'); s.className='name'; s.textContent=t; return s}
  // ping health so we see CORS or DNS immediately
  fetch(API+'/api/health').then(r=>{dbg('health '+r.status);return r.json()}).then(j=>dbg(JSON.stringify(j))).catch(e=>dbg('health fail '+e));
  load();
})();
</script>
</body>
</html>
