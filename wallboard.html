<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander · Wallboard</title>
<style>
  :root{
    --bg:#0b1117;--panel:#121a23;--bd:#233142;--text:#e7edf5;--muted:#8ea1b8;
    --slot:#172233;--pill:#1b2431;--nudge:#ffbe3d
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .btn{background:#2c394f;border:1px solid var(--bd);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .title{min-width:280px;text-align:center;font-weight:900;font-size:18px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
  .day{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:14px;min-height:260px;display:flex;flex-direction:column}
  .dow{color:var(--muted);font-weight:700}
  .date{font-size:26px;font-weight:900;margin:2px 0 10px}
  .slot{background:var(--slot);border:1px dashed var(--bd);border-radius:12px;padding:12px;margin-top:12px;flex:1;display:flex;flex-direction:column}
  .slot h3{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px;color:#cfe3ff}
  .names{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .name{background:var(--pill);border:1px solid var(--bd);border-radius:999px;padding:8px 12px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .nudge{margin-top:10px;background:var(--nudge);color:#000;display:inline-block;padding:6px 10px;border-radius:8px;font-weight:900}
  .panel{background:#0b121a;border:1px solid var(--bd);border-radius:12px;padding:10px;margin-top:16px}
  .debug{font:12px/1.4 ui-monospace,Consolas,monospace;color:#cfe3ff;max-height:200px;overflow:auto;white-space:pre-wrap}
  @media (max-width:1100px){ .calendar{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="prev" class="btn">◀</button>
    <div id="title" class="title"></div>
    <button id="next" class="btn">▶</button>
  </div>
  <div id="grid" class="calendar" aria-live="polite"></div>
  <div class="panel"><strong>Debug Console</strong><div id="debug" class="debug">Booting…</div></div>
</div>

<script>
(function(){
  const API='https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const dbg=(m)=>{document.getElementById('debug').textContent+='\\n'+m}
  window.onerror=(m,s,l,c,e)=>{dbg('JS ERROR: '+m+' @'+(s||'inline')+':'+l+':'+c+'\\n'+(e&&e.stack?e.stack:''))}

  const grid=document.getElementById('grid'), title=document.getElementById('title');
  let anchor=new Date(); anchor.setHours(0,0,0,0);

  document.getElementById('prev').onclick=()=>{anchor = shift(anchor,-7); load();}
  document.getElementById('next').onclick=()=>{anchor = shift(anchor, 7); load();}

  function shift(d,days){ const x=new Date(d); x.setDate(x.getDate()+days); return x }
  function iso(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10) }

  function weekRange(a){
    const dow=(a.getDay()+6)%7, mon=shift(a,-dow);
    return {start: iso(mon), end: iso(shift(mon,6)), label: `${mon.toLocaleDateString(undefined,{month:'long',day:'numeric'})} – ${shift(mon,6).toLocaleDateString(undefined,{month:'long',day:'numeric'})}`, list: [...Array(7)].map((_,i)=>shift(mon,i))};
  }

  async function load(){
    try{
      const r=weekRange(anchor);
      title.textContent=r.label;
      dbg(`fetch ${r.start} → ${r.end}`);
      const resp=await fetch(`${API}/api/state?start=${r.start}&end=${r.end}`); dbg('GET /api/state → '+resp.status);
      const data=await resp.json(); paint(r.list, data);
    }catch(e){ dbg('load failed: '+e.message) }
  }

  function paint(days,data){
    grid.innerHTML='';
    for(const d of days){
      const k=iso(d);
      const AM=data.shifts?.[k]?.AM||{assignees:[]}, PM=data.shifts?.[k]?.PM||{assignees:[]};
      const el=document.createElement('div'); el.className='day';
      el.innerHTML=`
        <div class="dow">${d.toLocaleDateString(undefined,{weekday:'short'})}</div>
        <div class="date">${d.getDate()}</div>
        <div class="slot"><h3>AM</h3><div class="names" id="am-${k}"></div></div>
        <div class="slot"><h3>PM</h3><div class="names" id="pm-${k}"></div></div>`;
      grid.appendChild(el);
      fill('am-'+k, AM.assignees);
      fill('pm-'+k, PM.assignees);
    }
    dbg('paint OK.');
  }

  function fill(id,list){
    const host=document.getElementById(id);
    (list||[]).slice(0,4).forEach(n=>{const s=document.createElement('div');s.className='name';s.textContent=n;host.appendChild(s)});
    if(!list || list.length===0){const n=document.createElement('div');n.className='nudge';n.textContent='Needs ALS & EMT';host.parentElement.appendChild(n)}
  }

  fetch(API+'/api/health').then(r=>{dbg('health '+r.status);return r.json()}).then(j=>dbg(JSON.stringify(j))).catch(e=>dbg('health fail '+e));
  load();
})();
</script>
</body>
</html>
