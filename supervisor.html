<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShiftCommander · Supervisor (Safe Render)</title>
<style>
  :root{--bg:#0f141b;--panel:#121a23;--bd:#233142;--text:#e7edf5;--muted:#8ea1b8;--slot:#151f22;--nudge:#ffbe3d}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .tabs a{color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:14px;border:1px solid var(--bd);background:var(--panel)}
  .tabs a.active{color:var(--text);border-color:#2b3a51}
  .btn{background:#2c394f;border:1px solid var(--bd);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .title{min-width:200px;text-align:center;font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:12px}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:12px;min-height:150px}
  .slot{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:8px;background:var(--slot)}
  .names{display:flex;gap:6px;flex-wrap:wrap}
  .name{background:#1b2431;border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
  .nudge{margin-top:8px;background:var(--nudge);color:#000;display:inline-block;padding:4px 8px;border-radius:6px;font-weight:700}
  .panel{background:#0b121a;border:1px solid var(--bd);border-radius:12px;padding:10px;margin-top:16px}
  .debug{font:12px/1.4 ui-monospace,Consolas,monospace;color:#cfe3ff;max-height:220px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ShiftCommander <span style="color:#8ea1b8">Supervisor</span></h1>
    <nav class="tabs">
      <a href="./member.html">Member</a>
      <a class="active" href="./supervisor.html">Supervisor</a>
      <a href="./wallboard.html">Wallboard</a>
    </nav>
  </header>

  <div style="display:flex;gap:10px;align-items:center">
    <button id="prev" class="btn">◀</button>
    <div id="title" class="title"></div>
    <button id="next" class="btn">▶</button>
    <label style="margin-left:auto"><input type="checkbox" id="monthToggle"> Month at a glance</label>
  </div>

  <div id="grid" class="grid"></div>

  <div class="panel">
    <strong>Debug Console</strong>
    <div id="debug" class="debug">Booting…</div>
  </div>
</div>

<script>
(function(){
  const API='https://adr-fr-scheduler-api.brian-9ac.workers.dev';
  const dbg = (m)=>{ document.getElementById('debug').textContent += '\\n'+m }
  window.onerror=(m,s,l,c,e)=>{ dbg('JS ERROR: '+m+' @'+(s||'inline')+':'+l+':'+c+'\\n'+(e&&e.stack?e.stack:'')) }

  const title=document.getElementById('title'), grid=document.getElementById('grid');
  let anchor=new Date(); anchor.setHours(0,0,0,0);
  document.getElementById('prev').onclick=()=>{anchor=setDays(anchor,-7);load()}
  document.getElementById('next').onclick=()=>{anchor=setDays(anchor, 7);load()}
  document.getElementById('monthToggle').onchange=load;

  function setDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x }
  function iso(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10) }

  async function load(){
    try{
      const monthMode=document.getElementById('monthToggle').checked;
      let start,end;
      if(monthMode){
        const f=new Date(anchor.getFullYear(),anchor.getMonth(),1);
        const l=new Date(anchor.getFullYear(),anchor.getMonth()+1,0);
        start=iso(f); end=iso(l);
        title.textContent=f.toLocaleDateString(undefined,{month:'long',year:'numeric'});
      }else{
        const dow=(anchor.getDay()+6)%7, mon=setDays(anchor,-dow);
        start=iso(mon); end=iso(setDays(mon,6));
        title.textContent=`${mon.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${setDays(mon,6).toLocaleDateString(undefined,{month:'short',day:'numeric'})}`;
      }
      dbg(`fetch ${start} → ${end}`);
      const r=await fetch(`${API}/api/state?start=${start}&end=${end}`); dbg('GET /api/state → '+r.status);
      const data=await r.json(); dbg('state keys: '+Object.keys(data||{}).join(', '));

      // paint
      grid.innerHTML='';
      let d=new Date(start+'T00:00:00'); const e=new Date(end+'T00:00:00');
      while(d<=e){
        const day=iso(d);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div style="font-weight:800">${d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</div>
          <div class="slot"><b>AM</b><div class="names" id="am-${day}"></div></div>
          <div class="slot"><b>PM</b><div class="names" id="pm-${day}"></div></div>`;
        grid.appendChild(card);

        const AM=data.shifts?.[day]?.AM||{assignees:[]};
        const PM=data.shifts?.[day]?.PM||{assignees:[]};
        const am=document.getElementById('am-'+day), pm=document.getElementById('pm-'+day);
        (AM.assignees||[]).slice(0,2).forEach(n=>{ const s=document.createElement('span'); s.className='name'; s.textContent=n; am.appendChild(s) });
        (PM.assignees||[]).slice(0,2).forEach(n=>{ const s=document.createElement('span'); s.className='name'; s.textContent=n; pm.appendChild(s) });
        if((AM.assignees||[]).length===0){ const n=document.createElement('div'); n.className='nudge'; n.textContent='Needs ALS & EMT'; am.parentElement.appendChild(n) }
        if((PM.assignees||[]).length===0){ const n=document.createElement('div'); n.className='nudge'; n.textContent='Needs ALS & EMT'; pm.parentElement.appendChild(n) }
        d=setDays(d,1);
      }
      dbg('paint OK.');
    }catch(e){ dbg('load failed: '+e.message) }
  }

  // quick health ping
  fetch(API+'/api/health').then(r=>{dbg('health '+r.status); return r.json()}).then(j=>dbg(JSON.stringify(j))).catch(e=>dbg('health fail '+e));
  load();
})();
</script>
</body>
</html>
