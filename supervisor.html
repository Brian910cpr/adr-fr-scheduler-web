<!-- supervisor.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ShiftCommander · Supervisor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.tailwindcss.com" rel="stylesheet">
  <style>
    .pill{border:1px solid #d1d5db;border-radius:.5rem;padding:.25rem .5rem;margin:.125rem;cursor:pointer}
    .day{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem;margin:.25rem}
    .grid-days{display:grid;grid-template-columns:repeat(auto-fill,minmax(14rem,1fr));gap:.5rem}
    .badge{padding:.15rem .4rem;border-radius:.5rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:.75rem}
    #apiError{display:none}
    .seat{border:1px dashed #d1d5db;border-radius:.5rem;padding:.25rem .5rem;margin-top:.25rem}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="text-xl font-semibold">ShiftCommander <span class="badge">Supervisor</span></div>
    <nav class="space-x-2">
      <a class="pill" href="/member.html">Member</a>
      <a class="pill" href="/wallboard.html">Wallboard</a>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-20">
    <div id="apiError" class="mb-3 p-3 rounded-md border border-red-300 bg-red-50 text-red-800 text-sm"></div>

    <section class="mb-4 flex items-center gap-2">
      <button id="prevBtn" class="pill">Prev week</button>
      <button id="nextBtn" class="pill">Next week</button>
      <div id="rangeTxt" class="ml-3 text-sm text-gray-600"></div>
    </section>

    <section id="board" class="grid-days"></section>

    <section class="mt-6 bg-white rounded-lg border p-3">
      <div class="font-medium mb-2">Roster admin</div>
      <div class="text-sm text-gray-600">Use “Inactive” to hide a member and “Type III” to mark approvals. “Reserve” stops auto-assign but lets them volunteer.</div>
      <div id="roster" class="mt-3 grid md:grid-cols-2 gap-2"></div>
    </section>
  </main>

  <script>
    const API_BASE = new URLSearchParams(location.search).get('api') || "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
    async function api(path, opts={}) {
      const res = await fetch(API_BASE + path, { headers:{ "Content-Type":"application/json" }, ...opts });
      if(!res.ok){ const t=await res.text().catch(()=>res.statusText); throw new Error(`HTTP ${res.status} ${path}: ${t}`); }
      return res.json();
    }
    function showApiError(msg){ const el=document.getElementById('apiError'); el.textContent="API error: "+msg; el.style.display='block'; }

    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtISO(d){ return d.toISOString().slice(0,10); }

    let weekStart = (d=>{ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; })(new Date());
    function paintRange(){ document.getElementById('rangeTxt').textContent = fmtISO(weekStart)+" — "+fmtISO(addDays(weekStart,6)); }

    async function loadRoster(){
      const list = await api("/api/users");
      const host = document.getElementById('roster'); host.innerHTML="";
      for(const u of list){
        const row = document.createElement('div');
        row.className="flex items-center justify-between border rounded px-2 py-1";
        row.innerHTML = `<div>${u.name} <span class="text-xs text-gray-500">(${u.role}${u.member_no? ", #"+u.member_no:""})</span></div>
          <div class="text-sm">
            <label class="mr-3"><input type="checkbox" ${u.reserve? "checked":""} data-reserve="${u.id}"> Reserve</label>
            <label class="mr-3"><input type="checkbox" ${u.type3_driver? "checked":""} data-type3="${u.id}"> Type III</label>
            <label><input type="checkbox" ${u.inactive? "checked":""} data-inactive="${u.id}"> Inactive</label>
          </div>`;
        host.appendChild(row);
      }
      host.addEventListener('change', async (e)=>{
        const t=e.target;
        try{
          if(t.dataset.reserve){ await api("/api/user/flag",{method:"POST",body:JSON.stringify({userId:t.dataset.reserve,flag:"reserve",value:t.checked})}); }
          if(t.dataset.type3){ await api("/api/user/flag",{method:"POST",body:JSON.stringify({userId:t.dataset.type3,flag:"type3_driver",value:t.checked})}); }
          if(t.dataset.inactive){ await api("/api/user/flag",{method:"POST",body:JSON.stringify({userId:t.dataset.inactive,flag:"inactive",value:t.checked})}); }
        }catch(err){ showApiError(err.message); }
      });
    }

    async function loadWeek(){
      const startISO = fmtISO(weekStart);
      const endISO = fmtISO(addDays(weekStart,6));
      const state = await api(`/api/state?start=${startISO}&end=${endISO}`);
      const host = document.getElementById('board'); host.innerHTML="";

      for (let i=0;i<7;i++){
        const d = addDays(weekStart,i);
        const iso = fmtISO(d);
        const day = document.createElement('div');
        day.className="day bg-white";
        const s = (state.shifts[iso]||{});
        const AM = s.AM || {assignees:[],status:"unassigned"};
        const PM = s.PM || {assignees:[],status:"unassigned"};

        day.innerHTML = `
          <div class="font-medium mb-1">${d.toDateString().slice(0,10)} • ${iso}</div>
          <div class="seat"><div class="text-xs text-gray-500">AM • ${AM.status}</div><div>${(AM.assignees||[]).join(", ")||"—"}</div></div>
          <div class="seat"><div class="text-xs text-gray-500">PM • ${PM.status}</div><div>${(PM.assignees||[]).join(", ")||"—"}</div></div>
        `;
        host.appendChild(day);
      }
    }

    document.getElementById('prevBtn').addEventListener('click', async ()=>{ weekStart = addDays(weekStart,-7); paintRange(); try{ await loadWeek(); }catch(e){ showApiError(e.message); } });
    document.getElementById('nextBtn').addEventListener('click', async ()=>{ weekStart = addDays(weekStart,7); paintRange(); try{ await loadWeek(); }catch(e){ showApiError(e.message); } });

    (async function init(){
      try{
        paintRange();
        await loadRoster();
        await loadWeek();
      }catch(e){ showApiError(e.message); }
    })();
  </script>
</body>
</html>
