<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ShiftCommander — Supervisor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-5">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="text-lg font-semibold">ShiftCommander</div>
        <div class="text-xs px-2 py-0.5 rounded bg-slate-200">Supervisor</div>
      </div>
      <nav class="flex items-center gap-2">
        <a href="./member.html" class="px-3 py-1 rounded border text-sm">Member</a>
        <a href="./supervisor.html" class="px-3 py-1 rounded bg-slate-900 text-white text-sm">Supervisor</a>
        <a href="./wallboard.html" class="px-3 py-1 rounded border text-sm">Wallboard</a>
      </nav>
    </div>

    <div class="flex items-center justify-between mb-3">
      <div class="text-sm">Week board (starting <span id="wkStart"></span>)</div>
      <div class="flex items-center gap-2">
        <button id="prev" class="px-3 py-1 rounded-lg border text-sm">Prev week</button>
        <button id="next" class="px-3 py-1 rounded-lg border text-sm">Next week</button>
      </div>
    </div>

    <div id="board" class="grid md:grid-cols-2 gap-4"></div>

    <div class="mt-6 border rounded-2xl bg-white p-4 shadow-sm">
      <div class="font-semibold mb-2">Roster admin</div>
      <div id="roster" class="space-y-2"></div>
      <div class="text-[11px] text-slate-500 mt-2">Use “Inactive” to hide a member and “Type III” to mark approvals. “Reserve” stops auto-assign but lets them volunteer; many systems reward reserves with a small fairness nudge.</div>
    </div>
  </div>

<script>
const BASE = "https://adr-fr-scheduler-api.brian-9ac.workers.dev";
let members=[], memberById={}, state=null, weekStart=startOfWeek(new Date());

init();

async function init(){
  members = await j(BASE+"/api/users"); members.forEach(m=>memberById[m.id]=m);
  await refresh();
  g("prev").onclick=()=>{ weekStart=addDays(weekStart,-7); refresh(); }
  g("next").onclick=()=>{ weekStart=addDays(weekStart, 7); refresh(); }
}

async function refresh(){
  const start = toISO(weekStart);
  const end = toISO(addDays(weekStart, 13)); // 2 weeks window for context
  state = await j(`${BASE}/api/state?start=${start}&end=${end}`);

  g("wkStart").textContent = toISO(weekStart);
  renderBoard();
  renderRoster();
}

function renderBoard(){
  const board=g("board"); board.innerHTML="";
  for(let i=0;i<7;i++){
    const d=addDays(weekStart,i), key=toISO(d);
    const card=div("border rounded-2xl p-3 bg-white shadow-sm");
      card.appendChild(div("text-sm font-semibold mb-2", d.toLocaleDateString(undefined,{weekday:"short",month:"short",day:"numeric"})));
      ["AM","PM"].forEach(half=>{
        const wrap=div("mb-3");
          wrap.appendChild(div("text-xs font-medium mb-1", half));
          const row=div("grid grid-cols-2 gap-2 items-center");
            const s1=input("seat"), s2=input("seat");
            const shift=state.shifts[key]?.[half];
            const ids=shift?.assignees || [];
            s1.value=memberById[ids[0]]?.name || "";
            s2.value=memberById[ids[1]]?.name || "";

            const lockLbl=div("text-xs inline-flex items-center gap-2");
              const lock=document.createElement("input"); lock.type="checkbox";
              lock.checked = (shift?.status==="approved");
              lock.onchange=()=>post("/api/shift/status",{date:key,half,status:lock.checked?"approved":"proposed"});
              lockLbl.append("Lock "); lockLbl.prepend(lock);

            s1.onblur=()=>seat(0,s1.value,key,half);
            s2.onblur=()=>seat(1,s2.value,key,half);

          row.append(s1,s2,lockLbl);
        wrap.appendChild(row);
      card.appendChild(wrap);
      });
    board.appendChild(card);
  }
}

function renderRoster(){
  const box=g("roster"); box.innerHTML="";
  members.forEach(m=>{
    const row=div("flex items-center gap-3 text-sm bg-slate-50 border rounded px-2 py-1");
    const dot=div("h-2 w-2 rounded-full "+(m.inactive?"bg-slate-300":"bg-emerald-500"));
    const name=div("", m.name+" — "+m.role);
    const cRes = cb(m.reserve, e=>flags(m.id,{reserve:e.target.checked?1:0}));
    const cT3  = cb(m.type3_driver, e=>flags(m.id,{type3:e.target.checked?1:0}));
    const cIn  = cb(m.inactive, e=>flags(m.id,{inactive:e.target.checked?1:0}));
    row.append(dot,name, labelBox("Reserve",cRes), labelBox("Type III",cT3), labelBox("Inactive",cIn));
    box.appendChild(row);
  });
}

/* actions */
async function seat(idx,name,date,half){
  const m = members.find(x=>x.name.toLowerCase()===name.trim().toLowerCase());
  if(!m) return; // silently ignore typos
  await post("/api/shift/assign",{date,half,userId:m.id,seat:idx});
  refresh();
}
async function flags(userId, patch){
  await post("/api/user/flags", {userId, ...patch});
  refresh();
}

/* utils */
function g(id){return document.getElementById(id)}
function j(u,o){return fetch(u,o).then(r=>{if(!r.ok)throw new Error();return r.json()})}
function post(p,b){return j(BASE+p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})}
function div(c,t){const n=document.createElement("div"); if(c)n.className=c; if(t!=null)n.textContent=t; return n}
function cb(v,fn){const i=document.createElement("input"); i.type="checkbox"; i.checked=!!v; i.onchange=fn; return i}
function labelBox(t,el){const n=div("flex items-center gap-2 ml-2"); n.append(el, div("",t)); return n}
function input(cls){const i=document.createElement("input"); i.className="w-full border rounded px-2 py-1 text-sm "+(cls||""); return i}
function toISO(d){return d.toISOString().slice(0,10)}
function startOfWeek(d){const k=(d.getDay()+6)%7;const x=new Date(d);x.setDate(d.getDate()-k);x.setHours(0,0,0,0);return x}
function addDays(d,n){const x=new Date(d);x.setDate(d.getDate()+n);return x}
</script>
</body>
</html>
