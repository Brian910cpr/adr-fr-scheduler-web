<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ADR-FR | Supervisor Dashboard</title>
<style>
  :root{--bg:#0b1220;--card:#111a2e;--ink:#e9eefc;--muted:#9fb0d3;--ok:#16a34a;--prefer:#0ea5e9;--no:#ef4444;--unset:#334155;--accent:#7c3aed}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22314f}
  h1{font:600 16px;margin:0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input,button{background:#0e172a;border:1px solid #24324d;color:var(--ink);padding:8px 10px;border-radius:8px}
  button.primary{background:var(--accent);border-color:transparent}
  main{padding:16px;max-width:1200px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .twocol{grid-template-columns:2fr 1fr}
  .card{background:var(--card);border:1px solid #22314f;border-radius:12px;padding:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #23314f;padding:8px;text-align:left}
  th{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0e172a;border:1px solid #2a3a5f}
  .prefer{background:var(--prefer);border-color:transparent}
  .available{background:var(--ok);border-color:transparent}
  .no{background:var(--no);border-color:transparent}
  .unset{background:#334155}
</style>
</head>
<body>
<header>
  <h1>Supervisor</h1>
  <div class="row">
    <label>Start <input type="date" id="start"></label>
    <label>End <input type="date" id="end"></label>
    <button class="primary" id="load">Load</button>
  </div>
</header>
<main class="grid twocol">
  <section class="card">
    <h3 style="margin:0 0 8px 0">Coverage & nudges</h3>
    <table id="coverage">
      <thead>
        <tr>
          <th>Date</th><th>AM</th><th>PM</th><th>Nudge</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <section class="card">
    <h3 style="margin:0 0 8px 0">Notes to supervisor</h3>
    <table id="notes">
      <thead><tr><th>Date</th><th>Half</th><th>User</th><th>Note</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
const API='https://adr-fr-scheduler-api.brian-9ac.workers.dev';
const fmt=(d)=> d.toISOString().slice(0,10);
function addDays(dt,n){ const d=new Date(dt); d.setDate(d.getDate()+n); return d; }

async function getUsers(){ const r=await fetch(`${API}/api/users`); return r.json(); }
async function getState(a,b){ const r=await fetch(`${API}/api/state?start=${a}&end=${b}`); return r.json(); }

function pill(txt,cls){ const span=document.createElement('span'); span.className=`pill ${cls||''}`; span.textContent=txt; return span; }

function renderCoverage(data, users){
  const tb=document.querySelector('#coverage tbody'); tb.innerHTML='';
  const shifts=data.shifts||{};
  const keys=Object.keys(shifts).sort();
  for(const ymd of keys){
    const AM=shifts[ymd]?.AM || {assignees:[],status:'unassigned'};
    const PM=shifts[ymd]?.PM || {assignees:[],status:'unassigned'};
    const nud = ( (AM.assignees.length+PM.assignees.length)===0 ) ? 'Need ALS & EMT' : '';
    const tr=document.createElement('tr');
    const dateCell=document.createElement('td'); dateCell.textContent=new Date(ymd).toLocaleDateString();
    const amCell=document.createElement('td'); amCell.appendChild(pill(`${AM.assignees.length} assigned`, AM.assignees.length? 'available':'unset'));
    const pmCell=document.createElement('td'); pmCell.appendChild(pill(`${PM.assignees.length} assigned`, PM.assignees.length? 'available':'unset'));
    const nu=document.createElement('td'); nu.textContent=nud;
    tr.append(dateCell,amCell,pmCell,nu);
    tb.appendChild(tr);
  }
}

function renderNotes(data, users){
  const tb=document.querySelector('#notes tbody'); tb.innerHTML='';
  const notes = data.notes || {}; // expect data.notes[date][half] = [{userId,note,updated_at}]
  const byId = Object.fromEntries(users.map(u=>[u.id,u]));
  for(const ymd of Object.keys(notes).sort()){
    for(const half of Object.keys(notes[ymd])){
      for(const item of notes[ymd][half]){
        if(!item.note) continue;
        const tr=document.createElement('tr');
        const d=document.createElement('td'); d.textContent=new Date(ymd).toLocaleDateString();
        const h=document.createElement('td'); h.textContent=half;
        const u=document.createElement('td'); u.textContent= byId[item.userId]?.name || item.userId;
        const n=document.createElement('td'); n.textContent=item.note;
        tr.append(d,h,u,n);
        tb.appendChild(tr);
      }
    }
  }
}

async function load(){
  const s=document.getElementById('start').value || fmt(new Date());
  const e=document.getElementById('end').value || fmt(addDays(new Date(),27));
  const [users, data] = await Promise.all([getUsers(), getState(s,e)]);
  renderCoverage(data, users);
  renderNotes(data, users);
}

(function init(){
  const today=fmt(new Date());
  document.getElementById('start').value=today;
  document.getElementById('end').value=fmt(addDays(new Date(),27));
  document.getElementById('load').addEventListener('click', load);
  load().catch(e=>{console.error(e); alert('Failed to load');});
})();
</script>
</body>
</html>
