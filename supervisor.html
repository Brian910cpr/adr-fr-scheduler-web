<!doctype html><html><head><meta charset="utf-8"><title>ShiftCommander â€” Supervisor</title>
<style>body{font-family:system-ui;background:#f6f7f9;margin:0} .wrap{max-width:1000px;margin:20px auto}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:12px 0}
table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #eee;padding:8px;text-align:left} .btn{padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
</style></head><body><div class="wrap">
<h2>Supervisor</h2>

<div class="card">
  <h3>Members</h3>
  <table id="roster"><thead><tr><th>Name</th><th>Role</th><th>Member#</th><th>TypeIII</th><th>Inactive</th><th>Avoid (comma names)</th><th></th></tr></thead><tbody></tbody></table>
</div>

<div class="card">
  <h3>Swap requests</h3>
  <table id="swaps"><thead><tr><th>Date</th><th>Half</th><th>From</th><th>To</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
</div>

<script>
const API="https://adr-fr-scheduler-api.brian-9ac.workers.dev";
let roster=[];
(async function boot(){
  roster = await (await fetch(API+"/api/users")).json();
  const tb = document.querySelector("#roster tbody");
  tb.innerHTML = roster.map(u=>`
    <tr data-id="${u.id}">
      <td>${u.name}</td><td>${u.role}</td><td>${u.member_no||""}</td>
      <td><input type="checkbox" class="typeIII" ${u.typeIII?'checked':''}></td>
      <td><input type="checkbox" class="inactive" ${u.inactive?'checked':''}></td>
      <td><input type="text" class="avoid" value="${(u.avoid||[]).map(idToName).join(', ')}"></td>
      <td><button class="btn save">Save</button></td>
    </tr>`).join('');
  tb.querySelectorAll('.save').forEach(btn=>btn.onclick=saveRow);

  await loadSwaps();
})();
function idToName(id){ const x=roster.find(r=>r.id===id); return x?x.name:id; }
function nameToId(name){ const x=roster.find(r=>r.name.toLowerCase()===name.trim().toLowerCase()); return x?x.id:null; }

async function saveRow(e){
  const tr = e.target.closest('tr'); const id = tr.dataset.id;
  const typeIII = tr.querySelector('.typeIII').checked;
  const inactive = tr.querySelector('.inactive').checked;
  const avoidNames = tr.querySelector('.avoid').value.split(',').map(s=>s.trim()).filter(Boolean);
  const avoid = avoidNames.map(nameToId).filter(Boolean);
  await fetch(API+"/api/profile",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:id,typeIII,inactive,avoid})});
  alert("Saved.");
}

async function loadSwaps(){
  const swaps = await (await fetch(API+"/api/swaps")).json();
  const tb = document.querySelector("#swaps tbody");
  tb.innerHTML = swaps.map(s=>`
    <tr data-id="${s.id}">
      <td>${s.date}</td><td>${s.half}</td>
      <td>${idToName(s.from_user)||s.from_user}</td>
      <td>${s.to_user? (idToName(s.to_user)||s.to_user) : '-'}</td>
      <td>${s.status}</td>
      <td>
        ${s.status==='requested'
          ? `<button class="btn approve">Approve</button> <button class="btn deny">Deny</button>`
          : ``}
      </td>
    </tr>`).join('');
  tb.querySelectorAll('.approve').forEach(b=>b.onclick=()=>decide(b,true));
  tb.querySelectorAll('.deny').forEach(b=>b.onclick=()=>decide(b,false));
}
async function decide(btn, ok){
  const id = btn.closest('tr').dataset.id;
  await fetch(API+"/api/swap/approve",{method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ id, approve: ok })});
  await loadSwaps();
}
</script>
</div></body></html>
